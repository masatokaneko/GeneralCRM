# 自動化（Validation / Workflow / Approval）詳細仕様書 v1

## 0. 目的と原則

### 目的

* データ品質（入力制約）を担保しつつ、業務オペレーションを自動化する
* UI/API/バルク投入/連携のどの経路でも **同一の挙動** にする
* 実行履歴と監査を残し、再現可能にする

### 原則

* **Validationは“保存を止める”**、Workflowは“保存後に処理する”
* 自動化は **メタデータ（設定）で定義** できる（コード変更不要）
* 全ての自動化は **順序・優先度・衝突解決** を持つ
* 副作用（更新/通知/タスク生成）は **監査可能** でなければならない

---

# 1. 保存パイプライン（Execution Pipeline）— 全経路共通

## 1.1 パイプライン全体（確定順序）

任意のレコード操作（Create/Update/Delete/Undelete）に対して、以下の順序で実行する：

1. **AuthZ Gate**
   * Object/Field/Record の権限チェック（前段で拒否）
2. **Input Normalization（正規化）**
   * トリム、全角半角正規化、enum正規化、参照整合、通貨/丸めなど
3. **Before-Automation（Before Save）**
   * Before更新（派生項目、補完、デフォルト反映）
4. **Validation（入力制約）**
   * ルール評価、違反があれば保存中断（トランザクション中止）
5. **Persist（永続化）**
   * DBへ保存（楽観ロック含む）
6. **After-Automation（After Save / Sync）**
   * 同期処理（親集計更新、ステージ副作用など）
7. **Async Automation（After Save / Async）**
   * 非同期（通知、共有再計算、検索インデックス更新、ジョブ投入）
8. **Audit Finalize**
   * イベントログ・フィールド履歴・実行ログを確定

> **重要要件**：UI/API/バルク投入/インポート/外部連携の全てが、このパイプラインを通ること。

---

# 2. 自動化の種類とデータモデル

## 2.1 種類（Must）

* **Validation Rule**：保存を止める（エラーを返す）
* **Workflow Rule**：条件に応じてアクション（更新/通知/タスク/外部呼び出し）
* **Approval Process**：申請→承認→差戻し（状態機械）

## 2.2 共通メタデータ（AutomationDefinition）

| Field                      | Type        | Req | Notes             |
| -------------------------- | ----------- | --: | ----------------- |
| TenantId                   | id          |   Y |                   |
| ObjectName                 | string      |   Y | Opportunity 等     |
| ApiName                    | string      |   Y | 一意                |
| Label                      | string      |   Y | 表示名               |
| IsActive                   | bool        |   Y |                   |
| Priority                   | int         |   Y | 小さいほど先に評価（衝突解決の鍵） |
| RunAs                      | enum        |   Y | Invoker / System  |
| EffectiveFrom/To           | datetime    |   N | 任意：期間限定           |
| CreatedAt/By, UpdatedAt/By | datetime/id |   Y | 監査                |

---

# 3. 条件式（Criteria Expression）仕様

## 3.1 表現方式（実装要件）

* UIでは人間が書ける式（簡易DSL）
* 内部では **AST（抽象構文木）** として保存し、評価器で実行する

## 3.2 条件式で参照できるもの（Must）

* `Record`：対象レコードのフィールド
* `OldRecord`：更新前（Update時）
* `User`：実行ユーザ（ロール、所属、テリトリ等）
* `Now`：現在時刻
* `Changed(field)`：フィールド変更検知
* `IsNew()`：新規作成か
* `IsNull(x)` / `IsBlank(x)` / `In(x, [...])`
* 数値/日付演算、比較、論理（AND/OR/NOT）

## 3.3 禁止（Must）

* 条件式からDBの任意クエリを実行する（性能・情報漏洩リスク）
* 無制限ループ、外部I/O

## 3.4 条件式の例

* `Record.StageName = "Closed Won" AND IsBlank(Record.PrimaryQuoteId)`
* `Changed("OwnerId") AND NOT User.HasSystemPerm("TransferRecord:Opportunity")`
* `Record.Amount > 0 AND IsNull(Record.PricebookId)`

---

# 4. Validation Rule（入力制約）仕様

## 4.1 定義（ValidationRuleDefinition）

| Field                      | Type   | Req | Notes                              |
| -------------------------- | ------ | --: | ---------------------------------- |
| Base(AutomationDefinition) | -      |   Y | 共通                                 |
| ErrorMessage               | string |   Y | UI/APIに返す                          |
| ErrorFields                | json   |   N | どのフィールドに紐付けるか                      |
| ConditionAst               | json   |   Y | trueならエラー（保存不可）                    |
| Severity                   | enum   |   Y | Error/Warning（Warningは保存可にするなら要件化） |

> 本仕様では **Errorのみ必須**。Warningを入れる場合はUI/UXとAPI挙動を追加定義する。

## 4.2 実行タイミング

* パイプラインの **Validation** フェーズで全件評価
* Bulk/Importも同じ（部分成功は許すが、失敗レコードは保存されない）

## 4.3 衝突解決（複数違反時）

* すべての違反を返す（推奨）
  * `errors[]` に複数メッセージ
* ただし“最初の1件だけ”にするなら、Priority順に1件で止める（選択制）

本仕様では **全件返す** を標準とする（実装/運用が明確）。

## 4.4 コア必須Validation（Must：実装に必須）

以下はこのCRMの仕様として固定（前に定義したInvariantsを具体化）：

### VR-OPP-01：商談はAccount必須

* 条件：`IsBlank(Record.AccountId)`
* エラー：`取引先（Account）は必須です。`

### VR-OPP-02：クローズ整合

* 条件：`Record.IsWon = true AND Record.IsClosed = false`
* エラー：`Wonの商談はClosedである必要があります。`

### VR-OPP-03：Closed Lostは失注理由必須

* 条件：`Record.StageIsClosedLost() AND IsBlank(Record.LostReason)`
* エラー：`失注理由は必須です。`

### VR-LI-01：商談品目は価格表整合

* 対象：OpportunityLineItem
* 条件：`IsBlank(ParentOpportunity.PricebookId) OR PricebookEntry.PricebookId != ParentOpportunity.PricebookId`
* エラー：`商談の価格表と明細の価格表が一致しません。`

### VR-QUOTE-01：主要見積は商談内で1つ

* 対象：Quote
* 条件：`Record.IsPrimary = true AND Exists(Other Quote where OpportunityId=Record.OpportunityId AND IsPrimary=true AND Id!=Record.Id)`
* エラー：`主要見積は商談内で1つ בלבדです。`

> ※ `Exists` は “限定された参照チェック” としてシステム関数化して許可（一般クエリは禁止）。参照整合系に限り安全に提供する。

---

# 5. Workflow Rule（自動処理）仕様

## 5.1 定義（WorkflowRuleDefinition）

| Field                      | Type | Req | Notes                                |
| -------------------------- | ---- | --: | ------------------------------------ |
| Base(AutomationDefinition) | -    |   Y |                                      |
| TriggerEvent               | enum |   Y | BeforeSave/AfterSave/Async/Scheduled |
| ConditionAst               | json |   Y | trueで発火                              |
| Actions                    | json |   Y | アクション配列                              |
| StopAfterMatch             | bool |   Y | trueの場合、同Priority帯の後続を止める            |

## 5.2 アクション種類（Must）

* FieldUpdate：フィールド更新
* CreateTask：タスク作成
* SendNotification：通知（アプリ内/メール）
* InvokeWebhook：外部HTTP呼び出し（Asyncのみ推奨）
* EnqueueJob：非同期ジョブ投入
* RecalculateSharing：共有再計算要求
* ReindexSearch：検索インデックス更新要求

## 5.3 アクションの実行制約（安全策）

* BeforeSave では **同一レコードのフィールド更新のみ許可**
* AfterSave Sync では
  * 同一レコード更新は許可するが **再帰ループ防止** が必須
* Webhook/外部I/Oは Async のみ
* 共有再計算・検索更新は Async を標準

## 5.4 ループ防止（必須）

* 同一レコードに対し、同一トランザクション内での自動化の再入を制限する
* 方式：
  * (A) 実行コンテキストに `AutomationDepth`（最大N）
  * (B) 変更フィールド集合が増えない場合は停止
    本仕様では **(A) depth上限 + (B) no-change停止** を必須とする

## 5.5 衝突解決（複数Workflowが同じフィールドを更新する）

* Priority昇順で実行し、後勝ち（last-write-wins）
* ただし危険フィールド（OwnerId、StageName、IsClosed 等）は衝突禁止にしてエラーにする選択肢
  本仕様では **危険フィールドは“衝突禁止（Error）”を標準** とする：
* 衝突が起きたら `AutomationConflictError`（ログ必須）

## 5.6 コア必須Workflow（Must）

### WF-OPP-01：ステージ変更時に確度/予測カテゴリを同期

* Trigger：BeforeSave
* 条件：`Changed("StageName")`
* Action：Stage定義に従い `Probability`, `ForecastCategoryName`, `IsClosed`, `IsWon` を更新
* 監査：`OpportunityStageChanged` イベント

### WF-QUOTE-01：主要見積Acceptedで商談PrimaryQuoteIdを設定

* Trigger：AfterSave
* 条件：`Record.Object=Quote AND Record.IsPrimary=true AND Record.Status="Accepted"`
* Action：親Opportunity.PrimaryQuoteId = Record.Id（ただし既に別Primaryがある場合はValidationで止める）
* 監査：`PrimaryQuoteChanged`

### WF-SHARE-01：Owner変更時の共有再計算要求

* Trigger：Async
* 条件：`Changed("OwnerId")`
* Action：RecalculateSharing(RecordId)

---

# 6. Scheduled Automation（スケジュール）仕様

## 6.1 例：見積の期限切れ自動化（Must）

* 対象：Quote
* スケジュール：毎日 01:00
* 条件：`Status="Presented" AND ExpirationDate < Today()`
* Action：Status="Expired"、イベント `QuoteExpired`

---

# 7. Approval Process（承認）仕様

## 7.1 承認のデータモデル（実装必須）

### ApprovalProcessDefinition（メタデータ）

* ObjectName
* EntryCriteriaAst（申請可能条件）
* Stages[]（段階定義）
* FinalActions（承認後の処理）
* RejectionActions（却下後の処理）
* RecallPolicy（申請取消可否）

### ApprovalInstance（実データ）

* TargetObjectName / TargetRecordId
* Status：Draft / Submitted / Approved / Rejected / Recalled
* SubmittedAt/By
* CurrentStageIndex
* LockedFields（任意：承認中に編集禁止とするフィールド集合）

### ApprovalWorkItem（作業）

* ApprovalInstanceId
* StageIndex
* ApproverType：User/Role/Group/ManagerOfOwner 等
* ApproverId（展開後）
* Status：Pending/Approved/Rejected
* DecidedAt/By
* Comment

### ApprovalHistory（履歴）

* 追記のみ（監査）

---

## 7.2 承認の状態遷移（State Machine）

### ApprovalInstance

* Draft → Submitted → Approved
* Draft → Submitted → Rejected
* Submitted → Recalled（取消、許可される場合）

#### ガード条件

* Submittedへ：EntryCriteriaを満たす、対象レコードが承認可能状態
* Approved/Rejected：現在Stageの全WorkItemが完了、実行者がApproverである
* Recalled：申請者または特権者のみ（RecallPolicy）

---

## 7.3 承認中のロック（必須仕様）

* 承認中（Submitted）の対象レコードは、原則として
  * **危険フィールド**（金額、割引、価格表、ステージ、Ownerなど）を編集不可
* 例外：
  * Admin / ModifyAll を持つユーザ
  * 承認プロセス定義で許可されたフィールド

> これにより「承認した内容が後で変わる」を防ぐ。

---

## 7.4 承認の必須ユースケース（Must）

### AP-OPP-01：大幅値引きの承認

* 対象：Quote or OpportunityLineItem
* EntryCriteria：`Discount > X%` または `GrandTotal < Threshold`
* Approver：OwnerのManager → Finance/RevOps（段階式）
* FinalActions：承認フラグ設定、通知、監査

---

# 8. 実行ログ（Automation Run Log）— 必須

自動化がブラックボックス化するのを防ぐため、必ず実行ログを保存する。

## 8.1 AutomationRunLog

* RunId, TenantId, ObjectName, RecordId
* TriggerEvent
* FiredRules[]（発火したルール）
* ActionsExecuted[]（実行アクション）
* Result：Success/Failure/Skipped
* ErrorDetail（例外・スタックは内部、ユーザには要約）
* StartedAt/EndedAt
* CorrelationId（APIリクエスト単位で追跡）

---

# 9. API/バルク処理での挙動（必須）

* バルク投入は **レコード単位で成功/失敗** を返す
* 失敗レコードは保存されない（Validation）
* Workflow/Approval の実行は同じ（AfterSave/Asyncはジョブに積む）
* バルク時は通知を抑制する設定も用意（大量通知防止）

---

# 10. テスト仕様（自動化）

最低限の自動テスト（Must）：

1. ValidationがUI/API/Bulkで同一に働く
2. ステージ変更で確度/予測カテゴリが必ず同期される
3. 価格表整合違反で必ず保存が落ちる
4. 主要見積が2つ立てられない
5. 承認中はロックフィールドが編集不可
6. 期限切れジョブで見積がExpiredになる
7. ループ防止が効き、無限再帰しない
8. 実行ログに発火ルールと結果が残る
