# 成果物 1：ユースケース一覧＋業務フロー v1

## 1. ユースケース一覧（全体・MECE）

### UC-00 共通（横断）

* UC-00-01 ログイン・認証（AuthN）
* UC-00-02 権限評価（Object/Field/Record）
* UC-00-03 監査ログ参照（監査権限者）
* UC-00-04 検索（候補→明細）
* UC-00-05 レポート閲覧（フォルダ権限）

---

## 2. 基本マスタ／関係管理

### UC-10 Account（取引先）

* UC-10-01 取引先作成
* UC-10-02 取引先更新（基本情報、担当、ステータス）
* UC-10-03 取引先詳細閲覧（関連：Contacts/Opportunities/Activities）
* UC-10-04 取引先一覧（フィルタ・ソート・ページング）
* UC-10-05 取引先の共有（Team/Manual Share）
* UC-10-06 取引先削除（論理削除・ポリシー適用）

### UC-11 Contact（取引先責任者）

* UC-11-01 取引先責任者作成（Account紐付）
* UC-11-02 更新（役職、メール、電話等）
* UC-11-03 詳細閲覧・一覧
* UC-11-04 削除（ポリシー適用）

---

## 3. 見込み → 商談化（Lead → Convert）

### UC-20 Lead

* UC-20-01 リード作成（Web/手入力/インポート想定）
* UC-20-02 リード更新（スコア、ソース、ステータス）
* UC-20-03 リード一覧/重複確認（将来拡張）
* UC-20-04 リード共有（Owner/Queue/Sharing）
* UC-20-05 リード変換（Convert）

### UC-21 Lead Convert（変換）

* UC-21-01 Convert（既存Account/Contactに紐付 or 新規作成）
* UC-21-02 Convert時にOpportunity作成（任意・設定）
* UC-21-03 Convert結果の関連整備（履歴、参照、監査、イベント）

---

## 4. パイプライン管理（Opportunity）

### UC-30 Opportunity（商談）

* UC-30-01 商談作成（Account紐付、ステージ、期日、金額）
* UC-30-02 ステージ更新（StageChanged）
* UC-30-03 クローズ（Won/Lost、必須項目検証）
* UC-30-04 商談詳細閲覧（関連：LineItems/Quotes/Activities/ContactRoles/Team）
* UC-30-05 商談一覧（My pipeline、チーム、期間、ステージ等）
* UC-30-06 商談共有（Opportunity Team、Manual Share、Rule）
* UC-30-07 商談商品明細（OpportunityLineItem）追加/更新/削除
* UC-30-08 連絡先役割（ContactRole）追加/更新/削除

---

## 5. 見積（Quote）

### UC-40 Quote（見積）

* UC-40-01 見積作成（Opportunity紐付）
* UC-40-02 見積明細（QuoteLineItem）管理
* UC-40-03 見積ステータス遷移（Draft→Presented→Accepted/Rejected 等）
* UC-40-04 Primary Quote 指定（Opportunityに反映）
* UC-40-05 見積承認申請（Approval Submit）
* UC-40-06 承認中ロック適用（編集制限）
* UC-40-07 承認結果反映（Approved/Rejected、通知）

---

## 6. 受注（Order）

### UC-50 Order（受注）

* UC-50-01 受注作成（Quote/Opportunityから作成 or 直接作成）
* UC-50-02 受注明細（OrderItem）管理
* UC-50-03 受注ステータス遷移（Draft→Activated 等）
* UC-50-04 受注承認（必要なら）
* UC-50-05 受注の監査・変更履歴

---

## 7. 活動（Task/Event）

### UC-60 Activity

* UC-60-01 活動作成（Task/Event。関連：Account/Contact/Opportunity）
* UC-60-02 活動更新（完了、日時変更）
* UC-60-03 活動一覧（自分/チーム/対象レコード別）
* UC-60-04 活動共有（原則親レコードに従属：Controlled by Parent の扱い）

---

## 8. 製品・価格表（Product/Pricebook）

### UC-70 Product

* UC-70-01 商品作成/更新/無効化
* UC-70-02 商品一覧/検索

### UC-71 Pricebook

* UC-71-01 価格表作成/更新
* UC-71-02 価格表エントリ（PricebookEntry）作成/更新
* UC-71-03 商談/見積/受注の明細追加時に価格参照

---

## 9. 設定（Admin/Setup相当）

### UC-80 Setup（メタデータ）

* UC-80-01 オブジェクト/項目定義の管理（参照・変更は別サービス正本）
* UC-80-02 レイアウト管理（参照）
* UC-80-03 Validation Rules 管理
* UC-80-04 Workflow Rules 管理
* UC-80-05 Approval Process 管理
* UC-80-06 共有設定（OWD/Rule/Role/Group/Territory）管理

---

## 10. レポート／ダッシュボード

### UC-90 Report

* UC-90-01 レポート作成（定義）
* UC-90-02 レポート実行（同期/非同期）
* UC-90-03 ドリルダウン（候補ID→Core明細）
* UC-90-04 フォルダ権限による共有

---

# 2. 業務フロー（主要シナリオ：ステップ・ルール・イベント）

以下は実装で迷わないよう **入力→検証→権限→保存→監査→イベント** まで含めた標準フローです。

---

## Flow-1：Lead → Convert → Opportunity化（代表フロー）

### 目的

リード情報を確度の高い顧客情報へ昇格し、案件（商談）として追跡可能にする。

### 前提

* 操作者が Lead への Read/Edit と Convert 権限を持つ
* Convert時の作成先（Opportunity作成有無）は設定で決まる

### フロー

1. **Lead詳細を開く**（権限：Lead Read、RecordAccess Read）
2. **Convert開始**
3. Convert画面で選択

   * Account：新規作成 or 既存選択
   * Contact：新規作成 or 既存選択
   * Opportunity：作成する/しない（設定またはユーザ選択）
4. **Validation**

   * 必須項目（会社名、メール等）
   * 重複チェック（v1は警告まで、強制はv2）
5. **Coreトランザクション（Single Writer）**

   * 必要に応じて Account/Contact/Opportunity を作成
   * Lead を converted として更新（論理的にクローズ）
6. **監査**

   * 作成/更新ログを記録
7. **イベント発行**

   * `LeadConverted`
   * `RecordCreated(Account/Contact/Opportunity)`（作成時）
   * `RecordUpdated(Lead)`（converted反映）

### 例外

* 権限不足：404/403ルールに従い拒否
* Convert途中で競合：409（楽観ロック）

---

## Flow-2：Opportunity管理（作成→ステージ更新→クローズ）

### 目的

案件の進捗管理と予測精度向上。

### フロー（作成）

1. 商談作成（Account紐付、Stage、CloseDate、Amount 等）
2. Validation（例：CloseDate必須、Stageに応じた必須項目）
3. beforeSave Workflow（例：Probabilityの初期設定）
4. Persist
5. Audit
6. Events：`RecordCreated(Opportunity)`

### フロー（ステージ更新）

1. `ChangeStage` アクション
2. Validation（ステージ遷移許可、必須項目）
3. Persist
4. Audit
5. Events：`StageChanged` + `RecordUpdated`

### フロー（クローズ）

* Won/Lost で必須項目が変わる（LostReason等）
* クローズ後の更新可否（運用設定：原則更新可だが重要項目は承認対象にできる）

---

## Flow-3：Quote（見積）作成→承認→Primary化→Order化

### 目的

見積の統制と、受注（Order）までの整合ルートを作る。

### フロー（作成）

1. Opportunityから Quote作成
2. QuoteLineItem追加（PricebookEntry参照）
3. Validation（割引率上限など）
4. beforeSave Workflow（合計計算等は v1はアプリ側算出 + サーバ検証）
5. Persist → Audit → `RecordCreated(Quote)`

### フロー（承認申請）

1. Submit Approval
2. Approval Serviceが instance/workItem を作成し `ApprovalSubmitted` 発行
3. Coreはロック状態を参照し、lockedFieldsの編集を拒否

### フロー（承認結果）

1. Approverが承認/却下
2. `ApprovalDecided` 発行
3. Core（必要なら）Quoteステータス更新、監査、イベント発行
4. 通知は Automation Serviceへ

### フロー（Primary Quote）

* Primary指定 → Opportunityへ参照反映（同一TX内で行う or 参照のみ保持）

### フロー（Order化）

* 承認済Primary Quoteから Order作成
* OrderItem生成、監査、イベント

---

## Flow-4：Activity（Task/Event）記録

### 目的

営業活動の証跡を案件・顧客に紐づけて蓄積する。

### フロー

1. 対象レコード（Account/Opportunity等）閲覧権限チェック
2. Task/Event作成（関連ID設定）
3. Persist → Audit → `RecordCreated(Activity)`
4. 共有は親に従属（Controlled by Parent）を基本方針

---

## Flow-5：Search → 明細表示（漏洩防止）

### フロー

1. Search Serviceで候補ID取得（遅延・古い共有が混ざり得る）
2. Core `recordsByIds` で最終権限評価
3. 見えるものだけ返し、Field mask適用

---

## Flow-6：Report 実行 → ドリルダウン（漏洩防止）

### フロー

1. Reporting Serviceがレポート定義に基づき Core Queryで可視明細を取得
2. 集計し runId に保存
3. ドリルダウンは recordIds を Core `recordsByIds` に渡して明細を表示

---

# 3. 次に作る"2) トレーサビリティ表"の前提（確認事項）

このユースケース体系（UC番号）をそのままキーとして、

* **UC → 画面 → API → Coreモジュール → イベント**
  の対応表を作れます。

---

---

# 4. 業務フロー可視化（Mermaidフローチャート）

以下は実装で迷わないよう、**入力→検証→権限→保存→監査→イベント** まで含めた標準フローをMermaid形式で可視化したものです。

---

## Flow-1：Lead → Convert → Opportunity化（代表フロー）

```mermaid
flowchart TD
  %% Flow-1: Lead → Convert → (Account/Contact/Opportunity)
  %% Principle: Single Writer(Core) + Validate/Workflow/Audit/Outbox in one TX
  %% Notation: [UI] user action, (SVC) service, {Decision}, [[Data]]

  A[UI: Lead 詳細を開く] --> B(SVC: Core GET Lead)
  B --> C{権限評価 OK?\n(Object Read + Record Read)}
  C -- No --> C1[Return 404]
  C -- Yes --> D[UI: Convert 開始]

  D --> E[UI: Convert 入力\n- Account: 新規/既存\n- Contact: 新規/既存\n- Opportunity: 作成する/しない]
  E --> F(SVC: Core POST /v1/leads/{id}/convert)

  F --> G{権限評価 OK?\nLead Edit + Convert権限\n作成先Object Create}
  G -- No --> G1[Return 403/404]
  G -- Yes --> H[Core: Normalize]

  H --> I[Core: Validation Rules\n(必須/形式/業務ルール)]
  I --> J{Validation OK?}
  J -- No --> J1[Return 422\nVALIDATION_ERROR]
  J -- Yes --> K[Core: Workflow beforeSave\n(FieldUpdate only)]

  K --> L[Core TX: Persist\n1) Account upsert/create?\n2) Contact upsert/create?\n3) Opportunity create? (optional)\n4) Lead update: converted=true]
  L --> M[Core: Audit\n(field_history + audit_event)]
  M --> N[Core: Outbox Append\nLeadConverted\nRecordCreated/Updated events]
  N --> O[Commit]

  O --> P[Return 200\nConvertResult:\naccountId/contactId/opportunityId?]

  %% Async downstream (event-driven)
  N --> Q(SVC: Event Bus)
  Q --> R(SVC: Sharing Service\n(rebuild if needed))
  Q --> S(SVC: Search Service\n(index/update))
  Q --> T(SVC: Reporting Service\n(cache invalidation))
  Q --> U(SVC: Automation Service\n(notify/task/webhook))
```

---

## Flow-2：Opportunity管理（作成→ステージ更新→クローズ）

```mermaid
flowchart TD
  %% Flow-2: Opportunity lifecycle (Create → Change Stage → Close)
  %% Shared backbone: AuthZ → Normalize → Validate → Workflow(beforeSave) → Persist → Audit → Outbox

  subgraph F2A[Flow-2A: Create Opportunity]
    A1[UI: 商談作成] --> A2(SVC: Core POST /v1/sobjects/Opportunity)
    A2 --> A3{AuthZ OK?\nObject Create + Field Editable\nRecord access for Account Read}
    A3 -- No --> A4[Return 403/404]
    A3 -- Yes --> A5[Core: Normalize]
    A5 --> A6[Core: Validation Rules\n(必須: AccountId, Stage, CloseDate...)]
    A6 --> A7{Validation OK?}
    A7 -- No --> A8[Return 422]
    A7 -- Yes --> A9[Core: Workflow beforeSave\n(Probability default etc.)]
    A9 --> A10[Persist Opportunity (+ children if any)]
    A10 --> A11[Audit]
    A11 --> A12[Outbox: RecordCreated(Opportunity)]
    A12 --> A13[Commit → 201 Created]
  end

  subgraph F2B[Flow-2B: Change Stage]
    B1[UI: Stage 変更\n(Kanban/詳細)] --> B2(SVC: Core POST /v1/opportunities/{id}/changeStage)
    B2 --> B3{AuthZ OK?\nObject Edit + Record Write\nField Editable(Stage)}
    B3 -- No --> B4[Return 403/404]
    B3 -- Yes --> B5[Core: Normalize]
    B5 --> B6[Core: Validation\nStageTransitionPolicy\n(必須項目の強制)]
    B6 --> B7{OK?}
    B7 -- No --> B8[Return 422]
    B7 -- Yes --> B9[Core: Workflow beforeSave\n(必要なら補正)]
    B9 --> B10[Persist (optimistic lock)]
    B10 --> B11{Conflict?}
    B11 -- Yes --> B12[Return 409]
    B11 -- No --> B13[Audit]
    B13 --> B14[Outbox: StageChanged + RecordUpdated]
    B14 --> B15[Commit → 200]
  end

  subgraph F2C[Flow-2C: Close Opportunity Won/Lost]
    C1[UI: Close Won/Lost] --> C2(SVC: Core POST /v1/opportunities/{id}/close)
    C2 --> C3{AuthZ OK?\nObject Edit + Record Write}
    C3 -- No --> C4[Return 403/404]
    C3 -- Yes --> C5[Core: Validation\nWon/Lost 必須\n(LostReason etc.)]
    C5 --> C6{OK?}
    C6 -- No --> C7[Return 422]
    C6 -- Yes --> C8[Persist]
    C8 --> C9[Audit]
    C9 --> C10[Outbox: StageChanged + RecordUpdated]
    C10 --> C11[Commit → 200]
  end

  %% Downstream
  A12 --> Z(SVC: Event Bus)
  B14 --> Z
  C10 --> Z
  Z --> Z1(SVC: Search Index update)
  Z --> Z2(SVC: Reporting cache invalidate)
  Z --> Z3(SVC: Automation notify/task)
```

---

## Flow-3：Quote（見積）作成→承認→Primary化→Order化

```mermaid
flowchart TD
  %% Flow-3: Quote → Approval → Primary → Order
  %% Note: Approval is external service; Core enforces lock on writes.

  subgraph F3A[Flow-3A: Create Quote + Line Items]
    A1[UI: Quote 作成] --> A2(SVC: Core POST /v1/sobjects/Quote)
    A2 --> A3{AuthZ OK?\nObject Create + Record access(Opportunity Read)}
    A3 -- No --> A4[Return 403/404]
    A3 -- Yes --> A5[Validation + Workflow(beforeSave)]
    A5 --> A6[Persist Quote]
    A6 --> A7[Audit + Outbox: RecordCreated(Quote)]
    A7 --> A8[Commit]
    A8 --> A9[UI: LineItem 追加/更新]
    A9 --> A10(SVC: Core POST /v1/quotes/{id}/lineItems)
    A10 --> A11{AuthZ OK?\nQuote Edit + Record Write}
    A11 -- No --> A12[Return 403/404]
    A11 -- Yes --> A13[Validate (pricebook consistency, etc.)]
    A13 --> A14[Persist + Audit + Outbox: RecordUpdated(Quote)]
    A14 --> A15[Commit]
  end

  subgraph F3B[Flow-3B: Submit Approval (Quote)]
    B1[UI: 承認申請] --> B2(SVC: Approval POST /v1/approvals/submit)
    B2 --> B3[Approval: create instance/workItems]
    B3 --> B4[Event: ApprovalSubmitted]
    B4 --> B5(SVC: Core reads lockState via ApprovalStateReader)
  end

  subgraph F3C[Flow-3C: Edit during Approval (Lock Enforcement)]
    C1[UI: Quote 編集] --> C2(SVC: Core PATCH /v1/sobjects/Quote/{id})
    C2 --> C3{AuthZ OK?\nObject Edit + Record Write}
    C3 -- No --> C4[Return 403/404]
    C3 -- Yes --> C5{Approval Lock?\nlockedFields affected?}
    C5 -- Yes --> C6[Return 422/403\nFIELD_LOCKED/RECORD_LOCKED]
    C5 -- No --> C7[Proceed SavePipeline\nValidate/Workflow/Persist/Audit/Outbox]
  end

  subgraph F3D[Flow-3D: Approval Decision]
    D1[Approver: 承認/却下] --> D2(SVC: Approval POST /v1/approvals/decide)
    D2 --> D3[Event: ApprovalDecided]
    D3 --> D4{Policy: Core updates Quote status?}
    D4 -- Yes --> D5(SVC: Core POST /v1/quotes/{id}/applyApprovalDecision)
    D5 --> D6[Persist + Audit + Outbox: RecordUpdated(Quote)]
    D6 --> D7[Commit]
    D4 -- No --> D8[No Core write]
  end

  subgraph F3E[Flow-3E: Set Primary Quote + Create Order]
    E1[UI: Primary Quote 指定] --> E2(SVC: Core POST /v1/opportunities/{id}/setPrimaryQuote)
    E2 --> E3[Persist + Audit + Outbox: RecordUpdated(Opportunity)]
    E3 --> E4[Commit]
    E4 --> E5[UI: Order 作成]
    E5 --> E6(SVC: Core POST /v1/sobjects/Order\n(fromQuote or fromOpp))
    E6 --> E7[Validate + Persist Order/Items]
    E7 --> E8[Audit + Outbox: RecordCreated(Order)]
    E8 --> E9[Commit]
  end
```

---

## Flow-4：Activity（Task/Event）記録

```mermaid
flowchart TD
  %% Flow-4: Activity (Task/Event) creation and linkage

  A[UI: 対象(Acc/Cont/Opp)から活動作成] --> B(SVC: Core GET target)
  B --> C{権限 OK?\nTarget Record Read}
  C -- No --> C1[Return 404]
  C -- Yes --> D[UI: Task/Event 入力\nsubject, due, attendees...]

  D --> E(SVC: Core POST /v1/sobjects/Task or /Event)
  E --> F{AuthZ OK?\nObject Create + Field Editable}
  F -- No --> F1[Return 403/404]
  F -- Yes --> G[Core: Validate\n(関連IDの整合)]
  G --> H[Persist Activity]
  H --> I[Audit + Outbox: RecordCreated(Activity)]
  I --> J[Commit → 201]
```

---

## Flow-5：Search → 明細表示（漏洩防止）

```mermaid
flowchart TD
  %% Flow-5: Search (candidate IDs → Core final re-check)
  %% Goal: no data leakage even if search index is stale

  A[UI: Global Search query] --> B(SVC: Search POST /v1/search/query)
  B --> C[Search returns candidates\n[{objectName, recordId, score}]]
  C --> D(SVC: Core POST /v1/query/recordsByIds\n(select fields))
  D --> E{Core AuthZ:\nObject Read + Record Read + Field mask}
  E --> F[Core returns visible records only\n(others dropped)]
  F --> G[UI: 結果表示]
```

---

## Flow-6：Report 実行 → ドリルダウン（漏洩防止）

```mermaid
flowchart TD
  %% Flow-6: Report run → results → drilldown (no leakage)

  A[UI: Report Builder/Run] --> B(SVC: Reporting POST /v1/reports/{id}/run)
  B --> C[Reporting loads definition\n(columns, groupBy, measures, filters)]
  C --> D(SVC: Core POST /v1/query/execute\n(select: groupBy fields + measure fields + Id))
  D --> E{Core applies AuthZ:\nObject/Field/Record}
  E --> F[Core returns visible detail rows]
  F --> G[Reporting aggregates\n(tabular/summary/matrix)]
  G --> H[Store results as runId\n(cache)]
  H --> I[UI: results view]

  I --> J{Drilldown?}
  J -- No --> K[Done]
  J -- Yes --> L[UI selects bucket/group]
  L --> M[Reporting returns recordIds for bucket]
  M --> N(SVC: Core POST /v1/query/recordsByIds\n(select detail fields))
  N --> O[Core returns visible records only]
  O --> P[UI: drilldown detail view]
```

