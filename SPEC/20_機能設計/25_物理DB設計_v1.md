# 物理DB設計 v1（PostgreSQL）

## 0. 前提・方針

### 0.1 マルチテナント

* **TenantId を全テーブル必須**（メタデータ系含む）
* 参照整合は **同一TenantId内のみ**（アプリ層でもチェック、DBは複合FKで担保できる箇所は担保）

### 0.2 ID方式

* `id` は ULID/UUID（アプリ生成推奨）
* すべての主テーブルは `PRIMARY KEY (tenant_id, id)` を採用
  → これで **テナント境界のFK** を張りやすくし、巨大テーブルでも索引効率を上げる

### 0.3 論理削除

* 主要テーブルは `is_deleted boolean not null default false`
* 通常クエリは `is_deleted=false` を必ず条件に含める（ビュー化しても良い）

### 0.4 楽観ロック

* `system_modstamp timestamptz not null default now()`
* 更新時に `WHERE system_modstamp = :expected` を必須にする（API仕様と一致）

### 0.5 命名規約

* テーブル：スネークケース複数形（例：`accounts`, `opportunities`）
* FK列：`xxx_id`
* enumは **DB enumを避け**、`text + check` か参照テーブル（メタデータ）を原則

---

# 1. 共通カラム（全テーブル共通セット）

主要業務テーブル（Account等）は下記を必須とする：

* `tenant_id uuid not null`
* `id uuid not null`
* `owner_id uuid not null`（ユーザ/キューも扱う場合は後述）
* `created_at timestamptz not null default now()`
* `created_by uuid not null`
* `updated_at timestamptz not null default now()`
* `updated_by uuid not null`
* `is_deleted boolean not null default false`
* `system_modstamp timestamptz not null default now()`

> 以降DDL例ではこのセットを省略せずに書きます（実装時はテンプレ化推奨）。

---

# 2. コア業務テーブル（DDL）

## 2.1 users / roles / groups（権限主体）

### 2.1.1 users

```sql
create table users (
  tenant_id uuid not null,
  id uuid not null,
  username text not null,
  display_name text not null,
  email text,
  role_id uuid,
  is_active boolean not null default true,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  unique (tenant_id, username)
);

create index idx_users_tenant_role on users (tenant_id, role_id) where is_deleted=false;
```

### 2.1.2 roles（階層）

```sql
create table roles (
  tenant_id uuid not null,
  id uuid not null,
  name text not null,
  parent_role_id uuid,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  unique (tenant_id, name),
  foreign key (tenant_id, parent_role_id) references roles (tenant_id, id)
);

create index idx_roles_tenant_parent on roles (tenant_id, parent_role_id) where is_deleted=false;
```

> 循環禁止（ロール木の循環）はDBだけで完全には防ぎにくいので、**アプリ層で木チェック**＋（必要なら）closure table採用（後述）。

### 2.1.3 groups / group_members（Public Group/Queue）

```sql
create table groups (
  tenant_id uuid not null,
  id uuid not null,
  name text not null,
  group_type text not null, -- 'public' | 'queue'
  is_active boolean not null default true,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  unique (tenant_id, name),
  check (group_type in ('public','queue'))
);

create table group_members (
  tenant_id uuid not null,
  id uuid not null,
  group_id uuid not null,
  member_type text not null, -- 'user' | 'role'
  member_id uuid not null,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  unique (tenant_id, group_id, member_type, member_id),
  foreign key (tenant_id, group_id) references groups (tenant_id, id),
  check (member_type in ('user','role'))
);

create index idx_group_members_lookup on group_members (tenant_id, member_type, member_id) where is_deleted=false;
```

---

## 2.2 accounts / contacts / leads

### 2.2.1 accounts

```sql
create table accounts (
  tenant_id uuid not null,
  id uuid not null,
  owner_id uuid not null,

  name text not null,
  type text,
  parent_id uuid,
  industry text,
  website text,
  phone text,
  billing_address jsonb,
  shipping_address jsonb,
  annual_revenue numeric(18,2),
  number_of_employees integer,
  status text not null default 'Active',
  external_ids jsonb,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  foreign key (tenant_id, parent_id) references accounts (tenant_id, id),
  check (status in ('Active','Inactive'))
);

create index idx_accounts_tenant_owner on accounts (tenant_id, owner_id) where is_deleted=false;
create index idx_accounts_tenant_parent on accounts (tenant_id, parent_id) where is_deleted=false;
create index idx_accounts_name_trgm on accounts using gin (name gin_trgm_ops) where is_deleted=false;
```

※ `pg_trgm` を使う場合：`create extension if not exists pg_trgm;`

### 2.2.2 contacts

```sql
create table contacts (
  tenant_id uuid not null,
  id uuid not null,
  owner_id uuid not null,

  account_id uuid not null,
  last_name text not null,
  first_name text,
  email text,
  phone text,
  mobile_phone text,
  title text,
  department text,
  status text not null default 'Active',
  external_ids jsonb,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  foreign key (tenant_id, account_id) references accounts (tenant_id, id),
  check (status in ('Active','Inactive'))
);

create index idx_contacts_tenant_account on contacts (tenant_id, account_id) where is_deleted=false;
create index idx_contacts_email on contacts (tenant_id, email) where is_deleted=false and email is not null;
create index idx_contacts_name_trgm on contacts using gin ((coalesce(last_name,'') || ' ' || coalesce(first_name,'')) gin_trgm_ops)
  where is_deleted=false;
```

### 2.2.3 leads

```sql
create table leads (
  tenant_id uuid not null,
  id uuid not null,
  owner_id uuid not null,

  company text not null,
  last_name text not null,
  first_name text,
  email text,
  phone text,
  status text not null default 'New',
  lead_source text,
  disqualification_reason text,

  qualified_at timestamptz,
  qualified_by uuid,
  converted_at timestamptz,
  converted_by uuid,
  converted_account_id uuid,
  converted_contact_id uuid,
  converted_opportunity_id uuid,

  external_ids jsonb,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  foreign key (tenant_id, converted_account_id) references accounts (tenant_id, id),
  foreign key (tenant_id, converted_contact_id) references contacts (tenant_id, id),
  check (status in ('New','Working','Nurturing','Qualified','Disqualified','Converted'))
);

create index idx_leads_status on leads (tenant_id, status) where is_deleted=false;
create index idx_leads_email on leads (tenant_id, email) where is_deleted=false and email is not null;
```

---

## 2.3 opportunities / stages / contact roles

### 2.3.1 opportunity_stages（メタデータ）

```sql
create table opportunity_stages (
  tenant_id uuid not null,
  id uuid not null,

  stage_name text not null,
  is_active boolean not null default true,
  is_closed boolean not null default false,
  is_won boolean not null default false,
  default_probability numeric(5,2) not null,
  default_forecast_category text not null,
  sort_order integer not null,
  required_fields jsonb not null default '[]'::jsonb,
  blocked_transitions jsonb not null default '[]'::jsonb,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  unique (tenant_id, stage_name)
);

create index idx_opp_stages_active on opportunity_stages (tenant_id, sort_order) where is_deleted=false and is_active=true;
```

### 2.3.2 opportunities

```sql
create table opportunities (
  tenant_id uuid not null,
  id uuid not null,
  owner_id uuid not null,

  account_id uuid not null,
  name text not null,

  stage_name text not null,
  close_date date not null,

  amount numeric(18,2),
  currency_iso_code text,
  probability numeric(5,2) not null,
  forecast_category_name text not null,

  is_closed boolean not null default false,
  is_won boolean not null default false,

  next_step text,
  next_action_date date,
  type text,
  lead_source text,
  competitors jsonb,
  description text,

  pricebook_id uuid,
  primary_quote_id uuid,

  closed_at timestamptz,
  closed_by uuid,
  lost_reason text,

  external_ids jsonb,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  foreign key (tenant_id, account_id) references accounts (tenant_id, id),

  -- 重要：ステージ名はメタデータ参照で担保したいが、tenant_id+stage_name参照はFK張りづらいので
  -- (a) アプリ層で保証、(b) 参照テーブルを stage_id 参照にする、のどちらかを選ぶ。
  -- v1では name参照を採用し、アプリ+Validationで保証。

  check (probability >= 0 and probability <= 100)
);

create index idx_opps_account on opportunities (tenant_id, account_id) where is_deleted=false;
create index idx_opps_owner on opportunities (tenant_id, owner_id) where is_deleted=false;
create index idx_opps_stage on opportunities (tenant_id, stage_name) where is_deleted=false;
create index idx_opps_close_date on opportunities (tenant_id, close_date) where is_deleted=false;
create index idx_opps_forecast_cat on opportunities (tenant_id, forecast_category_name) where is_deleted=false;
```

> ステージは物理的に `stage_id` 参照にした方がDB整合は強いです。
> ただしUI/APIの扱い（StageName）を重視するなら **stage_nameを実体** として持ち、参照整合はValidationで担保が現実的です（Salesforce互換の運用感）。

### 2.3.3 opportunity_contact_roles（商談関与者）

```sql
create table opportunity_contact_roles (
  tenant_id uuid not null,
  id uuid not null,

  opportunity_id uuid not null,
  contact_id uuid not null,
  role text not null,
  is_primary boolean not null default false,
  influence_level integer,
  stance text,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  foreign key (tenant_id, opportunity_id) references opportunities (tenant_id, id),
  foreign key (tenant_id, contact_id) references contacts (tenant_id, id),
  unique (tenant_id, opportunity_id, contact_id),
  check (stance is null or stance in ('Support','Neutral','Oppose')),
  check (influence_level is null or (influence_level between 1 and 5))
);

-- Primaryは商談内で最大1（部分一意）
create unique index uq_opp_contact_role_primary
  on opportunity_contact_roles (tenant_id, opportunity_id)
  where is_deleted=false and is_primary=true;

create index idx_opp_contact_roles_opp on opportunity_contact_roles (tenant_id, opportunity_id) where is_deleted=false;
create index idx_opp_contact_roles_contact on opportunity_contact_roles (tenant_id, contact_id) where is_deleted=false;
```

---

# 3. 商品・価格表・明細

## 3.1 products / pricebooks / pricebook_entries

```sql
create table products (
  tenant_id uuid not null,
  id uuid not null,
  owner_id uuid not null,

  name text not null,
  product_code text,
  family text,
  is_active boolean not null default true,
  description text,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id)
);

create index idx_products_active on products (tenant_id, is_active) where is_deleted=false;

create table pricebooks (
  tenant_id uuid not null,
  id uuid not null,
  owner_id uuid not null,

  name text not null,
  is_active boolean not null default true,
  is_standard boolean not null default false,
  currency_iso_code text,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  unique (tenant_id, name)
);

create table pricebook_entries (
  tenant_id uuid not null,
  id uuid not null,

  pricebook_id uuid not null,
  product_id uuid not null,
  unit_price numeric(18,2) not null,
  is_active boolean not null default true,
  use_standard_price boolean not null default false,
  currency_iso_code text,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  foreign key (tenant_id, pricebook_id) references pricebooks (tenant_id, id),
  foreign key (tenant_id, product_id) references products (tenant_id, id),
  unique (tenant_id, pricebook_id, product_id)
);

create index idx_pbe_pricebook on pricebook_entries (tenant_id, pricebook_id) where is_deleted=false and is_active=true;
create index idx_pbe_product on pricebook_entries (tenant_id, product_id) where is_deleted=false;
```

## 3.2 opportunity_line_items

```sql
create table opportunity_line_items (
  tenant_id uuid not null,
  id uuid not null,

  opportunity_id uuid not null,
  pricebook_entry_id uuid not null,

  quantity numeric(18,6) not null default 1,
  unit_price numeric(18,2) not null,
  discount_amount numeric(18,2) not null default 0,
  discount_percent numeric(5,2) not null default 0,
  total_price numeric(18,2) not null,

  service_date date,
  description text,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  foreign key (tenant_id, opportunity_id) references opportunities (tenant_id, id),
  foreign key (tenant_id, pricebook_entry_id) references pricebook_entries (tenant_id, id),

  check (quantity > 0),
  check (discount_percent >= 0 and discount_percent <= 100)
);

create index idx_oli_opp on opportunity_line_items (tenant_id, opportunity_id) where is_deleted=false;
create index idx_oli_pbe on opportunity_line_items (tenant_id, pricebook_entry_id) where is_deleted=false;
```

> **価格表整合（INV-LI1）** は「Opportunity.pricebook_id」と「PBE.pricebook_id」が一致する必要があるため、DBの単純FKでは担保困難。
> → **Validation（VR-LI-01）** で担保し、必要なら **トリガ**で“最後の砦”を置く（推奨）。

---

# 4. 見積・受注

## 4.1 quotes / quote_line_items

```sql
create table quotes (
  tenant_id uuid not null,
  id uuid not null,
  owner_id uuid not null,

  opportunity_id uuid not null,
  name text not null,
  status text not null default 'Draft',
  is_primary boolean not null default false,

  pricebook_id uuid not null,
  expiration_date date,
  grand_total numeric(18,2) not null default 0,

  presented_at timestamptz,
  accepted_at timestamptz,
  rejected_reason text,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  foreign key (tenant_id, opportunity_id) references opportunities (tenant_id, id),
  foreign key (tenant_id, pricebook_id) references pricebooks (tenant_id, id),
  check (status in ('Draft','Presented','Accepted','Rejected','Expired'))
);

-- 商談内でPrimary最大1（部分一意）
create unique index uq_quotes_primary
  on quotes (tenant_id, opportunity_id)
  where is_deleted=false and is_primary=true;

create index idx_quotes_opp on quotes (tenant_id, opportunity_id) where is_deleted=false;
create index idx_quotes_status on quotes (tenant_id, status) where is_deleted=false;

create table quote_line_items (
  tenant_id uuid not null,
  id uuid not null,

  quote_id uuid not null,
  pricebook_entry_id uuid not null,

  quantity numeric(18,6) not null default 1,
  unit_price numeric(18,2) not null,
  discount_amount numeric(18,2) not null default 0,
  discount_percent numeric(5,2) not null default 0,
  total_price numeric(18,2) not null,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  foreign key (tenant_id, quote_id) references quotes (tenant_id, id),
  foreign key (tenant_id, pricebook_entry_id) references pricebook_entries (tenant_id, id),
  check (quantity > 0),
  check (discount_percent >= 0 and discount_percent <= 100)
);

create index idx_qli_quote on quote_line_items (tenant_id, quote_id) where is_deleted=false;
```

## 4.2 orders / order_items

```sql
create table orders (
  tenant_id uuid not null,
  id uuid not null,
  owner_id uuid not null,

  account_id uuid not null,
  opportunity_id uuid,
  status text not null default 'Draft',
  effective_date date not null,
  end_date date,
  pricebook_id uuid,
  total_amount numeric(18,2) not null default 0,
  activated_at timestamptz,
  cancelled_reason text,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  foreign key (tenant_id, account_id) references accounts (tenant_id, id),
  foreign key (tenant_id, opportunity_id) references opportunities (tenant_id, id),
  foreign key (tenant_id, pricebook_id) references pricebooks (tenant_id, id),
  check (status in ('Draft','Activated','Fulfilled','Cancelled')),
  check (end_date is null or end_date >= effective_date)
);

create index idx_orders_account on orders (tenant_id, account_id) where is_deleted=false;
create index idx_orders_status on orders (tenant_id, status) where is_deleted=false;

create table order_items (
  tenant_id uuid not null,
  id uuid not null,

  order_id uuid not null,
  pricebook_entry_id uuid not null,
  quantity numeric(18,6) not null default 1,
  unit_price numeric(18,2) not null,
  discount_amount numeric(18,2) not null default 0,
  discount_percent numeric(5,2) not null default 0,
  total_price numeric(18,2) not null,

  service_start_date date,
  service_end_date date,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  foreign key (tenant_id, order_id) references orders (tenant_id, id),
  foreign key (tenant_id, pricebook_entry_id) references pricebook_entries (tenant_id, id),
  check (quantity > 0),
  check (service_end_date is null or service_start_date is null or service_end_date >= service_start_date)
);

create index idx_order_items_order on order_items (tenant_id, order_id) where is_deleted=false;
```

---

# 5. 活動（Task/Event）— 多態参照の物理表現

**方針**：Who/What は多態参照なので、`*_type` + `*_id` を持つ。

## 5.1 tasks

```sql
create table tasks (
  tenant_id uuid not null,
  id uuid not null,
  owner_id uuid not null,

  subject text not null,
  status text not null default 'NotStarted',
  priority text not null default 'Normal',
  activity_date date,
  completed_at timestamptz,

  who_type text,
  who_id uuid,
  what_type text,
  what_id uuid,

  description text,
  is_closed boolean not null default false,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  check (status in ('NotStarted','InProgress','Completed','Deferred')),
  check (priority in ('Low','Normal','High')),
  check (who_type is null or who_type in ('Lead','Contact')),
  check (what_type is null or what_type in ('Account','Opportunity','Campaign','Quote','Order'))
);

create index idx_tasks_owner_date on tasks (tenant_id, owner_id, activity_date) where is_deleted=false;
create index idx_tasks_who on tasks (tenant_id, who_type, who_id) where is_deleted=false and who_id is not null;
create index idx_tasks_what on tasks (tenant_id, what_type, what_id) where is_deleted=false and what_id is not null;
```

> 多態参照のFKは張れないため、参照整合はアプリ層＋監査で担保。
> ただし `*_type` を check で固定し "未知タイプ混入" を防ぐ。

## 5.2 events（カレンダーイベント/会議）

```sql
create table events (
  tenant_id uuid not null,
  id uuid not null,
  owner_id uuid not null,

  subject text not null,
  start_at timestamptz not null,
  end_at timestamptz not null,
  location text,
  is_all_day boolean not null default false,

  who_type text,
  who_id uuid,
  what_type text,
  what_id uuid,

  description text,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  check (end_at > start_at),
  check (who_type is null or who_type in ('Lead','Contact')),
  check (what_type is null or what_type in ('Account','Opportunity','Campaign','Quote','Order'))
);

create index idx_events_owner_time on events (tenant_id, owner_id, start_at) where is_deleted=false;
create index idx_events_who on events (tenant_id, who_type, who_id) where is_deleted=false and who_id is not null;
create index idx_events_what on events (tenant_id, what_type, what_id) where is_deleted=false and what_id is not null;
```

---

# 6. 共有（Sharing）— 大規模になるため物理設計が肝

## 6.1 object_shares（統合テーブル方式）

Salesforceの `AccountShare` 等を分ける代わりに、**統合型**で運用しやすくする案。

```sql
create table object_shares (
  tenant_id uuid not null,
  id uuid not null,

  object_name text not null, -- 'Account','Opportunity',...
  record_id uuid not null,

  subject_type text not null, -- 'User','Role','Group','Territory'
  subject_id uuid not null,

  access_level text not null, -- 'Read','Write'
  row_cause text not null,    -- 'Owner','Rule','Manual','Team','Territory','RoleHierarchy','Implicit'

  source_rule_id uuid,        -- Rule由来なら格納（任意）
  created_at timestamptz not null default now(),
  created_by uuid not null,

  is_deleted boolean not null default false,

  primary key (tenant_id, id),
  check (access_level in ('Read','Write')),
  check (subject_type in ('User','Role','Group','Territory')),
  check (row_cause in ('Owner','Rule','Manual','Team','Territory','RoleHierarchy','Implicit'))
);

-- “アクセス判定”のための最重要インデックス
create index idx_share_lookup_record
  on object_shares (tenant_id, object_name, record_id)
  where is_deleted=false;

create index idx_share_lookup_subject
  on object_shares (tenant_id, object_name, subject_type, subject_id)
  where is_deleted=false;

create index idx_share_lookup_record_subject
  on object_shares (tenant_id, object_name, record_id, subject_type, subject_id)
  where is_deleted=false;

-- 重複防止（原因まで含めて一意にするのが運用上安全）
create unique index uq_share_dedup
  on object_shares (tenant_id, object_name, record_id, subject_type, subject_id, access_level, row_cause, coalesce(source_rule_id, '00000000-0000-0000-0000-000000000000'::uuid))
  where is_deleted=false;
```

## 6.2 owd_settings（組織全体デフォルト）

オブジェクトごとのデフォルトアクセスレベルを定義。

```sql
create table owd_settings (
  tenant_id uuid not null,
  id uuid not null,
  object_name text not null,  -- 'Account','Opportunity' 等
  default_internal_access text not null default 'Private',  -- 内部ユーザ向け
  default_external_access text not null default 'Private',  -- 外部ユーザ向け（ポータル等）

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  unique (tenant_id, object_name),
  check (default_internal_access in ('Private','PublicReadOnly','PublicReadWrite')),
  check (default_external_access in ('Private','PublicReadOnly','PublicReadWrite'))
);

create index idx_owd_settings_object on owd_settings (tenant_id, object_name);
```

> OWD変更時は共有の全再計算が必要。変更頻度は低いが影響が大きい。

## 6.3 sharing_rules（共有ルール定義）

条件に基づいてレコードアクセスを拡張するルール定義。

```sql
create table sharing_rules (
  tenant_id uuid not null,
  id uuid not null,
  name text not null,
  object_name text not null,  -- 対象オブジェクト
  is_active boolean not null default true,

  -- 共有元：条件ベース（Criteria）またはオーナーベース（Owner）
  rule_type text not null default 'Criteria',  -- 'Criteria' | 'Owner'
  criteria_expression jsonb,  -- 条件式（rule_type='Criteria'のとき）
  owner_role_id uuid,         -- オーナーロール（rule_type='Owner'のとき）

  -- 共有先
  target_subject_type text not null,  -- 'Role','RoleAndSubordinates','Group','Territory'
  target_subject_id uuid not null,

  -- アクセスレベル
  access_level text not null,  -- 'Read' | 'Write'

  -- 再計算管理
  last_calculated_at timestamptz,
  records_affected integer not null default 0,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  unique (tenant_id, name),
  check (rule_type in ('Criteria','Owner')),
  check (target_subject_type in ('Role','RoleAndSubordinates','Group','Territory')),
  check (access_level in ('Read','Write'))
);

create index idx_sharing_rules_object on sharing_rules (tenant_id, object_name, is_active) where is_deleted=false;
create index idx_sharing_rules_target on sharing_rules (tenant_id, target_subject_type, target_subject_id) where is_deleted=false;
```

> 共有ルール変更時は対象レコードの共有行を再計算。非同期バッチで処理。

### 6.4 パーティション（必須推奨）

`object_shares` は最大級になるので、以下いずれかで分割：

* **(推奨) object_name で LIST パーティション**

  * AccountShare/OpportunityShare相当の分離が自然にできる
* または `tenant_id` で HASH パーティション（テナント数が多い場合）

---

# 7. テリトリ（Territory）

テリトリは共有評価（E2）に入るため、階層・割当・closureまで定義する。

## 7.1 territory_models（テリトリモデル定義）

```sql
create table territory_models (
  tenant_id uuid not null,
  id uuid not null,
  name text not null,
  description text,
  is_active boolean not null default false,
  activated_at timestamptz,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  unique (tenant_id, name)
);

create index idx_territory_models_active on territory_models (tenant_id, is_active) where is_deleted=false;
```

## 7.2 territory_types（テリトリ種別）

```sql
create table territory_types (
  tenant_id uuid not null,
  id uuid not null,
  model_id uuid not null,
  name text not null,
  priority integer not null default 0,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  foreign key (tenant_id, model_id) references territory_models (tenant_id, id),
  unique (tenant_id, model_id, name)
);
```

## 7.3 territories（テリトリ本体）

```sql
create table territories (
  tenant_id uuid not null,
  id uuid not null,
  model_id uuid not null,
  type_id uuid,
  name text not null,
  parent_id uuid,
  is_active boolean not null default true,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  foreign key (tenant_id, model_id) references territory_models (tenant_id, id),
  foreign key (tenant_id, type_id) references territory_types (tenant_id, id),
  foreign key (tenant_id, parent_id) references territories (tenant_id, id)
);

create index idx_territories_model on territories (tenant_id, model_id, is_deleted);
create index idx_territories_parent on territories (tenant_id, parent_id, is_deleted);
```

## 7.4 territory_closure（祖先・子孫の高速判定）

```sql
create table territory_closure (
  tenant_id uuid not null,
  ancestor_id uuid not null,
  descendant_id uuid not null,
  depth integer not null,  -- 0=self

  primary key (tenant_id, ancestor_id, descendant_id),
  foreign key (tenant_id, ancestor_id) references territories (tenant_id, id),
  foreign key (tenant_id, descendant_id) references territories (tenant_id, id)
);

create index idx_territory_closure_desc on territory_closure (tenant_id, descendant_id, depth);
```

> closure tableはテリトリ階層変更時にアプリ層で再計算。循環禁止もアプリ層で検証。

## 7.5 user_territory_assignments（ユーザ割当）

```sql
create table user_territory_assignments (
  tenant_id uuid not null,
  id uuid not null,
  user_id uuid not null,
  territory_id uuid not null,
  is_primary boolean not null default false,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  foreign key (tenant_id, territory_id) references territories (tenant_id, id),
  unique (tenant_id, user_id, territory_id)
);

create index idx_user_territory_user on user_territory_assignments (tenant_id, user_id, is_deleted);
create index idx_user_territory_territory on user_territory_assignments (tenant_id, territory_id, is_deleted);
```

## 7.6 account_territory_assignments（取引先割当）

```sql
create table account_territory_assignments (
  tenant_id uuid not null,
  id uuid not null,
  account_id uuid not null,
  territory_id uuid not null,
  assignment_source text not null default 'Manual',  -- 'Manual' | 'Rule'
  source_rule_id uuid,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  foreign key (tenant_id, account_id) references accounts (tenant_id, id),
  foreign key (tenant_id, territory_id) references territories (tenant_id, id),
  unique (tenant_id, account_id, territory_id),
  check (assignment_source in ('Manual','Rule'))
);

create index idx_account_territory_account on account_territory_assignments (tenant_id, account_id, is_deleted);
create index idx_account_territory_territory on account_territory_assignments (tenant_id, territory_id, is_deleted);
```

## 7.7 territory_rules（割当ルール）

```sql
create table territory_rules (
  tenant_id uuid not null,
  id uuid not null,
  model_id uuid not null,
  territory_id uuid not null,
  name text not null,
  is_active boolean not null default true,
  condition_ast jsonb not null,  -- フィルタ条件（DSL/AST）

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  foreign key (tenant_id, model_id) references territory_models (tenant_id, id),
  foreign key (tenant_id, territory_id) references territories (tenant_id, id)
);

create index idx_territory_rules_model on territory_rules (tenant_id, model_id, is_active) where is_deleted=false;
```

---

# 8. 自動化（Validation/Workflow）— メタデータと実行ログ

バリデーション、ワークフロー、スケジュールジョブの定義と実行ログを管理。

> `ConditionAst` は `jsonb` で保存（後でDSL/AST改良に耐える）。

## 8.1 validation_rules（入力検証ルール）

保存時に満たすべき条件を定義。違反時は保存不可。

```sql
create table validation_rules (
  tenant_id uuid not null,
  id uuid not null,
  object_name text not null,
  rule_name text not null,
  description text,

  is_active boolean not null default true,
  condition_expression jsonb not null,  -- 検証条件（DSL/AST）
  error_message text not null,

  -- 適用タイミング
  apply_on_create boolean not null default true,
  apply_on_update boolean not null default true,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  unique (tenant_id, object_name, rule_name)
);

create index idx_validation_rules_object on validation_rules (tenant_id, object_name, is_active) where is_deleted=false;
```

## 8.2 workflow_rules（ワークフロールール）

条件に応じて自動処理を実行するルール定義。

```sql
create table workflow_rules (
  tenant_id uuid not null,
  id uuid not null,
  object_name text not null,
  rule_name text not null,
  description text,

  is_active boolean not null default true,

  -- トリガタイプ
  trigger_type text not null,  -- 'Create' | 'Update' | 'CreateOrUpdate'

  -- 条件
  condition_expression jsonb,  -- 条件式（null = 常に実行）

  -- 評価条件
  re_evaluate_on_update boolean not null default false,  -- 更新時に再評価するか

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  unique (tenant_id, object_name, rule_name),
  check (trigger_type in ('Create','Update','CreateOrUpdate'))
);

create index idx_workflow_rules_object on workflow_rules (tenant_id, object_name, is_active) where is_deleted=false;
```

## 8.3 workflow_actions（ワークフローアクション）

ワークフロールールに紐づく実行アクション。

```sql
create table workflow_actions (
  tenant_id uuid not null,
  id uuid not null,
  workflow_rule_id uuid not null,

  action_type text not null,  -- 'FieldUpdate' | 'Task' | 'Email' | 'OutboundMessage'
  action_name text not null,
  execution_order integer not null default 0,

  -- アクション設定（JSONで各タイプの設定を保持）
  action_config jsonb not null,
  -- FieldUpdate: { field_name, value_type, value }
  -- Task: { subject, due_date_formula, assignee_type, assignee_id }
  -- Email: { template_id, recipient_type, recipients }
  -- OutboundMessage: { endpoint_url, fields }

  is_immediate boolean not null default true,  -- 即時実行 or 時間ベース

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  foreign key (tenant_id, workflow_rule_id) references workflow_rules (tenant_id, id),
  check (action_type in ('FieldUpdate','Task','Email','OutboundMessage'))
);

create index idx_workflow_actions_rule on workflow_actions (tenant_id, workflow_rule_id, execution_order) where is_deleted=false;
```

## 8.4 scheduled_jobs（スケジュールジョブ）

定期実行ジョブの管理。

```sql
create table scheduled_jobs (
  tenant_id uuid not null,
  id uuid not null,
  job_name text not null,
  description text,

  job_type text not null,  -- 'BatchApex' | 'Report' | 'DataExport' | 'SharingRecalc' | 'Custom'
  job_config jsonb not null,  -- ジョブ固有の設定

  cron_expression text not null,  -- cron形式（例: "0 0 * * *"）
  timezone text not null default 'UTC',

  is_active boolean not null default true,

  last_run_at timestamptz,
  last_run_status text,  -- Success/Failed/Cancelled
  next_run_at timestamptz,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  unique (tenant_id, job_name),
  check (job_type in ('BatchApex','Report','DataExport','SharingRecalc','Custom'))
);

create index idx_scheduled_jobs_next_run on scheduled_jobs (tenant_id, is_active, next_run_at) where is_deleted=false;
```

## 8.5 automation_run_logs（自動化実行ログ）

自動化処理の実行履歴。大量になるためパーティション必須。

```sql
create table automation_run_logs (
  tenant_id uuid not null,
  id uuid not null,

  automation_type text not null,  -- 'Validation' | 'Workflow' | 'Approval' | 'ScheduledJob'
  automation_id uuid not null,
  automation_name text,

  target_object_name text,
  target_record_id uuid,

  status text not null,  -- 'Success' | 'Failed' | 'Skipped'
  error_message text,
  execution_details jsonb,  -- 実行詳細（アクション結果等）

  started_at timestamptz not null default now(),
  completed_at timestamptz,
  execution_time_ms integer,

  executed_by uuid,  -- システム実行の場合はnull

  created_at timestamptz not null default now(),

  primary key (tenant_id, id),
  check (automation_type in ('Validation','Workflow','Approval','ScheduledJob')),
  check (status in ('Success','Failed','Skipped'))
) partition by range (created_at);

-- 月次パーティション作成例（実運用では自動化）
-- create table automation_run_logs_2026_01 partition of automation_run_logs
--   for values from ('2026-01-01') to ('2026-02-01');

create index idx_automation_logs_target on automation_run_logs (tenant_id, target_object_name, target_record_id, created_at);
create index idx_automation_logs_automation on automation_run_logs (tenant_id, automation_type, automation_id, created_at);
create index idx_automation_logs_status on automation_run_logs (tenant_id, status, created_at) where status = 'Failed';
```

---

# 9. 承認（Approval）

承認プロセスの定義、インスタンス、ワークアイテム、履歴を管理。

## 9.1 approval_process_definitions（承認プロセス定義）

```sql
create table approval_process_definitions (
  tenant_id uuid not null,
  id uuid not null,
  name text not null,
  object_name text not null,  -- 対象オブジェクト（Quote, Order 等）
  description text,

  is_active boolean not null default true,
  sort_order integer not null default 0,  -- 評価順序

  -- エントリ条件
  entry_criteria jsonb,  -- 承認プロセス開始条件

  -- 承認ステップ定義（JSON配列）
  approval_steps jsonb not null default '[]'::jsonb,
  -- [{ step_number, name, approver_type, approver_id, criteria, ... }]

  -- 最終アクション
  final_approval_actions jsonb,  -- 承認時アクション
  final_rejection_actions jsonb, -- 却下時アクション
  recall_actions jsonb,          -- 取り消し時アクション

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  unique (tenant_id, name)
);

create index idx_approval_defs_object on approval_process_definitions (tenant_id, object_name, is_active) where is_deleted=false;
create index idx_approval_defs_sort on approval_process_definitions (tenant_id, object_name, sort_order) where is_deleted=false and is_active=true;
```

## 9.2 approval_instances（承認インスタンス）

実際の承認申請を表すレコード。

```sql
create table approval_instances (
  tenant_id uuid not null,
  id uuid not null,
  process_definition_id uuid not null,

  target_object_name text not null,
  target_record_id uuid not null,

  status text not null default 'Pending',  -- Pending/Approved/Rejected/Recalled

  submitted_by uuid not null,
  submitted_at timestamptz not null default now(),
  completed_at timestamptz,
  completed_by uuid,

  current_step integer not null default 1,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  foreign key (tenant_id, process_definition_id) references approval_process_definitions (tenant_id, id),
  check (status in ('Pending','Approved','Rejected','Recalled'))
);

create index idx_approval_inst_target on approval_instances (tenant_id, target_object_name, target_record_id) where is_deleted=false;
create index idx_approval_inst_status on approval_instances (tenant_id, status) where is_deleted=false;
create index idx_approval_inst_submitter on approval_instances (tenant_id, submitted_by, status) where is_deleted=false;
```

## 9.3 approval_work_items（承認ワークアイテム）

各承認ステップの作業アイテム。

```sql
create table approval_work_items (
  tenant_id uuid not null,
  id uuid not null,
  approval_instance_id uuid not null,

  step_number integer not null,
  approver_id uuid not null,

  status text not null default 'Pending',  -- Pending/Approved/Rejected/Reassigned

  assigned_at timestamptz not null default now(),
  completed_at timestamptz,
  comments text,

  -- 再割当情報
  original_approver_id uuid,
  reassigned_by uuid,
  reassigned_at timestamptz,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  foreign key (tenant_id, approval_instance_id) references approval_instances (tenant_id, id),
  check (status in ('Pending','Approved','Rejected','Reassigned'))
);

create index idx_approval_work_approver on approval_work_items (tenant_id, approver_id, status) where is_deleted=false;
create index idx_approval_work_instance on approval_work_items (tenant_id, approval_instance_id, step_number) where is_deleted=false;
```

## 9.4 approval_histories（承認履歴）

承認プロセスの全アクション履歴。

```sql
create table approval_histories (
  tenant_id uuid not null,
  id uuid not null,
  approval_instance_id uuid not null,

  actor_id uuid not null,
  action text not null,  -- Submit/Approve/Reject/Recall/Reassign/Comment

  step_number integer,
  comments text,

  created_at timestamptz not null default now(),
  created_by uuid not null,

  primary key (tenant_id, id),
  foreign key (tenant_id, approval_instance_id) references approval_instances (tenant_id, id),
  check (action in ('Submit','Approve','Reject','Recall','Reassign','Comment'))
);

create index idx_approval_hist_instance on approval_histories (tenant_id, approval_instance_id, created_at);
create index idx_approval_hist_actor on approval_histories (tenant_id, actor_id, created_at);
```

---

# 10. 監査・履歴（Audit）

## 10.1 field_history（フィールド履歴）

```sql
create table field_histories (
  tenant_id uuid not null,
  id uuid not null,

  object_name text not null,
  record_id uuid not null,
  field_name text not null,

  old_value jsonb,
  new_value jsonb,

  changed_at timestamptz not null default now(),
  changed_by uuid not null,

  primary key (tenant_id, id)
);

create index idx_field_hist_record on field_histories (tenant_id, object_name, record_id, changed_at desc);
```

> 値は型が多様なので `jsonb` が最も安全。

## 10.2 audit_events（重要イベント）

* Convert / StageChange / OwnerChange / PrimaryQuoteChange / ApprovalDecision 等
* `event_type text`, `payload jsonb`, `occurred_at timestamptz`

パーティション：`occurred_at` の月次推奨

---

# 11. 添付（Content）

Blob本体はDBに入れず、`storage_uri` にオブジェクトストレージ（S3/GCS等）参照。

## 11.1 content_documents（論理的なファイル）

```sql
create table content_documents (
  tenant_id uuid not null,
  id uuid not null,
  owner_id uuid not null,
  title text not null,
  file_type text not null,  -- pdf, docx, png 等
  latest_version_id uuid,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id)
);

create index idx_content_docs_owner on content_documents (tenant_id, owner_id, is_deleted);
create index idx_content_docs_type on content_documents (tenant_id, file_type, is_deleted);
```

## 11.2 content_versions（実体：ストレージ参照）

```sql
create table content_versions (
  tenant_id uuid not null,
  id uuid not null,
  document_id uuid not null,
  version_number integer not null,
  storage_uri text not null,  -- S3/GCS等のURI
  content_size bigint not null,
  checksum_sha256 text,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  foreign key (tenant_id, document_id) references content_documents (tenant_id, id)
);

create unique index uq_content_versions_doc_ver
  on content_versions (tenant_id, document_id, version_number)
  where is_deleted=false;

create index idx_content_versions_doc on content_versions (tenant_id, document_id, is_deleted);
```

## 11.3 content_document_links（レコードへの紐付け）

```sql
create table content_document_links (
  tenant_id uuid not null,
  id uuid not null,
  document_id uuid not null,
  linked_entity_type text not null,  -- 'Account','Opportunity','Quote' 等
  linked_entity_id uuid not null,
  share_type text not null default 'V',  -- V(View)/C(Collaborator)/I(Inferred)
  visibility text not null default 'AllUsers',  -- AllUsers/InternalUsers/SharedUsers

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  foreign key (tenant_id, document_id) references content_documents (tenant_id, id),
  check (share_type in ('V','C','I')),
  check (visibility in ('AllUsers','InternalUsers','SharedUsers'))
);

create index idx_content_links_record
  on content_document_links (tenant_id, linked_entity_type, linked_entity_id, is_deleted);

create index idx_content_links_document
  on content_document_links (tenant_id, document_id, is_deleted);

-- 同一ドキュメントを同一レコードに複数回紐付けない
create unique index uq_content_links_doc_record
  on content_document_links (tenant_id, document_id, linked_entity_type, linked_entity_id)
  where is_deleted=false;
```

> 多態参照のFKは張れないため、参照整合はアプリ層で担保。

---

# 12. カスタム項目（Custom Fields）の物理方式

要件：**追加項目が検索/レポート/権限/検証に乗る**。

### 方式A（推奨 v1）：JSONB（object_custom_values）

* 例：`account_custom_values(tenant_id, account_id, values jsonb)`
* Pros：シンプル、開発が速い
* Cons：集計/索引が難しい（ただしGIN + 特定キーの式インデックスで対応可能）

### 方式B：型別EAV

* `custom_values_text / _number / _date / _bool`
* Pros：レポートが強い
* Cons：テーブルが増える、実装が重い

**v1結論**：方式A（JSONB）で開始し、**レポート要件が固まったら方式Bを追加**（併存可能）

JSONB例（Account）：

```sql
create table account_custom_values (
  tenant_id uuid not null,
  account_id uuid not null,
  values jsonb not null default '{}'::jsonb,

  updated_at timestamptz not null default now(),
  updated_by uuid not null,

  primary key (tenant_id, account_id),
  foreign key (tenant_id, account_id) references accounts (tenant_id, id)
);

create index idx_account_custom_values_gin
  on account_custom_values using gin (values);
```

---

# 13. 検索設計（Search）

## 13.1 選択肢

* **PG内で完結**：`pg_trgm` + `tsvector`（中規模まで）
* **外部検索**（推奨）：OpenSearch/Elasticsearch（大規模、権限制御含めて設計）

**v1推奨**：まずPG内で実装（trgm + 必要なら tsvector）、スケール段階で外部検索へ。

### 13.2 tsvector（任意）

各オブジェクトに `search_text` を用意してGIN：

* Account：Name/Industry/Website
* Contact：Name/Email/Title
* Opportunity：Name/Stage/NextStep

> フィールド権限・共有を検索結果に必ず適用する（検索ヒットで漏洩させない）。

---

# 14. パーティション計画（必須テーブル）

規模に応じて以下を分割（最初から設計に入れておく）：

* `object_shares`：LIST(object_name) + （必要なら）RANGE(created_at)
* `automation_run_logs`：RANGE(created_at) 月次
* `audit_events` / `field_histories`：RANGE(occurred_at/changed_at) 月次
* `tasks` / `events`：RANGE(created_at) もしくは owner_id軸を検討（まずは通常indexで十分なことも多い）

---

# 15. 典型クエリと必要インデックス（“詰まりどころ”だけ固定）

## 15.1 商談一覧（My Pipeline）

条件：

* `tenant_id=?`
* `is_deleted=false`
* `owner_id=?` または `team` 共有でアクセス可能
* 並び：`close_date asc`

必要：

* `opportunities (tenant_id, owner_id, close_date)` の複合index（追加推奨）
* Share方式の場合は `object_shares` の subjectインデックスで `AccessibleRecordIds` を絞る

## 15.2 共有判定（GetById）

* まず `ModifyAll/ViewAll` を権限で短絡
* それ以外は `object_shares` を `(tenant_id, object_name, record_id)` で引いて subject一致を判定

---

# 16. キャッシュ（必須：性能安定の鍵）

## 16.1 キャッシュ対象（Redis等）

* `EffectivePermission`（ユーザの権限展開）

  * RolePath / Groups / Territories / ObjectPerm / FieldPerm
* `ShareModelVersion`（共有計算のバージョン）
* `Describe`（メタデータ：objects/fields/layouts）
* よく使う ListView 定義

キャッシュ失効：

* 権限・ロール・グループ変更時
* 共有再計算切替時
* メタデータ更新時

---

# 17. “DBで守る制約”と“アプリ/自動化で守る制約”の切り分け

## DBで守る（強く推奨）

* テナント境界のPK/FK（`(tenant_id, id)`）
* 一意制約（PrimaryQuote、PrimaryContactRole、PricebookEntryの複合一意）
* 基本Check（ステータス、範囲、日付前後）

## アプリ/Validationで守る（現実解）

* 多態参照の参照先存在（Who/What/LinkedEntity）
* 価格表整合（Opportunity.pricebook_id と PBE.pricebook_id の一致）
* ステージ遷移の必須項目（RequiredFields）
* 循環禁止（Account階層、Role、Territory）

> ただし「最後の砦」として、重要なものだけDBトリガを追加してもよい（v2で可）。

---

# 18. キャンペーン（Campaign）

キャンペーンはマーケティング活動の管理に使用。Lead/Contactの参加管理を行う。

## 18.1 campaigns

```sql
create table campaigns (
  tenant_id uuid not null,
  id uuid not null,
  owner_id uuid not null,

  name text not null,
  type text,  -- Email, Webinar, Trade Show 等
  status text not null default 'Planned',  -- Planned/Active/Completed/Aborted
  start_date date,
  end_date date,
  expected_revenue numeric(18,2),
  budgeted_cost numeric(18,2),
  actual_cost numeric(18,2),
  description text,
  parent_campaign_id uuid,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  foreign key (tenant_id, parent_campaign_id) references campaigns (tenant_id, id),
  check (status in ('Planned','Active','Completed','Aborted')),
  check (end_date is null or start_date is null or end_date >= start_date)
);

create index idx_campaigns_owner on campaigns (tenant_id, owner_id, is_deleted);
create index idx_campaigns_status on campaigns (tenant_id, status, is_deleted);
create index idx_campaigns_parent on campaigns (tenant_id, parent_campaign_id, is_deleted);
create index idx_campaigns_dates on campaigns (tenant_id, start_date, end_date) where is_deleted=false;
```

## 18.2 campaign_members（メンバー：Lead or Contact）

```sql
create table campaign_members (
  tenant_id uuid not null,
  id uuid not null,
  campaign_id uuid not null,

  -- 多態参照：Lead または Contact のどちらか一方
  member_type text not null,  -- 'Lead' | 'Contact'
  member_id uuid not null,

  status text not null default 'Sent',  -- Sent/Responded/Registered 等
  has_responded boolean not null default false,
  first_responded_date timestamptz,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  foreign key (tenant_id, campaign_id) references campaigns (tenant_id, id),
  check (member_type in ('Lead','Contact'))
);

-- 同一キャンペーンに同一メンバーは1回のみ
create unique index uq_campaign_members_unique
  on campaign_members (tenant_id, campaign_id, member_type, member_id)
  where is_deleted=false;

create index idx_campaign_members_campaign on campaign_members (tenant_id, campaign_id, is_deleted);
create index idx_campaign_members_member on campaign_members (tenant_id, member_type, member_id, is_deleted);
create index idx_campaign_members_responded on campaign_members (tenant_id, campaign_id, has_responded) where is_deleted=false;
```

> 多態参照のFKは張れないため、member_idの参照整合はアプリ層で担保。

---

# 19. 予測（Forecast）

売上予測の管理。期間定義、提出、スナップショットを管理する。

## 19.1 forecast_periods（予測期間）

```sql
create table forecast_periods (
  tenant_id uuid not null,
  id uuid not null,
  name text not null,  -- "2026-Q1", "2026-01" 等
  period_type text not null,  -- 'Monthly' | 'Quarterly' | 'Yearly'
  start_date date not null,
  end_date date not null,
  is_closed boolean not null default false,
  closed_at timestamptz,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  unique (tenant_id, name),
  check (period_type in ('Monthly','Quarterly','Yearly')),
  check (end_date >= start_date)
);

create index idx_forecast_periods_dates on forecast_periods (tenant_id, start_date, end_date) where is_deleted=false;
```

## 19.2 forecasts（予測本体：ユーザ×期間）

```sql
create table forecasts (
  tenant_id uuid not null,
  id uuid not null,
  owner_id uuid not null,  -- 予測対象ユーザ
  period_id uuid not null,
  forecast_category text not null,  -- 'Pipeline' | 'BestCase' | 'Commit' | 'Closed'

  amount numeric(18,2) not null default 0,
  quantity numeric(18,6),
  currency_iso_code text,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  foreign key (tenant_id, period_id) references forecast_periods (tenant_id, id),
  unique (tenant_id, owner_id, period_id, forecast_category),
  check (forecast_category in ('Pipeline','BestCase','Commit','Closed'))
);

create index idx_forecasts_owner_period on forecasts (tenant_id, owner_id, period_id, is_deleted);
create index idx_forecasts_period on forecasts (tenant_id, period_id, is_deleted);
```

## 19.3 forecast_items（予測明細：商談単位）

```sql
create table forecast_items (
  tenant_id uuid not null,
  id uuid not null,
  forecast_id uuid not null,
  opportunity_id uuid not null,

  amount numeric(18,2) not null,
  quantity numeric(18,6),
  forecast_category text not null,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  foreign key (tenant_id, forecast_id) references forecasts (tenant_id, id),
  foreign key (tenant_id, opportunity_id) references opportunities (tenant_id, id),
  unique (tenant_id, forecast_id, opportunity_id),
  check (forecast_category in ('Pipeline','BestCase','Commit','Closed'))
);

create index idx_forecast_items_forecast on forecast_items (tenant_id, forecast_id, is_deleted);
create index idx_forecast_items_opp on forecast_items (tenant_id, opportunity_id, is_deleted);
```

## 19.4 forecast_adjustments（予測調整）

```sql
create table forecast_adjustments (
  tenant_id uuid not null,
  id uuid not null,
  forecast_id uuid not null,
  adjusted_by uuid not null,
  adjustment_type text not null,  -- 'OwnerAdjustment' | 'ManagerAdjustment'

  original_amount numeric(18,2) not null,
  adjusted_amount numeric(18,2) not null,
  adjustment_reason text,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  foreign key (tenant_id, forecast_id) references forecasts (tenant_id, id),
  check (adjustment_type in ('OwnerAdjustment','ManagerAdjustment'))
);

create index idx_forecast_adj_forecast on forecast_adjustments (tenant_id, forecast_id, is_deleted);
```

## 19.5 quotas（売上目標）

```sql
create table quotas (
  tenant_id uuid not null,
  id uuid not null,
  owner_id uuid not null,  -- 目標対象ユーザ
  period_id uuid not null,

  quota_amount numeric(18,2) not null,
  currency_iso_code text,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  foreign key (tenant_id, period_id) references forecast_periods (tenant_id, id),
  unique (tenant_id, owner_id, period_id)
);

create index idx_quotas_owner on quotas (tenant_id, owner_id, is_deleted);
create index idx_quotas_period on quotas (tenant_id, period_id, is_deleted);
```

---

# 20. 権限主体の追加テーブル（Profile/PermissionSet）

## 20.1 profiles

```sql
create table profiles (
  tenant_id uuid not null,
  id uuid not null,
  name text not null,
  description text,
  is_system boolean not null default false,  -- システム標準プロファイル

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  unique (tenant_id, name)
);
```

## 20.2 permission_sets

```sql
create table permission_sets (
  tenant_id uuid not null,
  id uuid not null,
  name text not null,
  label text not null,
  description text,
  is_custom boolean not null default true,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  unique (tenant_id, name)
);
```

## 20.3 permission_set_assignments（ユーザへの割当）

```sql
create table permission_set_assignments (
  tenant_id uuid not null,
  id uuid not null,
  permission_set_id uuid not null,
  user_id uuid not null,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  foreign key (tenant_id, permission_set_id) references permission_sets (tenant_id, id),
  unique (tenant_id, permission_set_id, user_id)
);

create index idx_perm_set_assign_user on permission_set_assignments (tenant_id, user_id, is_deleted);
```

## 20.4 object_permissions（オブジェクト権限）

```sql
create table object_permissions (
  tenant_id uuid not null,
  id uuid not null,
  parent_type text not null,  -- 'Profile' | 'PermissionSet'
  parent_id uuid not null,
  object_name text not null,

  can_create boolean not null default false,
  can_read boolean not null default false,
  can_edit boolean not null default false,
  can_delete boolean not null default false,
  view_all boolean not null default false,
  modify_all boolean not null default false,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  unique (tenant_id, parent_type, parent_id, object_name),
  check (parent_type in ('Profile','PermissionSet'))
);

create index idx_obj_perm_parent on object_permissions (tenant_id, parent_type, parent_id, is_deleted);
```

## 20.5 field_permissions（フィールド権限）

```sql
create table field_permissions (
  tenant_id uuid not null,
  id uuid not null,
  parent_type text not null,  -- 'Profile' | 'PermissionSet'
  parent_id uuid not null,
  object_name text not null,
  field_name text not null,

  can_read boolean not null default false,
  can_edit boolean not null default false,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  unique (tenant_id, parent_type, parent_id, object_name, field_name),
  check (parent_type in ('Profile','PermissionSet'))
);

create index idx_field_perm_parent on field_permissions (tenant_id, parent_type, parent_id, is_deleted);
create index idx_field_perm_object on field_permissions (tenant_id, object_name, field_name, is_deleted);
```

---

# 21. Bulk API（大量データ操作）

大量レコードの一括操作をジョブとして管理。

## 21.1 bulk_jobs（バルクジョブ管理）

```sql
create table bulk_jobs (
  tenant_id uuid not null,
  id uuid not null,
  owner_id uuid not null,

  object_name text not null,
  operation text not null,  -- 'insert' | 'update' | 'upsert' | 'delete' | 'query'
  status text not null default 'Open',  -- Open/InProgress/Completed/Failed/Aborted

  content_type text not null default 'CSV',  -- CSV | JSON
  external_id_field text,  -- upsert時の外部ID項目

  total_records integer not null default 0,
  processed_records integer not null default 0,
  failed_records integer not null default 0,

  started_at timestamptz,
  completed_at timestamptz,
  api_version text,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  check (operation in ('insert','update','upsert','delete','query')),
  check (status in ('Open','InProgress','Completed','Failed','Aborted')),
  check (content_type in ('CSV','JSON'))
);

create index idx_bulk_jobs_owner on bulk_jobs (tenant_id, owner_id, is_deleted);
create index idx_bulk_jobs_status on bulk_jobs (tenant_id, status, created_at) where is_deleted=false;
```

## 21.2 bulk_job_batches（バルクバッチ）

```sql
create table bulk_job_batches (
  tenant_id uuid not null,
  id uuid not null,
  bulk_job_id uuid not null,

  batch_number integer not null,
  status text not null default 'Queued',  -- Queued/InProgress/Completed/Failed

  records_processed integer not null default 0,
  records_failed integer not null default 0,

  -- 入力データ（S3等への参照またはインライン）
  input_data_uri text,
  input_data jsonb,

  -- 結果データ
  result_data jsonb,  -- 成功/失敗レコードの詳細
  error_message text,

  started_at timestamptz,
  completed_at timestamptz,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  foreign key (tenant_id, bulk_job_id) references bulk_jobs (tenant_id, id),
  unique (tenant_id, bulk_job_id, batch_number),
  check (status in ('Queued','InProgress','Completed','Failed'))
);

create index idx_bulk_batches_job on bulk_job_batches (tenant_id, bulk_job_id, batch_number) where is_deleted=false;
```

---

# 22. イベント・Webhook（外部連携）

ドメインイベントの購読とOutboxパターンによる配信管理。

## 22.1 event_subscriptions（イベント購読）

```sql
create table event_subscriptions (
  tenant_id uuid not null,
  id uuid not null,
  subscription_name text not null,

  object_name text not null,  -- 対象オブジェクト
  event_types jsonb not null,  -- ['Created','Updated','Deleted'] 等

  target_url text not null,  -- Webhook送信先URL
  secret_hash text,  -- HMAC署名用シークレット（ハッシュ化）

  is_active boolean not null default true,

  -- 配信設定
  retry_policy jsonb,  -- { max_retries, backoff_multiplier }
  headers jsonb,  -- カスタムヘッダー

  -- 統計情報
  last_delivery_at timestamptz,
  last_delivery_status text,
  total_deliveries integer not null default 0,
  failed_deliveries integer not null default 0,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  unique (tenant_id, subscription_name)
);

create index idx_event_subs_object on event_subscriptions (tenant_id, object_name, is_active) where is_deleted=false;
```

## 22.2 outbox_events（Outboxパターン用）

イベント発行のためのOutboxテーブル。トランザクション内で書き込み、非同期で配信。

```sql
create table outbox_events (
  tenant_id uuid not null,
  id uuid not null,

  event_type text not null,  -- 'Account.Created', 'Opportunity.StageChanged' 等
  aggregate_type text not null,  -- 'Account', 'Opportunity' 等
  aggregate_id uuid not null,

  payload jsonb not null,  -- イベントペイロード
  metadata jsonb,  -- トレース情報等

  status text not null default 'Pending',  -- Pending/Published/Failed
  retry_count integer not null default 0,
  last_error text,

  created_at timestamptz not null default now(),
  published_at timestamptz,

  primary key (tenant_id, id),
  check (status in ('Pending','Published','Failed'))
) partition by range (created_at);

-- 月次パーティション作成例
-- create table outbox_events_2026_01 partition of outbox_events
--   for values from ('2026-01-01') to ('2026-02-01');

create index idx_outbox_pending on outbox_events (tenant_id, status, created_at) where status = 'Pending';
create index idx_outbox_aggregate on outbox_events (tenant_id, aggregate_type, aggregate_id, created_at);
```

> Outboxテーブルは定期的にポーリングまたはCDCで監視し、イベントバスへ配信。

---

# 23. レポート・ダッシュボード

レポート定義とダッシュボードの管理。

## 23.1 report_folders（フォルダ管理）

```sql
create table report_folders (
  tenant_id uuid not null,
  id uuid not null,
  name text not null,
  parent_folder_id uuid,

  access_type text not null default 'Hidden',  -- Hidden/ReadOnly/ReadWrite
  developer_name text,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  foreign key (tenant_id, parent_folder_id) references report_folders (tenant_id, id),
  unique (tenant_id, developer_name),
  check (access_type in ('Hidden','ReadOnly','ReadWrite'))
);

create index idx_report_folders_parent on report_folders (tenant_id, parent_folder_id) where is_deleted=false;
```

## 23.2 report_definitions（レポート定義）

```sql
create table report_definitions (
  tenant_id uuid not null,
  id uuid not null,
  owner_id uuid not null,

  name text not null,
  description text,
  folder_id uuid,
  developer_name text,

  report_type text not null default 'Tabular',  -- Tabular/Summary/Matrix/Joined
  base_object text not null,  -- 起点オブジェクト

  -- クエリ定義
  filters jsonb not null default '[]'::jsonb,  -- フィルタ条件
  columns jsonb not null default '[]'::jsonb,  -- 表示カラム
  group_by jsonb,  -- グルーピング（Summary/Matrix）
  measures jsonb,  -- 集計（SUM/COUNT/AVG等）
  sort_order jsonb,  -- ソート順

  -- 表示設定
  chart_type text,  -- Bar/Line/Pie/Funnel 等
  chart_config jsonb,

  -- 実行設定
  row_limit integer,
  scope text,  -- 'MyRecords' | 'MyTeamsRecords' | 'AllRecords'

  last_run_at timestamptz,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  foreign key (tenant_id, folder_id) references report_folders (tenant_id, id),
  unique (tenant_id, developer_name),
  check (report_type in ('Tabular','Summary','Matrix','Joined'))
);

create index idx_reports_folder on report_definitions (tenant_id, folder_id) where is_deleted=false;
create index idx_reports_owner on report_definitions (tenant_id, owner_id) where is_deleted=false;
create index idx_reports_base_object on report_definitions (tenant_id, base_object) where is_deleted=false;
```

## 23.3 dashboard_definitions（ダッシュボード定義）

```sql
create table dashboard_definitions (
  tenant_id uuid not null,
  id uuid not null,
  owner_id uuid not null,

  name text not null,
  description text,
  folder_id uuid,
  developer_name text,

  -- コンポーネント定義
  components jsonb not null default '[]'::jsonb,
  -- [{ component_id, report_id, chart_type, position: {row, col, width, height}, ... }]

  -- レイアウト設定
  column_count integer not null default 3,
  background_color text,

  -- 実行設定
  running_user_id uuid,  -- 特定ユーザとして実行（null=閲覧者）
  refresh_rate integer,  -- 自動更新間隔（分）

  last_refresh_at timestamptz,

  created_at timestamptz not null default now(),
  created_by uuid not null,
  updated_at timestamptz not null default now(),
  updated_by uuid not null,
  is_deleted boolean not null default false,
  system_modstamp timestamptz not null default now(),

  primary key (tenant_id, id),
  foreign key (tenant_id, folder_id) references report_folders (tenant_id, id),
  unique (tenant_id, developer_name)
);

create index idx_dashboards_folder on dashboard_definitions (tenant_id, folder_id) where is_deleted=false;
create index idx_dashboards_owner on dashboard_definitions (tenant_id, owner_id) where is_deleted=false;
```
