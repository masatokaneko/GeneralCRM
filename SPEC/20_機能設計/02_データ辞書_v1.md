# データ辞書 v1（Logical Data Dictionary）

## 0. データ辞書の読み方（共通フォーマット）

各フィールドに以下を定義します。

* **Type**：`id | string | text | bool | int | decimal | currency | percent | date | datetime | enum | json`
* **Req**：必須（Y/N）
* **Uniq**：一意制約（Y/N、または複合一意）
* **Def**：デフォルト値
* **Idx**：インデックス推奨（Y/N）
* **Hist**：フィールド履歴（Y/N：重要項目はY）
* **Rpt**：レポート/集計に利用（Y/N）
* **Rules / Notes**：制約・計算・入力規則・不変条件参照

---

## 0.1 全オブジェクト共通フィールド（必須）

> 以降に出てくる全ての「業務オブジェクト」に共通で持つ。

| Field          | Type     | Req | Uniq | Def    | Idx | Hist | Rpt | Rules / Notes              |
| -------------- | -------- | --: | ---: | ------ | --: | ---: | --: | -------------------------- |
| Id             | id       |   Y |    Y | 生成     |   Y |    N |   Y | ULID/UUIDなど              |
| TenantId       | id       |   Y | (複合) |        |   Y |    N |   N | 同一テナント参照（INV-T1） |
| OwnerId        | id       |   Y |    N | 作成者/割当 |   Y |    Y |   Y | Owner変更は重要イベント    |
| CreatedAt      | datetime |   Y |    N | now    |   Y |    N |   Y |                            |
| CreatedBy      | id       |   Y |    N |        |   Y |    N |   Y |                            |
| UpdatedAt      | datetime |   Y |    N | now    |   Y |    N |   Y |                            |
| UpdatedBy      | id       |   Y |    N |        |   Y |    N |   Y |                            |
| IsDeleted      | bool     |   Y |    N | false  |   Y |    N |   N | 論理削除（INV-T2）         |
| SystemModstamp | datetime |   Y |    N | now    |   Y |    N |   N | 楽観ロック用（R4）         |

---

# 1. コアCRM（取引先・人物・リード・商談）

## 1.1 Account（取引先）

| Field             | Type        | Req | Uniq | Def    | Idx | Hist | Rpt | Rules / Notes                   |
| ----------------- | ----------- | --: | ---: | ------ | --: | ---: | --: | ------------------------------- |
| Name              | string      |   Y |    N |        |   Y |    Y |   Y | 重複検知の主キー候補            |
| Type              | enum        |   N |    N |        |   Y |    Y |   Y | Prospect/Customer/Partner/Other |
| ParentId          | id          |   N |    N |        |   Y |    Y |   Y | 循環禁止（INV-A2）              |
| Industry          | string/enum |   N |    N |        |   Y |    N |   Y |                                 |
| Website           | string      |   N |    N |        |   N |    N |   N |                                 |
| Phone             | string      |   N |    N |        |   N |    N |   N |                                 |
| BillingAddress    | json        |   N |    N |        |   N |    N |   Y | 構造化住所                     |
| ShippingAddress   | json        |   N |    N |        |   N |    N |   Y |                                 |
| AnnualRevenue     | currency    |   N |    N |        |   N |    N |   Y |                                 |
| NumberOfEmployees | int         |   N |    N |        |   N |    N |   Y |                                 |
| Status            | enum        |   N |    N | Active |   Y |    Y |   Y | Active/Inactive                 |
| ExternalIds       | json        |   N |    N |        |   N |    N |   N | 外部ID群（任意）                |

**補助一意制約（推奨）**：`(TenantId, Name, BillingAddress.country, BillingAddress.city)` などを運用で調整可能

---

## 1.2 Contact（担当者）

| Field       | Type   | Req | Uniq | Def    | Idx | Hist | Rpt | Rules / Notes               |
| ----------- | ------ | --: | ---: | ------ | --: | ---: | --: | --------------------------- |
| AccountId   | id     |   Y |    N |        |   Y |    Y |   Y | 必須（INV-A1）              |
| LastName    | string |   Y |    N |        |   Y |    Y |   Y |                             |
| FirstName   | string |   N |    N |        |   Y |    N |   Y |                             |
| Email       | string |   N | (方針) |        |   Y |    Y |   Y | 一意性はテナント方針でON/OFF |
| Phone       | string |   N |    N |        |   N |    N |   N |                             |
| MobilePhone | string |   N |    N |        |   N |    N |   N |                             |
| Title       | string |   N |    N |        |   N |    N |   Y |                             |
| Department  | string |   N |    N |        |   N |    N |   Y |                             |
| Status      | enum   |   N |    N | Active |   Y |    Y |   Y | Active/Inactive             |
| ExternalIds | json   |   N |    N |        |   N |    N |   N |                             |

---

## 1.3 Lead（見込み客）

| Field                  | Type        | Req | Uniq | Def | Idx | Hist | Rpt | Rules / Notes                                          |
| ---------------------- | ----------- | --: | ---: | --- | --: | ---: | --: | ------------------------------------------------------ |
| Company                | string      |   Y |    N |     |   Y |    Y |   Y | 個人方針があるなら例外定義                              |
| LastName               | string      |   Y |    N |     |   Y |    Y |   Y |                                                        |
| FirstName              | string      |   N |    N |     |   Y |    N |   Y |                                                        |
| Email                  | string      |   N |    N |     |   Y |    Y |   Y |                                                        |
| Phone                  | string      |   N |    N |     |   N |    N |   N |                                                        |
| Status                 | enum        |   Y |    N | New |   Y |    Y |   Y | New/Working/Nurturing/Qualified/Disqualified/Converted |
| LeadSource             | enum/string |   N |    N |     |   Y |    N |   Y |                                                        |
| DisqualificationReason | enum/string |   N |    N |     |   N |    Y |   Y | Disqualified時は必須                                   |
| QualifiedAt            | datetime    |   N |    N |     |   N |    N |   N |                                                        |
| QualifiedBy            | id          |   N |    N |     |   N |    N |   N |                                                        |
| ConvertedAt            | datetime    |   N |    N |     |   Y |    N |   N | Converted時に設定                                      |
| ConvertedBy            | id          |   N |    N |     |   N |    N |   N |                                                        |
| ConvertedAccountId     | id          |   N |    N |     |   Y |    N |   N |                                                        |
| ConvertedContactId     | id          |   N |    N |     |   Y |    N |   N |                                                        |
| ConvertedOpportunityId | id          |   N |    N |     |   Y |    N |   N | 任意                                                 |
| ExternalIds            | json        |   N |    N |     |   N |    N |   N |                                                        |

---

## 1.4 Opportunity（商談）

| Field                | Type        |  Req | Uniq | Def   | Idx | Hist | Rpt | Rules / Notes               |
| -------------------- | ----------- | ---: | ---: | ----- | --: | ---: | --: | --------------------------- |
| AccountId            | id          |    Y |    N |       |   Y |    Y |   Y | INV-O1                      |
| Name                 | string      |    Y |    N |       |   Y |    Y |   Y |                             |
| StageName            | string/enum |    Y |    N | 初期  |   Y |    Y |   Y | ステージ定義に存在（INV-O2） |
| CloseDate            | date        |    Y |    N |       |   Y |    Y |   Y |                             |
| Amount               | currency    |    N |    N |       |   Y |    Y |   Y | 明細合計から算出する方針が推奨 |
| CurrencyIsoCode      | string      | (方針) |    N |       |   Y |    N |   Y | 複数通貨なら必須            |
| Probability          | percent     |    Y |    N |       |   Y |    Y |   Y | ステージ定義から更新        |
| ForecastCategoryName | enum        |    Y |    N |       |   Y |    Y |   Y | ステージ定義から更新        |
| IsClosed             | bool        |    Y |    N | false |   Y |    Y |   Y | INV-O3                      |
| IsWon                | bool        |    Y |    N | false |   Y |    Y |   Y | INV-O3                      |
| NextStep             | text        |    N |    N |       |   N |    N |   Y |                             |
| NextActionDate       | date        |    N |    N |       |   Y |    N |   Y | 未設定検知に使用            |
| Type                 | enum        |    N |    N |       |   Y |    N |   Y | New/Renewal/Expansion/Upsell/Downsell |
| LeadSource           | enum/string |    N |    N |       |   N |    N |   Y |                             |
| Competitors          | text/json   |    N |    N |       |   N |    N |   Y | ステージ依存必須化可          |
| Description          | text        |    N |    N |       |   N |    N |   N |                             |
| PricebookId          | id          |    N |    N |       |   Y |    Y |   Y | 明細がある場合は必須（INV-LI1） |
| PrimaryQuoteId       | id          |    N |    N |       |   Y |    Y |   Y | Primary Quote（INV-Q1）     |
| ContractId           | id          |    N |    N |       |   Y |    Y |   Y | 関連契約（Renewal/Upsell時） |
| SourceOpportunityId  | id          |    N |    N |       |   Y |    N |   Y | 元商談（Renewal時）          |
| ContractType         | enum        |    N |    N |       |   Y |    N |   Y | License/PoF/Service（明細から継承） |
| BillingFrequency     | enum        |    N |    N |       |   Y |    N |   Y | Monthly/Yearly/ThreeYear    |
| TermMonths           | int         |    N |    N |       |   Y |    N |   Y | 契約期間（月数）             |
| ClosedAt             | datetime    |    N |    N |       |   Y |    N |   N |                             |
| ClosedBy             | id          |    N |    N |       |   N |    N |   N |                             |
| LostReason           | enum/string |    N |    N |       |   N |    Y |   Y | Closed Lost時必須           |
| ExternalIds          | json        |    N |    N |       |   N |    N |   N |                             |

**補足**
* **Type**: Renewal=更新、Upsell=増額、Downsell=減額（既存契約の変更を伴う商談）
* **ContractId**: Type=Renewal/Upsell/Downsell の場合、関連する既存契約を指定
* **SourceOpportunityId**: 更新元の商談を追跡（履歴チェーン）
* **ContractType, BillingFrequency, TermMonths**: 明細から自動設定または手動指定

---

## 1.5 OpportunityStage（商談ステージ定義：メタデータ）

> これは“データ”ではなく“設定”だが、実装にはストアが必要なので辞書に含める。

| Field                   | Type    | Req | Uniq | Def   | Idx | Hist | Rpt | Rules / Notes                 |
| ----------------------- | ------- | --: | ---: | ----- | --: | ---: | --: | ----------------------------- |
| StageName               | string  |   Y |    Y |       |   Y |    N |   N | PK                            |
| IsActive                | bool    |   Y |    N | true  |   Y |    N |   N |                               |
| IsClosed                | bool    |   Y |    N | false |   Y |    N |   N |                               |
| IsWon                   | bool    |   Y |    N | false |   Y |    N |   N |                               |
| DefaultProbability      | percent |   Y |    N |       |   N |    N |   N | 0..100                        |
| DefaultForecastCategory | enum    |   Y |    N |       |   N |    N |   N | Pipeline/Best/Commit/Closed 等 |
| SortOrder               | int     |   Y |    N |       |   Y |    N |   N |                               |
| RequiredFields          | json    |   N |    N | []    |   N |    N |   N | ステージ遷移ガード（INV-O4）   |
| BlockedTransitions      | json    |   N |    N | []    |   N |    N |   N | 禁止遷移                      |
| OnEnterActions          | json    |   N |    N | []    |   N |    N |   N | 任意：自動化                  |
| OnExitActions           | json    |   N |    N | []    |   N |    N |   N | 任意                          |

---

## 1.6 OpportunityContactRole（商談関与者：中間）

| Field          | Type | Req | Uniq | Def   | Idx | Hist | Rpt | Rules / Notes                  |
| -------------- | ---- | --: | ---: | ----- | --: | ---: | --: | ------------------------------ |
| OpportunityId  | id   |   Y | (複合) |       |   Y |    N |   Y | (OpportunityId, ContactId)一意 |
| ContactId      | id   |   Y | (複合) |       |   Y |    N |   Y |                                |
| Role           | enum |   Y |    N |       |   Y |    N |   Y | DecisionMaker/Influencer/…     |
| IsPrimary      | bool |   Y |    N | false |   Y |    Y |   Y | 商談内で最大1（INV-O5）        |
| InfluenceLevel | int  |   N |    N |       |   N |    N |   Y | 1..5                           |
| Stance         | enum |   N |    N |       |   N |    N |   Y | Support/Neutral/Oppose         |

---

# 2. 活動（Task / Event / Logs）

## 2.1 Task（タスク）

| Field        | Type     | Req | Uniq | Def        | Idx | Hist | Rpt | Rules / Notes                            |
| ------------ | -------- | --: | ---: | ---------- | --: | ---: | --: | ---------------------------------------- |
| Subject      | string   |   Y |    N |            |   Y |    Y |   Y |                                          |
| Status       | enum     |   Y |    N | NotStarted |   Y |    Y |   Y | NotStarted/InProgress/Completed/Deferred |
| Priority     | enum     |   N |    N | Normal     |   Y |    N |   Y | Low/Normal/High                          |
| ActivityDate | date     |   N |    N |            |   Y |    N |   Y | 期日                                     |
| CompletedAt  | datetime |   N |    N |            |   Y |    N |   N | Completed時に設定                          |
| WhoType      | enum     |   N |    N |            |   Y |    N |   N | Lead/Contact（INV-ACT1）                 |
| WhoId        | id       |   N |    N |            |   Y |    N |   Y | 多態参照                                 |
| WhatType     | enum     |   N |    N |            |   Y |    N |   N | Account/Opportunity/…（INV-ACT2）        |
| WhatId       | id       |   N |    N |            |   Y |    N |   Y | 多態参照                                 |
| Description  | text     |   N |    N |            |   N |    N |   N |                                          |
| IsClosed     | bool     |   Y |    N | false      |   Y |    N |   Y | Statusから派生でも可                      |

## 2.2 Event（予定）

| Field         | Type     | Req | Uniq | Def   | Idx | Hist | Rpt | Rules / Notes            |
| ------------- | -------- | --: | ---: | ----- | --: | ---: | --: | ------------------------ |
| Subject       | string   |   Y |    N |       |   Y |    Y |   Y |                          |
| StartDateTime | datetime |   Y |    N |       |   Y |    N |   Y |                          |
| EndDateTime   | datetime |   Y |    N |       |   Y |    N |   Y | Start < End              |
| IsAllDayEvent | bool     |   Y |    N | false |   Y |    N |   Y |                          |
| Location      | string   |   N |    N |       |   N |    N |   N |                          |
| WhoType       | enum     |   N |    N |            |   Y |    N |   N | Lead/Contact（INV-ACT1） |
| WhoId         | id       |   N |    N |            |   Y |    N |   Y |                          |
| WhatType      | enum     |   N |    N |            |   Y |    N |   N | 活動対象集合（INV-ACT2） |
| WhatId        | id       |   N |    N |            |   Y |    N |   Y |                          |
| Description   | text     |   N |    N |       |   N |    N |   N |                          |

---

# 3. 施策（Campaign）

## 3.1 Campaign（施策）

| Field        | Type     | Req | Uniq | Def     | Idx | Hist | Rpt | Rules / Notes                        |
| ------------ | -------- | --: | ---: | ------- | --: | ---: | --: | ------------------------------------ |
| Name         | string   |   Y |    N |         |   Y |    Y |   Y |                                      |
| Type         | enum     |   N |    N |         |   Y |    N |   Y | Webinar/Ads/Email/Conf/Other         |
| Status       | enum     |   Y |    N | Planned |   Y |    Y |   Y | Planned/InProgress/Completed/Aborted |
| StartDate    | date     |   N |    N |         |   Y |    N |   Y |                                      |
| EndDate      | date     |   N |    N |         |   Y |    N |   Y | Start<=End                           |
| BudgetedCost | currency |   N |    N |         |   N |    N |   Y | 任意                                 |
| ActualCost   | currency |   N |    N |         |   N |    N |   Y | 任意                                 |

## 3.2 CampaignMember（施策反応）

| Field       | Type     | Req | Uniq | Def  | Idx | Hist | Rpt | Rules / Notes                          |
| ----------- | -------- | --: | ---: | ---- | --: | ---: | --: | -------------------------------------- |
| CampaignId  | id       |   Y | (複合) |      |   Y |    N |   Y | (CampaignId, MemberType, MemberId)一意 |
| MemberType  | enum     |   Y | (複合) |      |   Y |    N |   N | Lead/Contact                           |
| MemberId    | id       |   Y | (複合) |      |   Y |    N |   Y |                                        |
| Status      | enum     |   Y |    N | Sent |   Y |    Y |   Y | Sent/Responded/Attended/NoShow 等      |
| RespondedAt | datetime |   N |    N |      |   Y |    N |   Y | 任意                                   |

---

# 4. 商品・価格・明細・見積・受注

## 4.1 Product（商品）

| Field            | Type        | Req | Uniq | Def     | Idx | Hist | Rpt | Rules / Notes                     |
| ---------------- | ----------- | --: | ---: | ------- | --: | ---: | --: | --------------------------------- |
| Name             | string      |   Y |    N |         |   Y |    Y |   Y |                                   |
| ProductCode      | string      |   N | (方針) |         |   Y |    Y |   Y | 一意は運用でON/OFF                |
| Family           | string/enum |   N |    N |         |   Y |    N |   Y |                                   |
| ProductType      | enum        |   Y |    N | License |   Y |    Y |   Y | License/PoF/Service（INV-PROD1）  |
| BillingFrequency | enum        |   N |    N |         |   Y |    N |   Y | Monthly/Yearly/ThreeYear（PoF以外必須） |
| IsActive         | bool        |   Y |    N | true    |   Y |    Y |   Y |                                   |
| Description      | text        |   N |    N |         |   N |    N |   N |                                   |

**補足**
* **ProductType**: 商品の契約種別。License=ライセンス契約、PoF=Pool of Funds、Service=業務委託
* **BillingFrequency**: License契約時の請求頻度。PoF商品では契約時に個別設定するためnull許可

## 4.2 Pricebook（価格表）

| Field           | Type   |  Req | Uniq | Def   | Idx | Hist | Rpt | Rules / Notes    |
| --------------- | ------ | ---: | ---: | ----- | --: | ---: | --: | ---------------- |
| Name            | string |    Y |    N |       |   Y |    Y |   Y |                  |
| IsActive        | bool   |    Y |    N | true  |   Y |    Y |   Y |                  |
| IsStandard      | bool   |    Y |    N | false |   Y |    N |   Y | 標準価格表       |
| CurrencyIsoCode | string | (方針) |    N |       |   Y |    N |   Y | 複数通貨なら必須 |

## 4.3 PricebookEntry（価格表エントリ）

| Field              | Type     |  Req | Uniq | Def   | Idx | Hist | Rpt | Rules / Notes                          |
| ------------------ | -------- | ---: | ---: | ----- | --: | ---: | --: | -------------------------------------- |
| PricebookId        | id       |    Y | (複合) |       |   Y |    N |   Y | (PricebookId, ProductId)一意（INV-P1） |
| ProductId          | id       |    Y | (複合) |       |   Y |    N |   Y |                                        |
| UnitPrice          | currency |    Y |    N |       |   Y |    Y |   Y |                                        |
| MinQuantity        | decimal  |    N |    N | 1     |   N |    N |   Y | 最小購入数量                           |
| MaxQuantity        | decimal  |    N |    N |       |   N |    N |   Y | 最大購入数量（null=無制限）            |
| AllowCustomerPrice | bool     |    Y |    N | false |   N |    N |   N | 顧客別単価設定可否（PoF用）            |
| IsActive           | bool     |    Y |    N | true  |   Y |    Y |   Y |                                        |
| UseStandardPrice   | bool     |    Y |    N | false |   N |    N |   N | 任意                                   |
| CurrencyIsoCode    | string   | (方針) |    N |       |   Y |    N |   Y |                                        |

**補足**
* **AllowCustomerPrice**: trueの場合、ContractLineItemで顧客別単価（CustomerUnitPrice）の設定が可能

## 4.4 OpportunityLineItem（商談品目）

| Field            | Type             | Req | Uniq | Def | Idx | Hist | Rpt | Rules / Notes                        |
| ---------------- | ---------------- | --: | ---: | --- | --: | ---: | --: | ------------------------------------ |
| OpportunityId    | id               |   Y |    N |     |   Y |    N |   Y |                                      |
| PricebookEntryId | id               |   Y |    N |     |   Y |    N |   Y | 価格表整合（INV-LI1）                |
| Quantity         | decimal          |   Y |    N | 1   |   Y |    N |   Y | >0                                   |
| UnitPrice        | currency         |   Y |    N |     |   N |    Y |   Y | 初期値はEntry.UnitPrice              |
| TermMonths       | int              |   N |    N |     |   Y |    N |   Y | 契約期間（月数）（License/Service時） |
| BillingFrequency | enum             |   N |    N |     |   Y |    N |   Y | Monthly/Yearly/ThreeYear             |
| StartDate        | date             |   N |    N |     |   Y |    N |   Y | サービス開始日                       |
| EndDate          | date             |   N |    N |     |   Y |    N |   Y | サービス終了日（StartDate+Term-1日） |
| Discount         | percent/currency |   N |    N | 0   |   N |    N |   Y |                                      |
| TotalPrice       | currency         |   Y |    N | 計算  |   Y |    N |   Y | UnitPrice×Quantity×(Term/BillingPeriod)−Discount |
| Description      | text             |   N |    N |     |   N |    N |   N |                                      |

**必須制約（INV-LI1）**
* Opportunity.PricebookId が未設定なら作成不可
* PricebookEntry.PricebookId == Opportunity.PricebookId

**金額計算ロジック（INV-LI4）**
* License/Service: TotalPrice = UnitPrice × Quantity × (TermMonths / BillingPeriodMonths)
  - BillingPeriodMonths: Monthly=1, Yearly=12, ThreeYear=36
* PoF: TotalPrice = UnitPrice × Quantity（期間の概念なし、プール全体金額）

**終了日計算（INV-LI5）**
* EndDate = StartDate + TermMonths - 1日
  - 例: StartDate=2024/4/15, TermMonths=12 → EndDate=2025/4/14

## 4.5 Quote（見積）

| Field          | Type     | Req | Uniq | Def   | Idx | Hist | Rpt | Rules / Notes                             |
| -------------- | -------- | --: | ---: | ----- | --: | ---: | --: | ----------------------------------------- |
| OpportunityId  | id       |   Y |    N |       |   Y |    N |   Y |                                           |
| Name           | string   |   Y |    N |       |   Y |    Y |   Y |                                           |
| Status         | enum     |   Y |    N | Draft |   Y |    Y |   Y | Draft/Presented/Accepted/Rejected/Expired |
| IsPrimary      | bool     |   Y |    N | false |   Y |    Y |   Y | 商談内で最大1（INV-Q1）                   |
| PricebookId    | id       |   Y |    N |       |   Y |    Y |   Y | 明細整合（INV-LI2）                       |
| ExpirationDate | date     |   N |    N |       |   Y |    N |   Y | 期限切れ自動化                           |
| GrandTotal     | currency |   Y |    N | 計算    |   Y |    N |   Y | 明細合計                                 |
| PresentedAt    | datetime |   N |    N |       |   Y |    N |   N |                                           |
| AcceptedAt     | datetime |   N |    N |       |   Y |    N |   N |                                           |
| RejectedReason | text     |   N |    N |       |   N |    N |   N | 任意                                      |

## 4.6 QuoteLineItem（見積明細）

| Field            | Type             | Req | Uniq | Def | Idx | Hist | Rpt | Rules / Notes                                   |
| ---------------- | ---------------- | --: | ---: | --- | --: | ---: | --: | ----------------------------------------------- |
| QuoteId          | id               |   Y |    N |     |   Y |    N |   Y |                                                 |
| PricebookEntryId | id               |   Y |    N |     |   Y |    N |   Y | Entry.PricebookId == Quote.PricebookId（INV-LI2） |
| Quantity         | decimal          |   Y |    N | 1   |   Y |    N |   Y | >0                                              |
| UnitPrice        | currency         |   Y |    N |     |   N |    Y |   Y | 初期値はEntry.UnitPrice                         |
| TermMonths       | int              |   N |    N |     |   Y |    N |   Y | 契約期間（月数）（License/Service時）           |
| BillingFrequency | enum             |   N |    N |     |   Y |    N |   Y | Monthly/Yearly/ThreeYear                        |
| StartDate        | date             |   N |    N |     |   Y |    N |   Y | サービス開始日                                  |
| EndDate          | date             |   N |    N |     |   Y |    N |   Y | サービス終了日（StartDate+Term-1日）            |
| Discount         | percent/currency |   N |    N | 0   |   N |    N |   Y |                                                 |
| TotalPrice       | currency         |   Y |    N | 計算  |   Y |    N |   Y | INV-LI4, INV-LI5 参照                           |

## 4.7 Order（発注書）

> Order（発注書）は顧客からの正式な購入意思表示を記録し、売上計上のトリガーとなる。
> 1つのContractに複数のOrderが紐付く（新規、更新、追加発注）。

| Field           | Type     | Req | Uniq | Def   | Idx | Hist | Rpt | Rules / Notes                       |
| --------------- | -------- | --: | ---: | ----- | --: | ---: | --: | ----------------------------------- |
| AccountId       | id       |   Y |    N |       |   Y |    Y |   Y | INV-ORD1                            |
| OpportunityId   | id       |   N |    N |       |   Y |    N |   Y | 商談との紐付け（任意）              |
| ContractId      | id       |   N |    N |       |   Y |    Y |   Y | 関連契約（INV-ORD3）                |
| QuoteId         | id       |   N |    N |       |   Y |    N |   Y | 元見積                              |
| OrderType       | enum     |   Y |    N | New   |   Y |    Y |   Y | New/Renewal/Upsell/Downsell         |
| Status          | enum     |   Y |    N | Draft |   Y |    Y |   Y | Draft/Activated/Fulfilled/Cancelled |
| OrderDate       | date     |   Y |    N |       |   Y |    Y |   Y | 発注日（発注書受領日）              |
| EffectiveDate   | date     |   Y |    N |       |   Y |    Y |   Y | サービス開始日                      |
| EndDate         | date     |   N |    N |       |   Y |    N |   Y | サービス終了日                      |
| PricebookId     | id       |   N |    N |       |   Y |    N |   Y | 明細整合に利用（任意だが推奨）       |
| TotalAmount     | currency |   Y |    N | 計算    |   Y |    N |   Y | 明細合計                            |
| ActivatedAt     | datetime |   N |    N |       |   Y |    N |   N | 発注承認日時                        |
| ActivatedBy     | id       |   N |    N |       |   Y |    N |   N |                                     |
| CancelledReason | text     |   N |    N |       |   N |    N |   N | Cancelled時推奨                     |

**補足**
* **OrderType**: New=新規契約、Renewal=契約更新、Upsell=追加発注、Downsell=減額変更
* **ContractId**: Activated時にContractを新規作成または既存Contractを更新
* **OrderDate**: 売上計上日の基準日（発注書受領日）

## 4.8 OrderItem（発注明細）

| Field            | Type             | Req | Uniq | Def | Idx | Hist | Rpt | Rules / Notes                          |
| ---------------- | ---------------- | --: | ---: | --- | --: | ---: | --: | -------------------------------------- |
| OrderId          | id               |   Y |    N |     |   Y |    N |   Y |                                        |
| PricebookEntryId | id               |   Y |    N |     |   Y |    N |   Y | Order.PricebookIdがある場合は整合必須  |
| Quantity         | decimal          |   Y |    N | 1   |   Y |    N |   Y | >0                                     |
| UnitPrice        | currency         |   Y |    N |     |   N |    Y |   Y | 初期値はEntry.UnitPrice                |
| CustomerUnitPrice| currency         |   N |    N |     |   N |    Y |   Y | 顧客別単価（PoF用、Entry.AllowCustomerPrice=true時） |
| TermMonths       | int              |   N |    N |     |   Y |    N |   Y | 契約期間（月数）                       |
| BillingFrequency | enum             |   N |    N |     |   Y |    N |   Y | Monthly/Yearly/ThreeYear               |
| StartDate        | date             |   Y |    N |     |   Y |    N |   Y | サービス開始日                         |
| EndDate          | date             |   Y |    N |     |   Y |    N |   Y | サービス終了日（StartDate+Term-1日）   |
| Discount         | percent/currency |   N |    N | 0   |   N |    N |   Y |                                        |
| TotalPrice       | currency         |   Y |    N | 計算  |   Y |    N |   Y | INV-LI4 参照                           |

**補足**
* **CustomerUnitPrice**: PoF契約において顧客固有の単価を設定する場合に使用
  - 設定時は TotalPrice 計算でUnitPriceの代わりにCustomerUnitPriceを使用
  - PricebookEntry.AllowCustomerPrice = true の商品のみ設定可能

---

# 5. Forecast（予測）

## 5.1 Forecast（ヘッダ）

| Field             | Type     |  Req | Uniq | Def   | Idx | Hist | Rpt | Rules / Notes             |
| ----------------- | -------- | ---: | ---: | ----- | --: | ---: | --: | ------------------------- |
| PeriodType        | enum     |    Y | (複合) |       |   Y |    N |   Y | Week/Month/Quarter        |
| PeriodStart       | date     |    Y | (複合) |       |   Y |    N |   Y |                           |
| PeriodEnd         | date     |    Y |    N |       |   Y |    N |   Y |                           |
| ForecastOwnerType | enum     |    Y | (複合) |       |   Y |    N |   Y | User/Territory            |
| ForecastOwnerId   | id       |    Y | (複合) |       |   Y |    N |   Y | INV-F1（一意）            |
| Status            | enum     |    Y |    N | Draft |   Y |    Y |   Y | Draft/Submitted/Finalized |
| SubmittedAt       | datetime |    N |    N |       |   Y |    N |   N |                           |
| SubmittedBy       | id       |    N |    N |       |   Y |    N |   N |                           |
| CurrencyIsoCode   | string   | (方針) |    N |       |   Y |    N |   Y |                           |
| BaseAmount        | currency |    Y |    N | 計算    |   Y |    N |   Y | 商談集計                  |
| AdjustmentAmount  | currency |    Y |    N | 0     |   Y |    Y |   Y | 調整合計                  |
| FinalAmount       | currency |    Y |    N | 計算    |   Y |    N |   Y | Base + Adjustment         |

## 5.2 ForecastItem（カテゴリ別集計）

| Field      | Type     | Req | Uniq | Def | Idx | Hist | Rpt | Rules / Notes                 |
| ---------- | -------- | --: | ---: | --- | --: | ---: | --: | ----------------------------- |
| ForecastId | id       |   Y | (複合) |     |   Y |    N |   Y | (ForecastId, Category)一意    |
| Category   | enum     |   Y | (複合) |     |   Y |    N |   Y | Pipeline/Best/Commit/Closed 等 |
| Amount     | currency |   Y |    N | 計算  |   Y |    N |   Y | 商談から算出                  |

## 5.3 ForecastAdjustment（調整履歴）

| Field       | Type     | Req | Uniq | Def | Idx | Hist | Rpt | Rules / Notes |
| ----------- | -------- | --: | ---: | --- | --: | ---: | --: | ------------- |
| ForecastId  | id       |   Y |    N |     |   Y |    N |   Y |               |
| AdjustedBy  | id       |   Y |    N |     |   Y |    N |   Y |               |
| AdjustedAt  | datetime |   Y |    N | now |   Y |    N |   Y |               |
| AmountDelta | currency |   Y |    N |     |   Y |    N |   Y | 追記のみ（INV-F2） |
| Reason      | text     |   N |    N |     |   N |    N |   N |               |

---

# 6. Territory（テリトリ）

## 6.1 TerritoryModel

| Field       | Type     | Req | Uniq | Def      | Idx | Hist | Rpt | Rules / Notes            |
| ----------- | -------- | --: | ---: | -------- | --: | ---: | --: | ------------------------ |
| Name        | string   |   Y |    N |          |   Y |    Y |   Y |                          |
| Status      | enum     |   Y |    N | Planning |   Y |    Y |   Y | Planning/Active/Archived |
| ActivatedAt | datetime |   N |    N |          |   Y |    N |   N |                          |
| ActivatedBy | id       |   N |    N |          |   Y |    N |   N | Activeは同時に1（INV-TERR2推奨） |

## 6.2 TerritoryType

| Field | Type   | Req | Uniq | Def | Idx | Hist | Rpt | Notes             |
| ----- | ------ | --: | ---: | --- | --: | ---: | --: | ----------------- |
| Name  | string |   Y |    Y |     |   Y |    N |   Y | 例：Region/Industry |

## 6.3 Territory

| Field             | Type   | Req | Uniq | Def  | Idx | Hist | Rpt | Rules / Notes     |
| ----------------- | ------ | --: | ---: | ---- | --: | ---: | --: | ----------------- |
| TerritoryModelId  | id     |   Y |    N |      |   Y |    N |   Y |                   |
| TerritoryTypeId   | id     |   Y |    N |      |   Y |    N |   Y |                   |
| Name              | string |   Y |    N |      |   Y |    Y |   Y |                   |
| ParentTerritoryId | id     |   N |    N |      |   Y |    Y |   Y | 循環禁止（INV-TERR1） |
| IsActive          | bool   |   Y |    N | true |   Y |    N |   Y |                   |

## 6.4 UserTerritoryAssignment

| Field            | Type | Req | Uniq | Def   | Idx | Hist | Rpt | Notes                     |
| ---------------- | ---- | --: | ---: | ----- | --: | ---: | --: | ------------------------- |
| UserId           | id   |   Y | (複合) |       |   Y |    N |   Y | (UserId, TerritoryId)一意 |
| TerritoryId      | id   |   Y | (複合) |       |   Y |    N |   Y |                           |
| IsPrimary        | bool |   Y |    N | false |   Y |    Y |   Y | 主担当はユーザ内で最大1（運用） |
| AssignmentMethod | enum |   Y |    N | Rule  |   Y |    N |   Y | Rule/Manual               |

## 6.5 AccountTerritoryAssignment

| Field            | Type | Req | Uniq | Def  | Idx | Hist | Rpt | Notes                        |
| ---------------- | ---- | --: | ---: | ---- | --: | ---: | --: | ---------------------------- |
| AccountId        | id   |   Y | (複合) |      |   Y |    N |   Y | (AccountId, TerritoryId)一意 |
| TerritoryId      | id   |   Y | (複合) |      |   Y |    N |   Y |                              |
| AssignmentMethod | enum |   Y |    N | Rule |   Y |    N |   Y | Rule/Manual                  |

## 6.6 TerritoryRule（割当ルール定義：メタデータ）

| Field              | Type | Req | Notes        |
| ------------------ | ---- | --: | ------------ |
| TerritoryModelId   | id   |   Y |              |
| TargetType         | enum |   Y | Account/User |
| CriteriaExpression | json |   Y | 条件式AST     |
| TerritoryId        | id   |   Y | 割当先        |
| Priority           | int  |   Y | 評価順序     |
| IsActive           | bool |   Y |              |

## 6.7 TerritoryAssignmentChange（割当変更ログ）

| Field            | Type     | Req | Idx | Notes            |
| ---------------- | -------- | --: | --: | ---------------- |
| TerritoryModelId | id       |   Y |   Y |                  |
| TargetType       | enum     |   Y |   Y | Account/User     |
| TargetId         | id       |   Y |   Y | AccountId/UserId |
| TerritoryId      | id       |   Y |   Y |                  |
| ChangeType       | enum     |   Y |   Y | Add/Remove       |
| ChangedAt        | datetime |   Y |   Y |                  |
| ChangedBy        | id       |   Y |   Y |                  |
| Reason           | text     |   N |   N |                  |

---

# 7. 添付（Content）

## 7.1 ContentDocument（論理ファイル）

| Field           | Type   | Req | Uniq | Idx | Notes         |
| --------------- | ------ | --: | ---: | --: | ------------- |
| Title           | string |   Y |    N |   Y |               |
| FileType        | string |   Y |    N |   Y | pdf/docx/png等 |
| LatestVersionId | id     |   Y |    N |   Y |               |
| OwnerId         | id     |   Y |    N |   Y |               |

## 7.2 ContentVersion（版）

| Field             | Type        | Req | Idx | Notes                            |
| ----------------- | ----------- | --: | --: | -------------------------------- |
| ContentDocumentId | id          |   Y |   Y |                                  |
| VersionNumber     | int         |   Y |   Y | 1..                              |
| BlobRef           | string      |   Y |   N | 実体はオブジェクトストレージ参照 |
| SizeBytes         | int         |   Y |   Y |                                  |
| CreatedAt/By      | datetime/id |   Y |   Y |                                  |

## 7.3 ContentDocumentLink（紐付け：多態参照）

| Field             | Type | Req | Idx | Notes                 |
| ----------------- | ---- | --: | --: | --------------------- |
| ContentDocumentId | id   |   Y |   Y |                       |
| LinkedEntityType  | enum |   Y |   Y | 任意の業務オブジェクト |
| LinkedEntityId    | id   |   Y |   Y | 多態参照              |
| ShareType         | enum |   Y |   Y | Viewer/Collaborator 等 |

---

# 8. 共有（Sharing）— “仕組み”を実装するための辞書

## 8.1 OWDSetting（オブジェクト別デフォルト公開範囲）

| Field         | Type   | Req | Uniq | Notes                                  |
| ------------- | ------ | --: | ---: | -------------------------------------- |
| ObjectName    | string |   Y |    Y | Account/Opportunity…                   |
| DefaultAccess | enum   |   Y |    N | Private/PublicReadOnly/PublicReadWrite |

## 8.2 ShareRule（共有ルール定義：メタデータ）

| Field              | Type   | Req | Notes                     |
| ------------------ | ------ | --: | ------------------------- |
| ObjectName         | string |   Y | 対象オブジェクト          |
| CriteriaExpression | json   |   Y | 条件式AST                 |
| TargetSubjectType  | enum   |   Y | Role/Group/User/Territory |
| TargetSubjectId    | id     |   Y |                           |
| AccessLevel        | enum   |   Y | Read/Write                |
| IsActive           | bool   |   Y |                           |

## 8.3 ObjectShare（共有行：具象は AccountShare 等）

| Field        | Type        | Req | Idx | Notes                            |
| ------------ | ----------- | --: | --: | -------------------------------- |
| ObjectName   | string      |   Y |   Y | 具象テーブルでも可                |
| RecordId     | id          |   Y |   Y | 共有対象                         |
| SubjectType  | enum        |   Y |   Y | User/Role/Group/Territory/Team   |
| SubjectId    | id          |   Y |   Y |                                  |
| AccessLevel  | enum        |   Y |   Y | Read/Write                       |
| RowCause     | enum        |   Y |   Y | Owner/Rule/Manual/Team/Territory |
| CreatedAt/By | datetime/id |   Y |   Y |                                  |

---

# 9. チーム（TeamMember）

## 9.1 AccountTeamMember（取引先チームメンバー）

| Field       | Type | Req | Uniq | Idx | Hist | Rpt | Rules / Notes                   |
| ----------- | ---- | --: | ---: | --: | ---: | --: | ------------------------------- |
| AccountId   | id   |   Y | (複合) |   Y |    Y |   Y | (AccountId, UserId) 一意        |
| UserId      | id   |   Y | (複合) |   Y |    Y |   Y |                                 |
| TeamMemberRole | enum |   N |    N |   Y |    Y |   Y | Account Manager / Sales Rep / ... |
| AccountAccessLevel | enum |   Y |    N |   Y |    Y |   Y | Read/Edit/All（共有へ反映）     |
| ContactAccessLevel | enum |   Y |    N |   Y |    Y |   Y | Read/Edit/All                   |
| CaseAccessLevel    | enum |   Y |    N |   Y |    Y |   Y | Read/Edit/All                   |
| OpportunityAccessLevel | enum |   Y |    N |   Y |    Y |   Y | Read/Edit/All                   |

## 9.2 OpportunityTeamMember（商談チームメンバー）

| Field       | Type | Req | Uniq | Idx | Hist | Rpt | Rules / Notes                   |
| ----------- | ---- | --: | ---: | --: | ---: | --: | ------------------------------- |
| OpportunityId | id |   Y | (複合) |   Y |    Y |   Y | (OpportunityId, UserId) 一意     |
| UserId      | id   |   Y | (複合) |   Y |    Y |   Y |                                 |
| TeamMemberRole| enum |   N |    N |   Y |    Y |   Y | Sales Rep / SE / Exec Sponsor ... |
| OpportunityAccessLevel | enum |   Y |    N |   Y |    Y |   Y | Read/Edit/All（共有へ反映）     |

---

# 10. 予測管理（Forecasting）

## 10.1 ForecastPeriod（予測期間）

| Field            | Type     | Req | Uniq | Def | Idx | Hist | Rpt | Rules / Notes                  |
| ---------------- | -------- | --: | ---: | --- | --: | ---: | --: | ------------------------------ |
| Name             | string   |   Y |   Y |     |   Y |    N |   Y | "Q1 FY2024", "January 2024"等  |
| PeriodType       | enum     |   Y |   N |     |   Y |    N |   Y | Monthly/Quarterly/Annual       |
| StartDate        | date     |   Y |   N |     |   Y |    N |   Y | 期間重複チェック（INV-F1）      |
| EndDate          | date     |   Y |   N |     |   Y |    N |   Y | StartDate < EndDate            |
| FiscalYear       | int      |   Y |   N |     |   Y |    N |   Y |                                |
| FiscalQuarter    | int      |   N |   N |     |   Y |    N |   Y | 1-4（Quarterlyの場合）         |
| FiscalMonth      | int      |   N |   N |     |   Y |    N |   Y | 1-12（Monthlyの場合）          |
| Status           | enum     |   Y |   N | Open |  Y |    Y |   Y | Open/Closed/Locked             |
| SubmissionDueDate| datetime |   N |   N |     |   Y |    N |   Y |                                |
| ApprovalDueDate  | datetime |   N |   N |     |   Y |    N |   Y |                                |

## 10.2 Forecast（予測）

| Field              | Type        | Req | Uniq | Def     | Idx | Hist | Rpt | Rules / Notes                    |
| ------------------ | ----------- | --: | ---: | ------- | --: | ---: | --: | -------------------------------- |
| ForecastPeriodId   | id          |   Y |    N |         |   Y |    N |   Y | ForecastPeriod参照               |
| ManagerId          | id          |   N |    N |         |   Y |    Y |   Y | 承認者（Role階層）               |
| PipelineAmount     | currency    |   Y |    N | 0       |   Y |    Y |   Y | 0-30% Probability案件合計        |
| BestCaseAmount     | currency    |   Y |    N | 0       |   Y |    Y |   Y | 31-70% Probability案件合計       |
| CommitAmount       | currency    |   Y |    N | 0       |   Y |    Y |   Y | 71-99% Probability案件合計       |
| ClosedAmount       | currency    |   Y |    N | 0       |   Y |    Y |   Y | 100% Probability案件合計         |
| AdjustmentAmount   | currency    |   Y |    N | 0       |   Y |    Y |   Y | マネージャー調整値               |
| TotalForecastAmount| currency    |   Y |    N | (計算)  |   Y |    N |   Y | 上記合計（計算項目）             |
| Status             | enum        |   Y |    N | Open    |   Y |    Y |   Y | Open/Submitted/Approved/Revised/Locked |
| SubmittedDate      | datetime    |   N |    N |         |   Y |    Y |   Y |                                  |
| ApprovedDate       | datetime    |   N |    N |         |   Y |    Y |   Y |                                  |
| RevisionReason     | text        |   N |    N |         |   N |    Y |   N |                                  |
| ManagerNotes       | text        |   N |    N |         |   N |    N |   N |                                  |
| OpportunityCount   | int         |   Y |    N | 0       |   Y |    N |   Y | 積上げ対象商談数                 |
| LastCalculatedDate | datetime    |   N |    N |         |   Y |    N |   N | 最終積上げ計算日時               |
| SourceOpportunityIds | json      |   N |    N |         |   N |    N |   N | 積上げ対象商談IDリスト          |

## 10.3 ForecastItem（予測明細）

| Field               | Type        | Req | Uniq | Def | Idx | Hist | Rpt | Rules / Notes                 |
| ------------------- | ----------- | --: | ---: | --- | --: | ---: | --: | ----------------------------- |
| ForecastId          | id          |   Y |    N |     |   Y |    N |   Y | Forecast参照                  |
| OpportunityId       | id          |   Y |    N |     |   Y |    N |   Y | Opportunity参照（INV-F2）     |
| Amount              | currency    |   Y |    N |     |   Y |    N |   Y | スナップショット時点の金額     |
| Probability         | int         |   Y |    N |     |   Y |    N |   Y | 0-100%                        |
| CloseDate           | date        |   Y |    N |     |   Y |    N |   Y | スナップショット時点のCloseDate|
| ForecastCategory    | enum        |   Y |    N |     |   Y |    N |   Y | Pipeline/BestCase/Commit/Closed/Omitted |
| StageName           | string      |   Y |    N |     |   Y |    N |   Y | スナップショット時点のStage   |
| SnapshotDate        | datetime    |   Y |    N |     |   Y |    N |   Y | いつの時点での値か            |
| AdjustmentAmount    | currency    |   Y |    N | 0   |   Y |    Y |   Y | 個別調整値                    |
| AdjustmentReason    | text        |   N |    N |     |   N |    Y |   N |                               |
| AdjustedBy          | id          |   N |    N |     |   Y |    Y |   Y |                               |
| AdjustmentDate      | datetime    |   N |    N |     |   Y |    Y |   Y |                               |

## 10.4 Quota（目標・クォータ）

| Field               | Type        | Req | Uniq | Def | Idx | Hist | Rpt | Rules / Notes                 |
| ------------------- | ----------- | --: | ---: | --- | --: | ---: | --: | ----------------------------- |
| QuotaName           | string      |   Y |    N |     |   Y |    N |   Y |                               |
| Description         | text        |   N |    N |     |   N |    N |   N |                               |
| FiscalYear          | int         |   Y |    N |     |   Y |    N |   Y |                               |
| FiscalQuarter       | int         |   N |    N |     |   Y |    N |   Y | 1-4（四半期目標の場合）       |
| FiscalMonth         | int         |   N |    N |     |   Y |    N |   Y | 1-12（月次目標の場合）        |
| QuotaAmount         | currency    |   Y |    N |     |   Y |    Y |   Y |                               |
| CurrencyIsoCode     | string      |   Y |    N | USD |   Y |    N |   Y |                               |
| StartDate           | date        |   Y |    N |     |   Y |    N |   Y |                               |
| EndDate             | date        |   Y |    N |     |   Y |    N |   Y |                               |
| ActualRevenue       | currency    |   Y |    N | 0   |   Y |    N |   Y | 実績売上（計算項目）          |
| ForecastRevenue     | currency    |   Y |    N | 0   |   Y |    N |   Y | 予測売上（計算項目）          |
| AttainmentPercentage| percent     |   Y |    N | (計算)|  Y |    N |   Y | 達成率（計算項目）            |
| LastCalculatedDate  | datetime    |   N |    N |     |   Y |    N |   N |                               |
| ParentQuotaId       | id          |   N |    N |     |   Y |    N |   Y | ロール階層での親Quota        |
| IsRollupCalculated  | bool        |   Y |    N | false| N |    N |   N | 積上げ計算対象フラグ          |
| IsActive            | bool        |   Y |    N | true|   Y |    N |   Y |                               |

---

# 11. 完全テリトリ管理（Enhanced Territory Management）

## 11.1 Territory（テリトリ）

| Field               | Type        | Req | Uniq | Def     | Idx | Hist | Rpt | Rules / Notes                 |
| ------------------- | ----------- | --: | ---: | ------- | --: | ---: | --: | ----------------------------- |
| Name                | string      |   Y |    Y |         |   Y |    Y |   Y |                               |
| DeveloperName       | string      |   Y |    Y |         |   Y |    N |   Y | API名（英数字、アンダースコア）|
| Description         | text        |   N |    N |         |   N |    N |   N |                               |
| ParentTerritoryId   | id          |   N |    N |         |   Y |    Y |   Y | 循環禁止（INV-T1）            |
| TerritoryLevel      | int         |   Y |    N | 1       |   Y |    N |   Y | 階層レベル（計算項目）        |
| ForecastEnabled     | bool        |   Y |    N | true    |   Y |    N |   Y |                               |
| AccessLevel         | enum        |   Y |    N | Private |   Y |    Y |   Y | Private/Public                |
| DefaultAccessLevel  | enum        |   Y |    N | Read    |   Y |    Y |   Y | Read/Edit/All                 |
| AccountCount        | int         |   Y |    N | 0       |   Y |    N |   Y | 割当Account数（計算項目）     |
| OpportunityCount    | int         |   Y |    N | 0       |   Y |    N |   Y | 関連Opportunity数（計算項目） |
| TotalRevenue        | currency    |   Y |    N | 0       |   Y |    N |   Y | 総売上（計算項目）            |
| ForecastRevenue     | currency    |   Y |    N | 0       |   Y |    N |   Y | 予測売上（計算項目）          |
| LastCalculatedDate  | datetime    |   N |    N |         |   Y |    N |   N | 統計最終計算日時              |
| IsActive            | bool        |   Y |    N | true    |   Y |    Y |   Y |                               |

## 11.2 TerritoryRule（テリトリルール）

| Field               | Type        | Req | Uniq | Def   | Idx | Hist | Rpt | Rules / Notes                    |
| ------------------- | ----------- | --: | ---: | ----- | --: | ---: | --: | -------------------------------- |
| TerritoryId         | id          |   Y |    N |       |   Y |    N |   Y | Territory参照                    |
| RuleName            | string      |   Y |    N |       |   Y |    N |   Y |                                  |
| Description         | text        |   N |    N |       |   N |    N |   N |                                  |
| IsActive            | bool        |   Y |    N | true  |   Y |    Y |   Y |                                  |
| Priority            | int         |   Y |    N |       |   Y |    N |   Y | 評価順序（小さい値が優先）      |
| BooleanFilter       | string      |   N |    N |       |   N |    N |   N | "1 AND 2 OR 3"等                |
| FilterCriteria      | json        |   Y |    N |       |   N |    N |   N | 条件配列（INV-T4構文チェック）   |
| LastRunDate         | datetime    |   N |    N |       |   Y |    N |   N |                                  |
| NextRunDate         | datetime    |   N |    N |       |   Y |    N |   N |                                  |
| ProcessedRecords    | int         |   Y |    N | 0     |   Y |    N |   Y | 最終実行での処理レコード数       |
| SuccessfulAssignments| int        |   Y |    N | 0     |   Y |    N |   Y | 最終実行での成功割当数          |

## 11.3 TerritoryAssignment（テリトリ割当）

| Field               | Type        | Req | Uniq | Def       | Idx | Hist | Rpt | Rules / Notes                 |
| ------------------- | ----------- | --: | ---: | --------- | --: | ---: | --: | ----------------------------- |
| AccountId           | id          |   Y | (複合) |          |   Y |    Y |   Y | (AccountId)一意（Active時）   |
| TerritoryId         | id          |   Y |    N |          |   Y |    Y |   Y | Territory参照                 |
| AssignmentRuleId    | id          |   N |    N |          |   Y |    N |   Y | TerritoryRule参照（自動時）   |
| AssignmentType      | enum        |   Y |    N | Automatic|   Y |    Y |   Y | Automatic/Manual              |
| AssignedDate        | datetime    |   Y |    N | now      |   Y |    Y |   Y |                               |
| AssignedById        | id          |   Y |    N |          |   Y |    Y |   Y |                               |
| ReasonCode          | enum        |   N |    N |          |   Y |    N |   Y | 割当理由分類                  |
| ReasonDescription   | text        |   N |    N |          |   N |    Y |   N |                               |
| EffectiveDate       | date        |   Y |    N | today    |   Y |    N |   Y |                               |
| EndDate             | date        |   N |    N |          |   Y |    Y |   Y |                               |
| IsActive            | bool        |   Y |    N | true     |   Y |    Y |   Y |                               |

## 11.4 TerritoryMember（テリトリメンバー）

| Field               | Type        | Req | Uniq | Def     | Idx | Hist | Rpt | Rules / Notes                    |
| ------------------- | ----------- | --: | ---: | ------- | --: | ---: | --: | -------------------------------- |
| TerritoryId         | id          |   Y | (複合) |        |   Y |    Y |   Y | (TerritoryId, UserId)一意        |
| UserId              | id          |   Y | (複合) |        |   Y |    Y |   Y | User参照                         |
| Role                | enum        |   Y |    N | Member  |   Y |    Y |   Y | Owner/Manager/Member/Viewer      |
| AccessLevel         | enum        |   Y |    N | Read    |   Y |    Y |   Y | Read/Edit/All                    |
| StartDate           | date        |   Y |    N | today   |   Y |    N |   Y |                                  |
| EndDate             | date        |   N |    N |         |   Y |    Y |   Y |                                  |
| IsActive            | bool        |   Y |    N | true    |   Y |    Y |   Y |                                  |

---

# 12. 「追加項目（Custom Field）」の定義ルール

## 12.1 FieldDefinition（メタデータ）

| Field            | Type   | Req | Notes                                                           |
| ---------------- | ------ | --: | --------------------------------------------------------------- |
| ObjectName       | string |   Y | 対象オブジェクト                                                |
| ApiName          | string |   Y | 一意                                                            |
| Label            | string |   Y | 表示名                                                          |
| DataType         | enum   |   Y | string/text/int/decimal/currency/date/datetime/bool/enum/lookup |
| IsRequired       | bool   |   Y |                                                                 |
| DefaultValue     | json   |   N |                                                                 |
| EnumValues       | json   |   N | enumの場合                                                      |
| LookupTarget     | string |   N | lookupの場合                                                    |
| IsIndexed        | bool   |   Y |                                                                 |
| IsReportable     | bool   |   Y |                                                                 |
| IsHistoryTracked | bool   |   Y |                                                                 |

## 12.2 CustomFieldValue（値）

> 実装方式は **(A) JSONB** または **(B) 型別EAV** を選ぶ。どちらでも「FieldDefinitionに従って検証・検索・レポート」を保証する。

---

# 13. 契約・請求（Contract / Invoice）

> サブスクリプション型ビジネスにおける契約管理と請求処理のためのエンティティ群。
> Order（発注書）→ Contract（契約）→ Invoice（請求書）の流れで売上計上を管理する。

## 13.1 Contract（契約）

> Contract（契約）は顧客との継続的な取引関係を表す。
> 1つの契約に複数のOrderが紐付き、更新・追加発注により契約期間や金額が変更される。

| Field               | Type        | Req | Uniq | Def      | Idx | Hist | Rpt | Rules / Notes                          |
| ------------------- | ----------- | --: | ---: | -------- | --: | ---: | --: | -------------------------------------- |
| AccountId           | id          |   Y |    N |          |   Y |    Y |   Y | 契約先企業（INV-CON1）                 |
| ContractNumber      | string      |   Y |    Y |          |   Y |    Y |   Y | 契約番号（自動採番推奨）               |
| Name                | string      |   Y |    N |          |   Y |    Y |   Y | 契約名                                 |
| ContractType        | enum        |   Y |    N |          |   Y |    Y |   Y | License/PoF/Service（INV-CON2）        |
| Status              | enum        |   Y |    N | Draft    |   Y |    Y |   Y | Draft/InApproval/Activated/Expired/Terminated |
| StartDate           | date        |   Y |    N |          |   Y |    Y |   Y | 契約開始日                             |
| EndDate             | date        |   Y |    N |          |   Y |    Y |   Y | 契約終了日（StartDate+Term-1日）       |
| TermMonths          | int         |   Y |    N |          |   Y |    N |   Y | 契約期間（月数）                       |
| BillingFrequency    | enum        |   N |    N |          |   Y |    N |   Y | Monthly/Yearly/ThreeYear（License時）  |
| TotalContractValue  | currency    |   Y |    N | 計算      |   Y |    Y |   Y | 契約総額（明細合計）（TCV）            |
| RemainingValue      | currency    |   Y |    N | 計算      |   Y |    N |   Y | 残額（PoF: TCV - 消費済み）            |
| AutoRenewal         | bool        |   Y |    N | false    |   Y |    N |   Y | 自動更新フラグ                         |
| RenewalTermMonths   | int         |   N |    N |          |   N |    N |   Y | 自動更新時の期間                       |
| RenewalNoticeDate   | date        |   N |    N |          |   Y |    N |   Y | 更新通知日                             |
| ActivatedAt         | datetime    |   N |    N |          |   Y |    Y |   N |                                        |
| ActivatedBy         | id          |   N |    N |          |   Y |    N |   N |                                        |
| TerminatedAt        | datetime    |   N |    N |          |   Y |    Y |   N | Terminated時に設定                     |
| TerminationReason   | text        |   N |    N |          |   N |    Y |   N | Terminated時推奨                       |
| PrimaryOrderId      | id          |   N |    N |          |   Y |    N |   Y | 初回発注書                             |
| SourceContractId    | id          |   N |    N |          |   Y |    N |   Y | 更新元契約（履歴チェーン）             |
| ExternalIds         | json        |   N |    N |          |   N |    N |   N |                                        |

**補足**
* **ContractType**: License=ライセンス契約（定額）、PoF=Pool of Funds（従量）、Service=業務委託
* **Status**: Draft→InApproval→Activated→Expired/Terminated
* **RemainingValue**: PoF契約では消費に応じて減算、License/Serviceでは0

**不変条件**
* **INV-CON1**: Contract.AccountIdは必須
* **INV-CON2**: ContractTypeはContractLineItem追加時に自動設定（最初の明細のProductTypeから継承）
* **INV-CON3**: Contract.EndDate = Contract.StartDate + TermMonths - 1日

---

## 13.2 ContractLineItem（契約明細）

> 契約に含まれる商品・サービスの明細。Order.Activate時に生成/更新される。

| Field               | Type        | Req | Uniq | Def | Idx | Hist | Rpt | Rules / Notes                          |
| ------------------- | ----------- | --: | ---: | --- | --: | ---: | --: | -------------------------------------- |
| ContractId          | id          |   Y |    N |     |   Y |    N |   Y | 親Contract                             |
| ProductId           | id          |   Y |    N |     |   Y |    N |   Y | 商品                                   |
| PricebookEntryId    | id          |   N |    N |     |   Y |    N |   Y | 価格表エントリ                         |
| SourceOrderItemId   | id          |   N |    N |     |   Y |    N |   Y | 元発注明細                             |
| Quantity            | decimal     |   Y |    N | 1   |   Y |    N |   Y | 数量（ライセンス数等）                 |
| UnitPrice           | currency    |   Y |    N |     |   N |    Y |   Y | 単価（標準価格）                       |
| CustomerUnitPrice   | currency    |   N |    N |     |   N |    Y |   Y | 顧客別単価（PoF用）（INV-CLI1）        |
| TermMonths          | int         |   N |    N |     |   Y |    N |   Y | 契約期間（月数）                       |
| BillingFrequency    | enum        |   N |    N |     |   Y |    N |   Y | Monthly/Yearly/ThreeYear               |
| StartDate           | date        |   Y |    N |     |   Y |    N |   Y | サービス開始日                         |
| EndDate             | date        |   Y |    N |     |   Y |    N |   Y | サービス終了日                         |
| TotalPrice          | currency    |   Y |    N | 計算  |   Y |    N |   Y | 明細合計                               |
| ConsumedAmount      | currency    |   Y |    N | 0   |   Y |    N |   Y | 消費済み金額（PoF用）                  |
| RemainingAmount     | currency    |   Y |    N | 計算  |   Y |    N |   Y | 残額（TotalPrice - ConsumedAmount）    |
| Status              | enum        |   Y |    N | Active|  Y |    Y |   Y | Active/Expired/Cancelled               |
| Description         | text        |   N |    N |     |   N |    N |   N |                                        |

**補足**
* **CustomerUnitPrice**: PoF契約で顧客固有の単価を設定する場合に使用。PoolConsumptionの計算に使用
* **ConsumedAmount/RemainingAmount**: PoF契約でのプール消費追跡用。License/Serviceでは使用しない

**不変条件**
* **INV-CLI1**: CustomerUnitPriceは PricebookEntry.AllowCustomerPrice = true の商品のみ設定可能
* **INV-CLI2**: PoF商品の場合、RemainingAmount >= 0（消費済み > TotalPrice は不可）

---

## 13.3 PoolConsumption（プール消費）

> PoF契約における消費履歴を記録する。営業担当が消費リクエストを登録し、ContractLineItemの残高を減算する。

| Field               | Type        | Req | Uniq | Def       | Idx | Hist | Rpt | Rules / Notes                          |
| ------------------- | ----------- | --: | ---: | --------- | --: | ---: | --: | -------------------------------------- |
| ContractLineItemId  | id          |   Y |    N |           |   Y |    N |   Y | 対象の契約明細（PoF商品）              |
| ConsumptionDate     | date        |   Y |    N |           |   Y |    Y |   Y | 消費日                                 |
| Quantity            | decimal     |   Y |    N | 1         |   Y |    N |   Y | 消費数量                               |
| UnitPrice           | currency    |   Y |    N |           |   N |    N |   Y | 適用単価（CustomerUnitPrice or UnitPrice） |
| Amount              | currency    |   Y |    N | 計算       |   Y |    N |   Y | 消費金額（Quantity × UnitPrice）       |
| Description         | text        |   N |    N |           |   N |    N |   N | 消費内容の説明                         |
| RequestedBy         | id          |   Y |    N |           |   Y |    Y |   Y | 申請者                                 |
| RequestedAt         | datetime    |   Y |    N | now       |   Y |    N |   N |                                        |
| Status              | enum        |   Y |    N | Pending   |   Y |    Y |   Y | Pending/Approved/Rejected/Cancelled    |
| ApprovedBy          | id          |   N |    N |           |   Y |    Y |   Y | 承認者                                 |
| ApprovedAt          | datetime    |   N |    N |           |   Y |    N |   N |                                        |
| RejectionReason     | text        |   N |    N |           |   N |    N |   N | Rejected時                             |
| InvoiceLineItemId   | id          |   N |    N |           |   Y |    N |   Y | 請求明細（請求済みの場合）             |
| ExternalReference   | string      |   N |    N |           |   Y |    N |   N | 外部システム参照（チケット番号等）     |

**補足**
* **UnitPrice**: ContractLineItem.CustomerUnitPrice があればそれを使用、なければ UnitPrice
* **Status**: Approved時にContractLineItem.ConsumedAmountを加算

**不変条件**
* **INV-PC1**: Approved時、ContractLineItem.RemainingAmount >= Amount（残高不足は承認不可）
* **INV-PC2**: ContractLineItem.Product.ProductType = 'PoF' のみ登録可能
* **INV-PC3**: ConsumptionDate は Contract.StartDate 〜 Contract.EndDate の範囲内

---

## 13.4 Invoice（請求書）

> 顧客への請求を管理する。契約種別によって請求タイミングが異なる。

| Field               | Type        | Req | Uniq | Def      | Idx | Hist | Rpt | Rules / Notes                          |
| ------------------- | ----------- | --: | ---: | -------- | --: | ---: | --: | -------------------------------------- |
| AccountId           | id          |   Y |    N |          |   Y |    Y |   Y | 請求先企業                             |
| ContractId          | id          |   N |    N |          |   Y |    N |   Y | 関連契約                               |
| OrderId             | id          |   N |    N |          |   Y |    N |   Y | 関連発注書                             |
| InvoiceNumber       | string      |   Y |    Y |          |   Y |    Y |   Y | 請求番号（自動採番推奨）               |
| InvoiceDate         | date        |   Y |    N |          |   Y |    Y |   Y | 請求日                                 |
| DueDate             | date        |   Y |    N |          |   Y |    N |   Y | 支払期日                               |
| Status              | enum        |   Y |    N | Draft    |   Y |    Y |   Y | Draft/Sent/Paid/PartialPaid/Overdue/Cancelled/Void |
| SubTotal            | currency    |   Y |    N | 計算      |   Y |    N |   Y | 小計（明細合計）                       |
| TaxAmount           | currency    |   Y |    N | 0        |   Y |    N |   Y | 税額                                   |
| TotalAmount         | currency    |   Y |    N | 計算      |   Y |    N |   Y | 合計（SubTotal + TaxAmount）           |
| PaidAmount          | currency    |   Y |    N | 0        |   Y |    Y |   Y | 支払済み金額                           |
| BalanceDue          | currency    |   Y |    N | 計算      |   Y |    N |   Y | 残高（TotalAmount - PaidAmount）       |
| BillingPeriodStart  | date        |   N |    N |          |   Y |    N |   Y | 請求対象期間開始日                     |
| BillingPeriodEnd    | date        |   N |    N |          |   Y |    N |   Y | 請求対象期間終了日                     |
| SentAt              | datetime    |   N |    N |          |   Y |    N |   N | 送信日時                               |
| PaidAt              | datetime    |   N |    N |          |   Y |    Y |   N | 支払完了日時                           |
| Notes               | text        |   N |    N |          |   N |    N |   N | 備考                                   |
| ExternalIds         | json        |   N |    N |          |   N |    N |   N |                                        |

**補足**
* **Status**: Draft→Sent→Paid/PartialPaid/Overdue→Cancelled/Void
* **請求タイミング**:
  - License: Order.Activated直後に全額請求
  - Service: 納品完了後に請求
  - PoF: 消費実績に基づき定期請求（月次等）

---

## 13.5 InvoiceLineItem（請求明細）

| Field               | Type        | Req | Uniq | Def | Idx | Hist | Rpt | Rules / Notes                          |
| ------------------- | ----------- | --: | ---: | --- | --: | ---: | --: | -------------------------------------- |
| InvoiceId           | id          |   Y |    N |     |   Y |    N |   Y | 親請求書                               |
| ContractLineItemId  | id          |   N |    N |     |   Y |    N |   Y | 関連契約明細                           |
| OrderItemId         | id          |   N |    N |     |   Y |    N |   Y | 関連発注明細                           |
| PoolConsumptionId   | id          |   N |    N |     |   Y |    N |   Y | 関連プール消費（PoF用）                |
| ProductId           | id          |   Y |    N |     |   Y |    N |   Y | 商品                                   |
| Description         | string      |   Y |    N |     |   N |    N |   Y | 明細説明                               |
| Quantity            | decimal     |   Y |    N | 1   |   Y |    N |   Y | 数量                                   |
| UnitPrice           | currency    |   Y |    N |     |   N |    N |   Y | 単価                                   |
| Amount              | currency    |   Y |    N | 計算  |   Y |    N |   Y | 金額（Quantity × UnitPrice）           |
| TaxRate             | percent     |   N |    N |     |   N |    N |   Y | 税率                                   |
| TaxAmount           | currency    |   Y |    N | 0   |   Y |    N |   Y | 税額                                   |
| BillingPeriodStart  | date        |   N |    N |     |   Y |    N |   Y | 請求対象期間開始日                     |
| BillingPeriodEnd    | date        |   N |    N |     |   Y |    N |   Y | 請求対象期間終了日                     |
| SortOrder           | int         |   Y |    N | 0   |   Y |    N |   N | 表示順                                 |

**補足**
* License/Service: OrderItemから生成
* PoF: PoolConsumption（承認済み）から生成

---

## 13.6 Contract/Invoice 関連の不変条件まとめ

| ID | 説明 |
|----|------|
| INV-CON1 | Contract.AccountIdは必須 |
| INV-CON2 | ContractTypeは最初のContractLineItemのProductTypeから自動設定 |
| INV-CON3 | Contract.EndDate = Contract.StartDate + TermMonths - 1日 |
| INV-CLI1 | CustomerUnitPriceはPricebookEntry.AllowCustomerPrice=trueの商品のみ |
| INV-CLI2 | PoF商品: RemainingAmount >= 0（残高不足での消費不可） |
| INV-PC1 | PoolConsumption承認時: ContractLineItem.RemainingAmount >= Amount |
| INV-PC2 | PoolConsumptionはPoF商品の契約明細のみ |
| INV-PC3 | ConsumptionDateは契約期間内 |
| INV-ORD3 | Renewal/Upsell時、Order.ContractIdは既存Contractを参照 |
