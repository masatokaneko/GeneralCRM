# 成果物 2：トレーサビリティ表 v1

## 0. 前提（表の見方）

* **Core API**：Single Writer（最終権限評価・最終明細）を担う
* **周辺サービスAPI**：Approval / Search / Reporting / Sharing / Metadata / Automation

  * ただし **検索・レポートの明細は必ず Core `recordsByIds` で再評価**（漏洩防止）
* **イベント**：CoreはOutboxで発行、周辺はIntegration Eventを発行

---

## 1. 共通API（多くのUCが使う"土台"）

| 区分           | API                                     | 用途                              | 主担当               |
| ------------ | --------------------------------------- | ------------------------------- | ----------------- |
| CRUD（汎用）     | `POST /v1/sobjects/{objectName}`        | 作成                              | Core              |
| CRUD（汎用）     | `GET /v1/sobjects/{objectName}/{id}`    | 詳細取得（権限・フィールドマスク適用）             | Core              |
| CRUD（汎用）     | `PATCH /v1/sobjects/{objectName}/{id}`  | 更新（楽観ロック）                       | Core              |
| CRUD（汎用）     | `DELETE /v1/sobjects/{objectName}/{id}` | 論理削除                            | Core              |
| Query        | `POST /v1/query/execute`                | 一覧/フィルタ/ソート/ページング               | Core              |
| Safety valve | `POST /v1/query/recordsByIds`           | ID集合→可視レコードのみ返す（Search/Report用） | Core              |
| Describe     | `GET /v1/setup/describe/{objectName}`   | 項目/型/レイアウト参照（キャッシュ可）            | Metadata→Core(参照) |

---

## 2. UC → 画面 → API → モジュール → イベント（主要）

### 2.1 Lead → Convert（Flow-1）

| UC                     | 代表画面         | 主API（Core）                             | 関連サービスAPI                                | Coreモジュール                                                                | 主イベント                        |
| ---------------------- | ------------ | -------------------------------------- | ---------------------------------------- | ------------------------------------------------------------------------ | ---------------------------- |
| UC-20-01 リード作成         | Lead作成       | `POST /v1/sobjects/Lead`               |                                          | `modules/leads`                                                          | `RecordCreated(Lead)`        |
| UC-20-02 リード更新         | Lead詳細       | `PATCH /v1/sobjects/Lead/{id}`         |                                          | `modules/leads`                                                          | `RecordUpdated(Lead)`        |
| UC-20-04 リード共有         | Lead共有設定     | （Coreは参照のみ）                            | Sharing：`POST /v1/sharing/rebuild` 等（運用） | `core.security`（評価）                                                      | `SharingUpdated`（必要なら）       |
| UC-21-01 Convert       | Convertウィザード | `POST /v1/leads/{id}/convert`          |                                          | `modules/leads` + `modules/accounts/contacts/opportunities`（Orchestrate） | `LeadConverted` + 作成/更新イベント  |
| UC-21-02 ConvertでOpp作成 | Convertウィザード | 同上（オプション）                              |                                          | `modules/opportunities`                                                  | `RecordCreated(Opportunity)` |
| UC-21-03 変換結果整備        | 変換結果画面       | `GET /v1/leads/{id}/convertResult`（任意） |                                          | `modules/leads`                                                          | （上に包含）                       |

> Convertは **Application層ユースケース**で複数Aggregateを生成します（D4方針どおり、Domain間直参照ではなくオーケストレーション）。

---

### 2.2 Opportunity（Flow-2：作成→ステージ→クローズ）

| UC                       | 代表画面      | 主API（Core）                                                   | 関連サービスAPI        | Coreモジュール                                 | 主イベント                                |
| ------------------------ | --------- | ------------------------------------------------------------ | ---------------- | ----------------------------------------- | ------------------------------------ |
| UC-30-01 商談作成            | Opp作成     | `POST /v1/sobjects/Opportunity`                              |                  | `modules/opportunities`                   | `RecordCreated(Opportunity)`         |
| UC-30-02 ステージ更新          | Kanban/詳細 | `POST /v1/opportunities/{id}/changeStage`                    |                  | `modules/opportunities`                   | `StageChanged` + `RecordUpdated`     |
| UC-30-03 クローズ            | Close画面   | `POST /v1/opportunities/{id}/close`                          |                  | `modules/opportunities`                   | `StageChanged` + `RecordUpdated`     |
| UC-30-04 詳細閲覧            | Opp詳細     | `GET /v1/sobjects/Opportunity/{id}`                          |                  | `modules/opportunities`                   |                                      |
| UC-30-05 一覧（My pipeline） | Opp一覧     | `POST /v1/query/execute`                                     |                  | `modules/opportunities` + `core.security` |                                      |
| UC-30-06 商談共有/Team       | Team編集    | `POST /v1/opportunities/{id}/teamMembers`（推奨）                | Sharing再計算（必要なら） | `modules/opportunities`                   | `RecordUpdated`（teamは別イベントでも可）       |
| UC-30-07 LineItem        | 明細エディタ    | `POST /v1/opportunities/{id}/lineItems` / `PATCH` / `DELETE` |                  | `modules/opportunities`                   | `RecordUpdated(Opportunity)`（明細差分含む） |
| UC-30-08 ContactRole     | 役割管理      | `POST /v1/opportunities/{id}/contactRoles` 等                 |                  | `modules/opportunities`                   | `RecordUpdated`                      |

---

### 2.3 Quote（Flow-3：見積→承認→Primary→Order）

| UC                 | 代表画面           | 主API（Core）                                    | 関連サービスAPI                            | Coreモジュール                                  | 主イベント                                            |
| ------------------ | -------------- | --------------------------------------------- | ------------------------------------ | ------------------------------------------ | ------------------------------------------------ |
| UC-40-01 見積作成      | Quote作成        | `POST /v1/sobjects/Quote`                     |                                      | `modules/quotes`                           | `RecordCreated(Quote)`                           |
| UC-40-02 見積明細      | Quote明細        | `POST /v1/quotes/{id}/lineItems` 等            |                                      | `modules/quotes`                           | `RecordUpdated(Quote)`                           |
| UC-40-03 ステータス遷移   | Quote状態        | `POST /v1/quotes/{id}/changeStatus`           |                                      | `modules/quotes`                           | `RecordUpdated(Quote)`                           |
| UC-40-04 Primary指定 | Opp詳細          | `POST /v1/opportunities/{id}/setPrimaryQuote` |                                      | `modules/opportunities` + `modules/quotes` | `RecordUpdated(Opportunity)`                     |
| UC-40-05 承認申請      | Approval送信     | （Coreはロック参照）                                  | Approval：`POST /v1/approvals/submit` | `core.workflow`（制約適用）                      | `ApprovalSubmitted`（外部）                          |
| UC-40-06 承認ロック     | Quote編集        | `PATCH /v1/sobjects/Quote/{id}`（ロック判定）        | Approval：`GET lockState`（内部Port）     | `core.security` + `core.workflow`          |                                                  |
| UC-40-07 承認結果反映    | Approval Inbox | （必要ならCore更新）                                  | Approval：`POST /v1/approvals/decide` | `modules/quotes`                           | `ApprovalDecided`（外部）＋必要なら`RecordUpdated(Quote)` |
| UC-50-01 Order作成   | Order作成        | `POST /v1/sobjects/Order`（fromQuote指定可）       |                                      | `modules/orders`                           | `RecordCreated(Order)`                           |
| UC-50-02 Order明細   | Order明細        | `POST /v1/orders/{id}/items` 等                |                                      | `modules/orders`                           | `RecordUpdated(Order)`                           |
| UC-50-03 Order状態   | Order状態        | `POST /v1/orders/{id}/changeStatus`           |                                      | `modules/orders`                           | `RecordUpdated(Order)`                           |

---

### 2.4 Activity（Flow-4）

| UC            | 代表画面        | 主API（Core）                                           | 関連サービスAPI                        | Coreモジュール            | 主イベント                     |
| ------------- | ----------- | ---------------------------------------------------- | -------------------------------- | -------------------- | ------------------------- |
| UC-60-01 活動作成 | Timeline/作成 | `POST /v1/sobjects/Task` / `POST /v1/sobjects/Event` |                                  | `modules/activities` | `RecordCreated(Activity)` |
| UC-60-02 更新   | 活動詳細        | `PATCH /v1/sobjects/Task/{id}` 等                     |                                  | `modules/activities` | `RecordUpdated(Activity)` |
| UC-60-03 一覧   | My/対象別      | `POST /v1/query/execute`                             |                                  | `modules/activities` |                           |
| UC-60-04 共有   | 親従属         | （基本：Core評価）                                          | Sharing（Controlled by Parentの扱い） | `core.security`      |                           |

---

### 2.5 Product / Pricebook（Flow-5/6の基盤）

| UC                | 代表画面        | 主API（Core）                                   | 関連サービスAPI            | Coreモジュール                             | 主イベント                              |
| ----------------- | ----------- | -------------------------------------------- | -------------------- | ------------------------------------- | ---------------------------------- |
| UC-70-01 商品管理     | Product管理   | `POST/GET/PATCH /v1/sobjects/Product2`       |                      | `modules/products`                    | `RecordCreated/Updated(Product)`   |
| UC-71-01 価格表      | Pricebook管理 | `POST/GET/PATCH /v1/sobjects/Pricebook2`     |                      | `modules/pricebooks`                  | `RecordCreated/Updated(Pricebook)` |
| UC-71-02 価格エントリ   | PBE管理       | `POST/GET/PATCH /v1/sobjects/PricebookEntry` |                      | `modules/pricebooks`                  | `RecordCreated/Updated(PBE)`       |
| UC-71-03 明細追加時の参照 | 明細UI        | （Core内で参照）                                   | Metadata/Pricebook参照 | `modules/opportunities/quotes/orders` |                                    |

---

### 2.6 Search（Flow-5：漏洩防止）

| UC          | 代表画面          | 主API（Core）                          | 関連サービスAPI                            | Coreモジュール                      | 主イベント                       |
| ----------- | ------------- | ----------------------------------- | ------------------------------------ | ------------------------------ | --------------------------- |
| UC-00-04 検索 | Global Search | `POST /v1/query/recordsByIds`（最終明細） | Search：`POST /v1/search/query`（候補ID） | `core.security` + 各`modules/*` | （SearchIndex更新はCoreイベント購読側） |

---

### 2.7 Report（Flow-6：漏洩防止）

| UC              | 代表画面           | 主API（Core）                     | 関連サービスAPI                             | Coreモジュール                   | 主イベント |
| --------------- | -------------- | ------------------------------ | ------------------------------------- | --------------------------- | ----- |
| UC-90-01 作成     | Report Builder | （必要列のDescribe参照）               | Reporting：`POST /v1/reports`          | `setup_read`（参照）            |       |
| UC-90-02 実行     | Run            | `POST /v1/query/execute`（明細抽出） | Reporting：`POST /v1/reports/{id}/run` | `core.security` + 該当modules |       |
| UC-90-03 ドリルダウン | Drilldown      | `POST /v1/query/recordsByIds`  | Reporting：`GET results/{runId}`       | 同上                          |       |
| UC-90-04 共有     | Folder権限       |                                | Reporting：Folder ACL API              | `core.security`（最終明細）       |       |

---

### 2.8 Setup（メタデータ：Validation/Workflow/Approval/Sharing）

| UC                    | 代表画面     | 主API（Core）      | 関連サービスAPI                                   | Coreモジュール              | 主イベント                                  |
| --------------------- | -------- | --------------- | ------------------------------------------- | ---------------------- | -------------------------------------- |
| UC-80-03 Validation管理 | Setup UI | （Coreは参照/キャッシュ） | Metadata：`POST /v1/setup/validationRules` 等 | `core.validation`（評価器） | `MetadataChanged`                      |
| UC-80-04 Workflow管理   | Setup UI | （Coreは参照/キャッシュ） | Metadata：`POST /v1/setup/workflowRules` 等   | `core.workflow`        | `MetadataChanged`                      |
| UC-80-05 Approval管理   | Setup UI | （Coreはロック参照）    | Approval：`POST /v1/setup/approvals` 等       | `core.workflow`        | `MetadataChanged`                      |
| UC-80-06 共有設定         | Setup UI | （Coreは評価）       | Sharing：`POST /v1/setup/sharing/*`          | `core.security`        | `SharingUpdated` / `PermissionChanged` |

---

## 3. 要件（FR）→ API → モジュール（"漏れ検出"用）

特に実装漏れが起きやすい横断要件を、API/モジュールで束ねておきます。

| 要件                     | 必須API                       | 実装責務モジュール                               |
| ---------------------- | --------------------------- | --------------------------------------- |
| FR-3 権限（Object/Field）  | `GET/PATCH/QUERY` 全て        | `core.security` + `PermissionEvaluator` |
| FR-4 共有（Record Access） | `GET/QUERY/recordsByIds` 全て | `core.security` + `SharingAccessReader` |
| FR-5 Validation        | `POST/PATCH`                | `core.validation` + SavePipeline        |
| FR-6 Workflow(sync)    | `POST/PATCH`                | `core.workflow` + SavePipeline          |
| FR-7 Approval Lock     | `PATCH/DELETE/OwnerChange`  | `core.workflow` + `ApprovalStateReader` |
| FR-8 Audit             | すべてのWrite                   | `core.audit` + SavePipeline             |
| FR-9 Outbox            | すべてのWrite                   | `core.outbox` + SavePipeline            |
| FR-10 Report漏洩防止       | `recordsByIds`              | `core.security` + Query Engine          |

---

## 4. この表で"実装担当の切り方"まで確定できる（参考）

* **Coreチーム**：SObject CRUD + Query + Security/Validation/Workflow/Audit/Outbox（D4の範囲）
* **Sharingチーム**：shares生成・再計算・version切替（Coreは評価のみ）
* **Approvalチーム**：申請/承認・ロック状態の正本（Coreは参照して制約）
* **Search/Reportingチーム**：候補生成/集計（明細はCore最終評価）

---

## 補足：次のステップ

このトレーサビリティ表を基に、業務フローをMermaid形式で可視化します。
優先度の高い順に以下の6本を作成予定：

1. Flow-1 Lead → Convert
2. Flow-2 Opportunity（作成→ステージ→クローズ）
3. Flow-3 Quote（作成→承認→Primary→Order）
4. Flow-4 Activity
5. Flow-5 Search（候補→Core再評価）
6. Flow-6 Report（明細→集計→ドリルダウン）

