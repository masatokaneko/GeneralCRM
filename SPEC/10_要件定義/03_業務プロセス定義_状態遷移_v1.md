# 業務プロセス定義・状態遷移 v1

## 概要

本書は、Salesforce Sales Cloud同等のCRMシステムにおける各ビジネスオブジェクトの状態遷移、業務ルール、および不変条件を網羅的に定義する。各オブジェクトの状態管理、遷移条件、エラーハンドリングを詳細に規定し、システム実装の完全性を保証する。

---

## 1. リード管理（Lead Management）

### 1.1 プロセス概要
未精査の見込み客を管理し、適格化を経て商談（Opportunity）への転換を目指す。

### 1.2 状態遷移マトリクス

| 現在状態 | 遷移先状態 | 遷移条件 | 必須項目 | 実行アクション | 備考 |
|:---------|:----------|:---------|:---------|:-------------|:-----|
| - | **New** | 初期作成時 | LastName, Company | - | デフォルト初期状態 |
| New | Working | 初回コンタクト開始 | - | LastActivityDate更新 | 手動遷移 |
| New | Disqualified | 即時不適格判定 | DisqualificationReason | - | 直接不適格ルート |
| Working | Nurturing | 継続フォロー必要 | - | NextActivityDate設定 | 中期育成フロー |
| Working | Qualified | 精査完了・商談化可能 | - | ConversionReadyフラグ | 変換準備状態 |
| Working | Disqualified | 作業中の不適格判定 | DisqualificationReason | - | 作業後の除外 |
| Nurturing | Working | 再アクティブ化 | - | LastActivityDate更新 | 育成からの復帰 |
| Nurturing | Qualified | 育成完了・精査OK | - | ConversionReadyフラグ | 育成成功 |
| Nurturing | Disqualified | 育成中の不適格判定 | DisqualificationReason | - | 育成失敗 |
| Qualified | Converted | リード変換実行 | - | Account/Contact/Opp作成 | **最終状態** |
| Qualified | Disqualified | 変換前の不適格判定 | DisqualificationReason | ConversionReadyクリア | 変換キャンセル |
| Disqualified | Working | 再評価による復活 | - | DisqualificationReasonクリア | 例外的復帰 |

### 1.3 詳細ビジネスルール

#### 1.3.1 変換（Conversion）プロセス
```
変換実行条件:
- Status ∈ {Working, Nurturing, Qualified} （推奨: Qualified）
- IsConverted = false
- 必須項目の入力完了

変換実行内容（原子的処理）:
1. Account作成（既存Accountへの紐付けも可）
2. Contact作成（Account.Id設定）
3. Opportunity作成（任意、ユーザ指定）
4. Lead.IsConverted = true, Status = "Converted"
5. Lead.ConvertedAccountId, ConvertedContactId, ConvertedOpportunityId設定

変換後制限:
- Lead自体の編集不可（IsConvertedフラグによる保護）
- 活動（Task/Event）の新規作成不可
- 既存活動の参照は維持（WhoId保持）
```

#### 1.3.2 不適格（Disqualification）管理
```
不適格理由（DisqualificationReason）必須値:
- "No Budget" （予算なし）
- "No Authority" （決裁権なし）  
- "No Need" （ニーズなし）
- "No Timeline" （導入時期未定）
- "Competitor Won" （競合選択）
- "Lost Contact" （連絡不能）
- "Not a Fit" （ソリューション不適合）
- "Other" （その他、詳細をコメント欄に記載）

不適格復帰条件:
- DisqualificationReason = null に設定
- 復帰理由をActivityとして記録推奨
```

### 1.4 検証ルール・不変条件
```
INV-L1: Conversionチェック
- IsConverted = true ⟹ Status = "Converted"
- Status = "Converted" ⟹ IsConverted = true
- ConvertedDate は Converted時刻に自動設定

INV-L2: 不適格チェック  
- Status = "Disqualified" ⟹ DisqualificationReason ≠ null
- DisqualificationReason ≠ null ⟹ Status = "Disqualified"

INV-L3: 活動制限
- IsConverted = true ⟹ 新規Task/Event作成不可
- Status = "Converted" ⟹ Lead項目編集不可（システム項目除く）
```

---

## 2. 商談管理（Opportunity Management）

### 2.1 プロセス概要
確度の低いステージから段階的に成約（Closed Won）へ導く。各ステージで必要な情報を蓄積し、予測精度を向上させる。

### 2.2 状態遷移マトリクス

| 現在Stage | 遷移先Stage | 確度 | 遷移条件 | 必須項目 | 実行アクション | 備考 |
|:---------|:-----------|:----|:---------|:---------|:-------------|:-----|
| - | **Prospecting** | 10% | 初期作成時 | Name, Amount, CloseDate | ForecastCategory="Pipeline" | 初期ステージ |
| Prospecting | Qualification | 20% | 初期アプローチ完了 | - | LastActivityDate更新 | BANT確認開始 |
| Prospecting | Closed Lost | 0% | 初期段階での失注 | LossReason | IsWon=false,IsClosed=true | 早期終了 |
| Qualification | Needs Analysis | 35% | BANT確認完了 | - | ForecastCategory="Best Case" | 要件定義開始 |
| Qualification | Prospecting | 10% | 要件未確定で後退 | - | - | 逆行遷移 |
| Qualification | Closed Lost | 0% | 精査段階での失注 | LossReason | IsWon=false,IsClosed=true | BANT不適格 |
| Needs Analysis | Proposal/Price Quote | 75% | 提案準備完了 | NextStep | ForecastCategory="Commit" | 見積段階移行 |
| Needs Analysis | Qualification | 20% | 要件再精査が必要 | - | - | 要件変更対応 |
| Needs Analysis | Closed Lost | 0% | 要件段階での失注 | LossReason | IsWon=false,IsClosed=true | 要件不一致 |
| Proposal/Price Quote | Negotiation/Review | 90% | 提案受理・交渉開始 | Decision Process | LastProposalDate更新 | 最終交渉 |
| Proposal/Price Quote | Needs Analysis | 35% | 提案要件見直し | - | - | 提案修正 |
| Proposal/Price Quote | Closed Lost | 0% | 提案段階での失注 | LossReason | IsWon=false,IsClosed=true | 提案却下 |
| Negotiation/Review | Closed Won | 100% | 成約・契約締結 | ContractDate | IsWon=true,IsClosed=true | **最終成功状態** |
| Negotiation/Review | Proposal/Price Quote | 75% | 再提案が必要 | - | - | 条件変更対応 |
| Negotiation/Review | Closed Lost | 0% | 最終交渉での失注 | LossReason | IsWon=false,IsClosed=true | 最終段階失注 |

### 2.3 詳細ビジネスルール

#### 2.3.1 ステージ・確度連動
```
確度自動更新ルール:
- StageName変更時、対応するデフォルト確度に自動更新
- 手動確度変更は許可（ただし警告表示）
- Closed Won/Lost時は確度強制設定（100%/0%）

予測カテゴリ自動設定:
- Probability ≤ 30% ⟹ "Pipeline"
- 31% ≤ Probability ≤ 70% ⟹ "Best Case"  
- 71% ≤ Probability ≤ 99% ⟹ "Commit"
- Probability = 100% ⟹ "Closed"
- Omitted手動設定で予測から除外可能
```

#### 2.3.2 成約・失注処理
```
成約時（Closed Won）必須処理:
- IsWon = true, IsClosed = true
- Probability = 100%
- ActualCloseDate = 成約日時
- ContractDate入力推奨
- 関連Quote.Status = "Accepted"（Primary Quoteがある場合）

失注時（Closed Lost）必須処理:
- IsWon = false, IsClosed = true  
- Probability = 0%
- LossReason必須入力
- 競合情報入力推奨（CompetitorLost）
- ActualCloseDate = 失注日時
```

#### 2.3.3 チーム・権限管理
```
商談チーム（OpportunityTeam）:
- 役割: "Account Executive", "Sales Engineer", "Sales Manager", "Other"
- アクセス権: "Read", "Edit"  
- 分割率: Revenue Splitの計算用（合計100%チェック）
- チーム変更時は権限再計算が自動実行

Contact役割（OpportunityContactRole）:
- 役割: "Decision Maker", "Influencer", "Champion", "User", "Other"
- 主担当フラグ: IsPrimary（Opportunity毎に1人のみ）
- 影響度: "High", "Medium", "Low"
```

### 2.4 検証ルール・不変条件
```
INV-O1: 完了状態チェック
- IsClosed = true ⟹ StageName ∈ {"Closed Won", "Closed Lost"}
- IsWon = true ⟹ IsClosed = true AND StageName = "Closed Won"

INV-O2: 日付整合性
- CloseDate ≥ CreatedDate
- ActualCloseDate ≤ TODAY() （未来日付不可）
- ContractDate ≤ ActualCloseDate（成約時）

INV-O3: 金額・通貨整合性  
- Amount > 0 (正の値のみ)
- 関連LineItemの通貨は統一されている
- TotalOpportunityQuantity = Sum(LineItem.Quantity)

INV-O4: 失注理由
- StageName = "Closed Lost" ⟹ LossReason ≠ null
- IsWon = false AND IsClosed = true ⟹ LossReason ≠ null
```

---

## 3. 活動管理（Activity Management）

### 3.1 プロセス概要
営業活動（電話、メール、会議等）の記録・予定管理。人物（Who）と対象（What）の多態参照による柔軟な紐付けを提供。

### 3.2 活動タイプ別状態遷移

#### 3.2.1 タスク（Task）状態遷移
| 現在状態 | 遷移先状態 | 遷移条件 | 実行アクション | 備考 |
|:---------|:----------|:---------|:-------------|:-----|
| - | **Not Started** | 初期作成時 | ActivityDate設定 | デフォルト状態 |
| Not Started | In Progress | 作業開始 | StartDate記録 | 進行中フラグ |
| Not Started | Completed | 即完了 | CompletedDate=TODAY() | 直接完了 |
| Not Started | Deferred | 延期決定 | NewActivityDate設定 | 期日変更 |
| In Progress | Completed | 作業完了 | CompletedDate=TODAY() | 正常完了 |
| In Progress | Deferred | 作業中断・延期 | NewActivityDate設定 | 中断・延期 |
| Deferred | Not Started | 延期解除・再開 | ActivityDate更新 | 作業再開 |
| Deferred | Completed | 延期から直接完了 | CompletedDate=TODAY() | 延期後完了 |

#### 3.2.2 行動・会議（Event）状態遷移
| 現在状態 | 遷移先状態 | 遷移条件 | 実行アクション | 備考 |
|:---------|:----------|:---------|:-------------|:-----|
| - | **Planned** | 初期作成時 | StartDateTime設定 | 予定状態 |
| Planned | Held | 会議実施完了 | - | 開催済み |
| Planned | No Show | 相手側欠席 | NoShowReason記録 | 不参加記録 |
| Planned | Cancelled | 中止・延期 | CancelReason記録 | 開催中止 |

### 3.3 多態参照（Polymorphic Reference）管理

#### 3.3.1 WhoId（人物）参照規則
```
対象オブジェクト: Lead, Contact
参照制限:
- Lead.IsConverted = true の場合、新規Activity作成不可
- Contact.IsDeleted = true の場合、参照無効
- 1つのActivityにつき、WhoIdは1つのみ設定可能

整合性チェック:
- WhoId設定時、対象オブジェクトの有効性確認
- Contact削除時、関連Activityの整合性警告
```

#### 3.3.2 WhatId（対象）参照規則  
```
対象オブジェクト: Account, Opportunity, Campaign, Quote, Order, Case
参照制限:
- 削除されたオブジェクトへの新規紐付け不可
- Opportunity.IsClosed = true でも紐付け可能（履歴として）

関連性チェック:
- Contact.AccountId = Opportunity.AccountId の場合、整合性あり
- 異なるAccountに属するContact-Opportunityは警告表示
```

### 3.4 検証ルール・不変条件
```
INV-ACT1: Who参照整合性
- WhoId ≠ null ⟹ 参照先オブジェクトが有効
- WhoType ∈ {"Lead", "Contact"}
- Lead参照時、IsConverted=false または既存Activity

INV-ACT2: What参照整合性  
- WhatId ≠ null ⟹ 参照先オブジェクトが有効
- WhatType ∈ {"Account", "Opportunity", "Campaign", "Quote", "Order", "Case"}

INV-ACT3: 日時整合性
- Task: ActivityDate ≥ TODAY() - 30日 （過去30日まで設定可）
- Event: StartDateTime, EndDateTime の順序性
- CompletedDate ≤ TODAY()

INV-ACT4: 完了状態
- Status = "Completed" ⟹ CompletedDate ≠ null
- CompletedDate ≠ null ⟹ Status = "Completed"
```

---

## 4. 見積・受注管理（Quote & Order Management）

### 4.1 プロセス概要
商談に基づく正確な見積を作成し、顧客承認を経て受注につなげる。主要見積（Primary Quote）による商談金額同期を実現。

### 4.2 見積（Quote）状態遷移マトリクス

| 現在状態 | 遷移先状態 | 遷移条件 | 必須項目 | 実行アクション | 備考 |
|:---------|:----------|:---------|:---------|:-------------|:-----|
| - | **Draft** | 初期作成時 | Name, OpportunityId | - | 作成中状態 |
| Draft | In Review | 内部査完了 | - | ReviewedDate記録 | 社内承認済み |
| Draft | Presented | 直接顧客提示 | PresentedDate | EmailSentフラグ | 直接提示ルート |
| In Review | Draft | 修正依頼・差戻し | - | ReviewedDate=null | 内容修正必要 |
| In Review | Presented | 査承認・顧客提示 | PresentedDate | EmailSentフラグ | 正規提示ルート |
| Presented | Accepted | 顧客承認取得 | AcceptedDate | QuoteToOrderConversion | 受注準備完了 |
| Presented | Rejected | 顧客却下 | RejectedReason | - | 却下理由記録 |
| Presented | Negotiating | 条件交渉中 | - | NegotiationNotes | 交渉継続中 |
| Presented | Expired | 有効期限切れ | - | ExpiredDate=ExpirationDate | 自動期限切れ |
| Negotiating | Presented | 交渉完了・再提示 | PresentedDate | 修正見積提示 | 交渉結果反映 |
| Negotiating | Rejected | 交渉決裂 | RejectedReason | - | 交渉失敗 |
| Negotiating | Accepted | 交渉成功・承認 | AcceptedDate | QuoteToOrderConversion | 交渉成功 |
| Rejected | Draft | 新規見積作成 | - | 新QuoteId生成 | 再提案準備 |
| Accepted | Ordered | 受注変換実行 | OrderId | Order作成・LineItem移行 | **最終成功状態** |

### 4.3 受注（Order）状態遷移マトリクス

| 現在状態 | 遷移先状態 | 遷移条件 | 必須項目 | 実行アクション | 備考 |
|:---------|:----------|:---------|:---------|:-------------|:-----|
| - | **Order Received** | Quote.Acceptedから変換 | QuoteId, AccountId | LineItem継承 | 受注確定 |
| Order Received | Order Confirmed | 受注内容確認完了 | ConfirmedDate | 在庫引当・製造指示 | 社内処理開始 |
| Order Confirmed | In Production | 製造・準備開始 | ProductionStartDate | - | 履行プロセス |
| In Production | Ready to Ship | 出荷準備完了 | - | ShippingInstruction作成 | 出荷待ち |
| Ready to Ship | Shipped | 出荷実行 | ShippedDate, TrackingNumber | 顧客通知 | 出荷完了 |
| Shipped | Delivered | 配送完了 | DeliveredDate | - | 配送確認 |
| Delivered | Invoiced | 請求書発行 | InvoiceDate, InvoiceNumber | 売上計上 | 請求処理 |
| Invoiced | Paid | 入金確認 | PaidDate | 債権消込 | **完了状態** |

### 4.4 主要見積同期（Primary Quote Sync）

#### 4.4.1 同期ルール
```
Primary Quote設定条件:
- Opportunity毎に1つのみ
- Quote.Status ∈ {"Presented", "Accepted", "Negotiating"}
- Quote.IsSyncing = true

同期対象項目:
- Opportunity.Amount ← Quote.GrandTotal
- OpportunityLineItem ← QuoteLineItem（完全置換）
- Opportunity.Pricebook2Id ← Quote.Pricebook2Id

同期タイミング:
- Quote.Status変更時
- QuoteLineItem追加・更新・削除時  
- Primary Quote指定変更時
```

#### 4.4.2 同期制御
```
同期実行条件チェック:
1. Quote.OpportunityId ≠ null
2. Opportunity.IsClosed = false
3. Quote.Status ≠ "Draft"
4. Pricebook整合性確認

同期実行処理:
1. 既存OpportunityLineItem削除
2. QuoteLineItemからOpportunityLineItem作成
3. Opportunity.Amount更新
4. Opportunity.LastSyncDate更新
5. 同期履歴ログ記録

同期エラーハンドリング:
- Pricebook不一致: 警告表示、同期停止
- 通貨不一致: エラー、手動修正要求
- 数量・金額異常: エラー、検証要求
```

### 4.5 検証ルール・不変条件
```
INV-Q1: Primary Quote制約
- Opportunity毎にPrimary Quote最大1つ
- Quote.IsSyncing = true ⟹ Quote.Status ≠ "Draft"
- Primary Quote削除時は別Quoteへの移行または同期停止

INV-Q2: 見積有効期限
- ExpirationDate ≥ CreatedDate
- Status = "Expired" ⟹ TODAY() > ExpirationDate
- ExpirationDate ≤ TODAY() かつ Status ≠ "Expired" ⟹ 期限切れ警告

INV-Q3: 金額・明細整合性
- GrandTotal = Subtotal + Tax - Discount
- TotalPrice = Sum(QuoteLineItem.TotalPrice)
- QuoteLineItem.UnitPrice ≥ 0

INV-Q4: 受注変換整合性
- Quote.Status = "Accepted" ⟹ Order変換可能
- Order.ActivatedDate ≠ null ⟹ 元Quote.Status = "Accepted"
```

---

## 4B. 契約・請求管理（Contract & Invoice Management）

### 4B.1 プロセス概要

サブスクリプション型ビジネスにおける契約ライフサイクル管理。Order（発注書）を起点にContract（契約）を生成・更新し、契約種別に応じた請求処理を行う。

```
営業フロー:
Opportunity → Quote → Order（発注書受領）→ Contract → Invoice

契約種別:
- License: 定額ライセンス契約（月額/年額/3年）
- PoF: Pool of Funds（従量消費型）
- Service: 業務委託契約
```

### 4B.2 契約（Contract）状態遷移マトリクス

| 現在状態 | 遷移先状態 | 遷移条件 | 必須項目 | 実行アクション | 備考 |
|:---------|:----------|:---------|:---------|:-------------|:-----|
| - | **Draft** | Order.Activated時に生成 | AccountId, ContractType | ContractLineItem作成 | 契約作成 |
| Draft | InApproval | 契約内容確認完了 | - | 承認申請通知 | 承認待ち |
| Draft | Activated | 直接有効化（承認不要時） | StartDate, EndDate | ContractNumber発番 | 即時有効化 |
| InApproval | Draft | 差戻し・修正指示 | - | RevisionReason記録 | 内容修正必要 |
| InApproval | Activated | 承認完了 | ApprovedBy, ApprovedDate | ActivatedAt設定 | 契約発効 |
| Activated | Expired | 契約期間終了 | - | ExpiredDate設定 | 自動期限切れ |
| Activated | Terminated | 途中解約 | TerminationReason | TerminatedAt設定 | 早期解約 |

### 4B.3 契約更新（Renewal）プロセス

```
更新フロー:
1. 既存Contract.RenewalNoticeDateに達した時点で更新案内
2. 営業担当がOpportunity(Type=Renewal)を作成
3. 見積作成・承認
4. Order作成（OrderType=Renewal, ContractId=既存契約）
5. Order.Activated時にContract.EndDate延長

自動更新の場合:
- Contract.AutoRenewal = true
- RenewalNoticeDate経過後、自動でRenewal Order生成
- 承認後、Contract.EndDate自動延長
- Contract.TermMonths → RenewalTermMonths使用

手動更新の場合:
- 営業担当がRenewal Opportunityを手動作成
- 金額・条件変更可能
- 承認プロセス経由
```

### 4B.4 発注（Order）状態遷移マトリクス（拡張）

| 現在状態 | 遷移先状態 | 遷移条件 | 必須項目 | 実行アクション | 備考 |
|:---------|:----------|:---------|:---------|:-------------|:-----|
| - | **Draft** | Quote.Acceptedから変換 | QuoteId, OrderType | LineItem継承 | 発注書作成 |
| Draft | Activated | 発注書承認 | OrderDate, EffectiveDate | Contract生成/更新 | **重要: 売上計上トリガー** |
| Activated | Fulfilled | サービス提供完了 | FulfilledDate | - | 履行完了 |
| Activated | Cancelled | 発注キャンセル | CancelledReason | Contract更新取消 | キャンセル処理 |

### 4B.5 Order.Activated時の処理詳細

```
OrderType=New の場合:
1. 新規Contract作成
   - Contract.AccountId = Order.AccountId
   - Contract.ContractType = 最初のLineItem.Product.ProductType
   - Contract.StartDate = Order.EffectiveDate
   - Contract.EndDate = Order.EffectiveDate + TermMonths - 1日
2. ContractLineItem作成（OrderItemから）
3. Contract.PrimaryOrderId = Order.Id
4. Invoice作成（License契約の場合は即時請求）

OrderType=Renewal の場合:
1. 既存Contract.EndDate延長
   - 新EndDate = 旧EndDate + 1日 + RenewalTermMonths - 1日
2. ContractLineItem更新（期間延長）
3. 更新Order紐付け
4. Invoice作成

OrderType=Upsell の場合:
1. 既存Contract維持
2. ContractLineItem追加/数量増加
3. 差額のInvoice作成

OrderType=Downsell の場合:
1. 既存Contract維持
2. ContractLineItem数量減少
3. クレジットノート発行（場合による）
```

### 4B.6 プール消費（PoolConsumption）状態遷移

| 現在状態 | 遷移先状態 | 遷移条件 | 必須項目 | 実行アクション | 備考 |
|:---------|:----------|:---------|:---------|:-------------|:-----|
| - | **Pending** | 消費リクエスト作成 | ContractLineItemId, Quantity | - | 申請状態 |
| Pending | Approved | 承認実行 | ApprovedBy | ConsumedAmount加算 | **残高減算** |
| Pending | Rejected | 却下 | RejectionReason | - | 申請却下 |
| Approved | Invoiced | 請求明細化 | InvoiceLineItemId | - | 請求完了 |
| Pending | Cancelled | 申請キャンセル | - | - | 取消 |

### 4B.7 請求（Invoice）状態遷移マトリクス

| 現在状態 | 遷移先状態 | 遷移条件 | 必須項目 | 実行アクション | 備考 |
|:---------|:----------|:---------|:---------|:-------------|:-----|
| - | **Draft** | 請求書作成 | AccountId, InvoiceDate | InvoiceNumber発番 | 作成中 |
| Draft | Sent | 顧客へ送信 | DueDate | SentAt記録 | 送信済み |
| Sent | Paid | 全額入金確認 | PaidAmount=TotalAmount | PaidAt記録 | **完了** |
| Sent | PartialPaid | 一部入金 | 0 < PaidAmount < TotalAmount | - | 一部入金 |
| Sent | Overdue | 支払期日超過 | TODAY() > DueDate | 督促通知 | 延滞 |
| PartialPaid | Paid | 残額入金 | PaidAmount=TotalAmount | PaidAt記録 | 完済 |
| PartialPaid | Overdue | 支払期日超過 | TODAY() > DueDate | 督促通知 | 延滞 |
| Overdue | Paid | 延滞後入金 | PaidAmount=TotalAmount | PaidAt記録 | 延滞後完済 |
| Sent/PartialPaid/Overdue | Cancelled | 請求取消 | CancelReason | - | 取消 |
| Sent/PartialPaid/Overdue | Void | 無効化（返金等） | VoidReason | - | 無効化 |

### 4B.8 請求タイミングルール

```
License契約:
- Order.Activated時点で全額請求
- 請求対象期間: Contract.StartDate 〜 Contract.EndDate
- 前払い請求

PoF契約:
- 消費実績に基づく定期請求（月次推奨）
- 請求対象: 前月のApproved PoolConsumption
- 後払い請求

Service契約:
- 納品完了後に請求
- マイルストーン請求も可能
- 後払い請求
```

### 4B.9 検証ルール・不変条件

```
INV-CON1: 契約帰属
- Contract.AccountId ≠ null (必須)
- Contract.AccountId = 関連Order.AccountId

INV-CON2: 契約種別整合性
- ContractType = 最初のContractLineItem.Product.ProductType
- 異なるProductTypeのLineItem追加禁止

INV-CON3: 契約期間計算
- Contract.EndDate = Contract.StartDate + TermMonths - 1日
- EndDate ≥ StartDate

INV-CON4: 状態遷移制御
- Activated後の基本項目変更禁止
- Terminated/Expired後の再活性化禁止

INV-CLI1: 顧客別単価制約
- CustomerUnitPrice設定可: PricebookEntry.AllowCustomerPrice = true

INV-CLI2: PoF残高制約
- ContractLineItem.RemainingAmount ≥ 0
- ConsumedAmount ≤ TotalPrice

INV-PC1: 消費承認時残高チェック
- Approved時: RemainingAmount ≥ Amount

INV-PC2: 消費対象制約
- Product.ProductType = 'PoF' のみ

INV-PC3: 消費日期間制約
- ConsumptionDate ∈ [Contract.StartDate, Contract.EndDate]

INV-INV1: 請求金額整合性
- SubTotal = SUM(InvoiceLineItem.Amount)
- TotalAmount = SubTotal + TaxAmount
- BalanceDue = TotalAmount - PaidAmount

INV-INV2: 請求状態整合性
- Paid ⟹ BalanceDue = 0
- PartialPaid ⟹ 0 < BalanceDue < TotalAmount
```

---

## 5. 予測管理（Forecasting Management）

### 5.1 プロセス概要
営業目標（Quota）に対する進捗確認と着地予測。ロール階層による自動積上げとマネージャ調整機能。

### 5.2 予測カテゴリ状態管理

#### 5.2.1 商談予測カテゴリ自動分類
```
分類ルール（Opportunity.Probability基準）:
- "Omitted": 手動設定、予測から除外
- "Pipeline": 0% ≤ Probability ≤ 30%、潜在的案件  
- "Best Case": 31% ≤ Probability ≤ 70%、可能性案件
- "Commit": 71% ≤ Probability ≤ 99%、確実性案件
- "Closed": Probability = 100%、確定案件

分類変更条件:
- Stage変更時自動更新
- 手動Probability変更時自動更新
- 手動ForecastCategory変更可（警告表示）
```

#### 5.2.2 予測レコード状態遷移
| 現在状態 | 遷移先状態 | 遷移条件 | 実行アクション | 備考 |
|:---------|:----------|:---------|:-------------|:-----|
| - | **Open** | 月次予測期間開始 | 下位ロール積上げ実行 | 予測開始 |
| Open | Submitted | 担当者予測提出 | SubmittedDate記録 | 部下予測確定 |
| Submitted | Approved | 上位者承認 | ApprovedDate記録 | 予測承認 |
| Submitted | Revised | 修正指示・差戻し | RevisionReason記録 | 再検討要求 |
| Revised | Submitted | 修正完了・再提出 | SubmittedDate更新 | 修正後提出 |
| Approved | Locked | 予測確定・変更不可 | LockedDate記録 | **確定状態** |

### 5.3 ロール階層予測積上げ

#### 5.3.1 積上げ計算ルール
```
積上げ対象:
- 下位ロールユーザが所有するOpportunity
- ForecastCategory ≠ "Omitted"
- CloseDate が予測期間内

積上げ計算:
Pipeline Amount = Sum(Pipeline Category Opportunities.Amount)
Best Case Amount = Pipeline + Sum(Best Case Category Opportunities.Amount)  
Commit Amount = Best Case + Sum(Commit Category Opportunities.Amount)
Closed Amount = Sum(Closed Category Opportunities.Amount)

階層計算:
各レベルで下位ロールの積上げ値を合計
マネージャ調整値を加算
最終予測値 = 積上げ値 + 調整値
```

#### 5.3.2 調整（Adjustment）管理
```
調整権限:
- 直属の下位ロールユーザの予測のみ調整可能
- 自分自身の予測は調整不可
- 上位ロールによる一括調整機能

調整値制御:
- 調整理由（AdjustmentReason）必須入力
- 調整値上限設定（積上げ値の±50%以内等）
- 調整履歴の完全記録

調整反映:
- 元Opportunityデータは変更しない
- 予測値のみに調整値反映
- 上位ロールへの積上げ時に調整値含む
```

### 5.4 検証ルール・不変条件
```
INV-F1: 予測期間整合性
- ForecastingPeriod.StartDate ≤ EndDate
- Opportunity.CloseDate が予測期間内
- 過去期間の予測は変更不可（Read Only）

INV-F2: ロール階層整合性  
- 上位ロールは下位ロールデータのみ参照可能
- 循環階層の禁止（A > B > A）
- ロール変更時の予測データ移行

INV-F3: 調整値制御
- AdjustmentAmount範囲チェック
- AdjustmentReason ≠ null （調整値 ≠ 0の場合）
- 調整者権限確認（直属上位ロールのみ）

INV-F4: 予測確定後保護
- Status = "Locked" ⟹ 金額変更不可
- 確定後のOpportunity変更は次期予測に反映
- 確定予測の監査ログ保持
```

---

## 6. テリトリ管理（Territory Management）

### 6.1 プロセス概要
Account属性に基づく営業担当・チームの自動割当。複雑な条件設定による柔軟なテリトリ運用を実現。

### 6.2 テリトリ割当状態遷移

#### 6.2.1 Account割当プロセス
| 現在状態 | 遷移先状態 | 遷移条件 | 実行アクション | 備考 |
|:---------|:----------|:---------|:-------------|:-----|
| - | **Unassigned** | Account作成時 | - | 未割当状態 |
| Unassigned | Evaluating | 割当ルール実行開始 | - | 評価処理中 |
| Evaluating | Assigned | 条件合致・割当完了 | TerritoryAssignment作成 | 自動割当成功 |
| Evaluating | Manual Review | 複数候補・手動判定 | ReviewRequest作成 | 手動判定要求 |
| Evaluating | Assignment Failed | 条件不合致 | FailureReason記録 | 割当失敗 |
| Manual Review | Assigned | 手動割当実行 | TerritoryAssignment作成 | 手動割当完了 |
| Assigned | Re-evaluating | Account属性変更 | 再評価トリガー | 割当見直し |
| Re-evaluating | Assigned | 同一テリトリ維持 | AssignmentDate更新 | 割当継続 |
| Re-evaluating | Reassigned | 別テリトリ移行 | 旧Assignment終了・新Assignment作成 | 割当変更 |

#### 6.2.2 テリトリルール評価エンジン
```
評価実行トリガー:
- Account.Industry変更時
- Account.AnnualRevenue変更時  
- Account.BillingState/Country変更時
- Account.NumberOfEmployees変更時
- Territory.AssignmentRule変更時

評価実行順序:
1. アクティブなTerritoryRule取得（Priority昇順）
2. 各ルールの条件式評価
3. 最初に合致したルールでTerritory決定
4. 複数合致時は優先度高いルールを選択
5. 合致なしの場合はデフォルトTerritory割当

条件式書式:
Industry = 'Manufacturing' AND AnnualRevenue >= 1000000000
BillingCountry = 'Japan' AND NumberOfEmployees BETWEEN 500 AND 2000
CustomField__c = 'Enterprise' OR (Industry IN ('Technology', 'Finance'))
```

### 6.3 テリトリ階層管理

#### 6.3.1 階層構造ルール
```
階層制約:
- 最大階層深度: 5レベル
- 循環参照の禁止
- 親子関係の整合性保証

権限継承:
- 上位テリトリメンバーは下位テリトリデータアクセス可能
- アクセスレベル: Read, Edit, Transfer
- 継承停止フラグによる制御可能

データ集約:
- 下位テリトリの実績自動積上げ
- KPI・売上目標の階層管理
- レポート・ダッシュボードの階層別表示
```

#### 6.3.2 テリトリメンバー管理
```
メンバー役割:
- "Territory Owner": テリトリ責任者、全権限
- "Territory Manager": 管理者、Transfer権限なし
- "Territory Member": メンバー、Read/Edit権限のみ
- "Territory Viewer": 閲覧者、Read権限のみ

メンバー変更制御:
- Owner変更時は関連Account.Owner自動更新
- Manager/Member追加時は権限付与処理
- メンバー削除時は権限剥奪・データ移行
```

### 6.4 検証ルール・不変条件
```
INV-T1: 階層整合性
- 循環参照禁止: Territory.ParentId ≠ 自身のId
- 階層深度制限: 最大5レベル
- 削除制御: 下位テリトリ存在時は削除不可

INV-T2: 割当整合性
- Account毎に有効なTerritoryAssignmentは1つのみ
- AssignmentRule.Priority重複禁止（同一Territory内）
- 無効なTerritoryへの新規割当禁止

INV-T3: メンバー権限
- Territory Owner必須（最低1人）
- User削除時の関連TerritoryMember自動削除
- 権限レベルの順序性保証（Owner > Manager > Member > Viewer）

INV-T4: ルール条件式
- 条件式構文の妥当性検証
- 参照項目の存在確認
- 条件式実行時のエラーハンドリング
```

---

## 7. システム共通：監査・履歴・不変条件

### 7.1 項目履歴（Field History Tracking）

#### 7.1.1 履歴追跡対象項目
```
Account:
- Name, ParentId, Type, Industry, AnnualRevenue
- BillingAddress（変更のみ）
- Owner, AccountTeam変更

Opportunity:  
- Name, StageName, Amount, CloseDate, Probability
- Owner, AccountId, ForecastCategory
- NextStep, Description（重要更新のみ）

Lead:
- Status, Rating, Owner
- Company, LeadSource
- ConvertedDate, ConvertedAccountId

Contact:
- Name, Title, Email, Phone（主要連絡先）
- AccountId, Owner
- DoNotCall, HasOptedOutOfEmail

Quote:
- Status, GrandTotal, ExpirationDate  
- IsSyncing, IsAccepted
- PresentedDate, AcceptedDate

User/Security:
- Profile, Role変更
- PermissionSet追加・削除
- PasswordChanged, LastLogin
```

#### 7.1.2 履歴データ構造
```
FieldHistory共通項目:
- ParentId: 対象レコードId
- FieldName: 変更項目名
- OldValue: 変更前値
- NewValue: 変更後値  
- ChangeType: "Created", "Updated", "Deleted"
- ModifiedBy: 変更実行者
- ModifiedDate: 変更日時
- ChangeReason: 変更理由（任意）

保持期間:
- 重要項目: 7年間保持
- 一般項目: 2年間保持
- アーカイブ処理によるコスト最適化
```

### 7.2 ビジネスイベント監査

#### 7.2.1 監査対象イベント
```
重要ビジネスイベント:
- Lead Conversion実行
- Opportunity Stage変更（特にClosed Won/Lost）
- Quote承認・発注
- Territory割当変更
- Forecast提出・承認
- Mass Update実行
- Import/Export実行

セキュリティイベント:
- User Login/Logout
- 権限変更（Profile, PermissionSet, Sharing）
- Configuration変更（Workflow, Validation Rule等）
- API Access・認証失敗
- データエクスポート実行
```

#### 7.2.2 監査ログ構造
```
EventLog共通項目:
- EventType: イベント分類
- EventDate: 発生日時  
- UserId: 実行者
- TargetId: 対象レコード
- Details: 詳細情報（JSON形式）
- SessionId: セッション識別子
- Source: "UI", "API", "Bulk", "Automation"
- ResultStatus: "Success", "Failed", "Warning"

アクセスレベル:
- システム管理者: 全イベント参照可能
- セキュリティ担当: セキュリティイベントのみ
- 一般ユーザ: 自分の実行したイベントのみ
```

### 7.3 データ整合性・不変条件エンジン

#### 7.3.1 不変条件実行パイプライン
```
保存パイプライン順序:
1. Authorization Check（権限確認）
2. Field-Level Security Check（項目レベル権限）
3. Validation Rules（入力値検証）
4. Before Triggers（保存前処理）
5. Invariants Check（不変条件検証）←★
6. Database Persistence（DB保存）
7. After Triggers（保存後処理）
8. Async Processing（非同期処理）
9. Audit Logging（監査ログ）

不変条件違反時:
- 即座に例外発生、処理中止
- エラーメッセージ表示
- トランザクション全体をロールバック
- 違反内容をErrorLogに記録
```

#### 7.3.2 参照整合性管理
```
外部キー整合性:
- 削除時の連鎖制御（CASCADE, RESTRICT, SET NULL）
- 孤立レコードの検出・修復
- 定期的な整合性チェックバッチ

論理削除（Soft Delete）:
- IsDeleted = true による論理削除
- 物理削除は管理者のみ実行可能  
- 削除レコードの復旧機能
- 削除から物理削除までのグレースピリオド（30日）

楽観ロック制御:
- SystemModstamp による同時更新検出
- 競合時のマージ機能
- 最終更新者の明示
```

### 7.4 パフォーマンス・運用考慮事項

#### 7.4.1 大量データ処理
```
バルク処理制御:
- 1回のTransactionで最大10,000件まで
- バッチサイズの動的調整
- 処理進捗の可視化
- エラー時のリトライ機構

インデックス戦略:
- 頻繁な検索条件にインデックス設定
- 複合インデックスによる最適化
- インデックスメンテナンスの自動化
- パフォーマンス監視・アラート
```

#### 7.4.2 障害・復旧対応
```
障害時対応:
- 不変条件違反時の自動修復機能
- データ不整合の検出・通知
- 手動修復ツールの提供
- 修復履歴の記録

バックアップ・復旧:
- 日次フルバックアップ
- 増分バックアップ（6時間毎）
- ポイントインタイム復旧機能
- 災害復旧手順の文書化・テスト
```

---

## 8. まとめ：実装ガイドライン

### 8.1 開発優先順位
1. **Phase 1**: コアオブジェクト状態遷移（Lead, Opportunity, Activity）
2. **Phase 2**: 見積・受注プロセス、基本監査機能
3. **Phase 3**: 予測・テリトリ管理、高度監査機能

### 8.2 品質保証基準
- 全不変条件のユニットテスト実装
- 状態遷移マトリクスの完全カバレッジテスト
- 負荷テスト（同時ユーザ1000人、大量データ処理）
- セキュリティテスト（権限・アクセス制御の検証）

### 8.3 運用・監視要件
- リアルタイム不変条件監視ダッシュボード
- 異常状態の自動検出・アラート機能
- 定期的なデータ整合性チェック（週次・月次）
- パフォーマンス劣化の早期検出機構