# 要件定義書 v1：CRM（Sales Cloud相当）Core Platform

## 1. 背景

エンタープライズ営業において、案件進捗（Lead→Opportunity→Quote→Order）、活動履歴、権限・共有、承認、検索、レポーティングを一貫して管理できるCRMが必要である。既存のCRMはカスタマイズ/運用コスト・統制・データガバナンス・連携要件等により、自社要件に最適化したシステム実装が望ましい。

本プロジェクトは、Sales Cloud相当の機能群を備えたCRMを、**単独で実装開始できる粒度で要件定義・設計**することを目的とする。

---

## 2. 目的

### 2.1 事業目的

* 営業活動の標準化と可視化により、受注確度・売上予測の精度を高め、案件クローズ率・営業生産性を向上する。
* 権限・監査・承認を含む統制を強化し、属人化/不正/情報漏洩リスクを低減する。
* CRMデータを一貫モデルで保持し、検索・レポート・外部連携の基盤として活用する。

### 2.2 システム目的

* **Sales Cloud相当**の主要機能（オブジェクト、パイプライン、活動、権限・共有、承認、検索、レポート）を提供する。
* すべての読み書きにおいて、**Object/Field/Recordの権限**が一貫して適用され、経路差（API/検索/レポート等）による漏洩を起こさない。

---

## 3. ゴール（達成状態）

### 3.1 必須ゴール（Functional）

1. 主要営業データモデル（Account/Contact/Lead/Opportunity/Quote/Order/Activity/Product/Pricebook）が定義され、CRUD・関連操作が可能
2. 権限・共有（Object/Field/Record + Sharing）が実装され、見えないレコードは常に不可視（404）
3. Validation/Workflow（同期）により、入力品質と業務ルールを強制できる
4. 承認（Approval）により、申請・承認・却下・ロックが可能
5. 検索（Search）・レポート（Report）は最終的にCoreで再評価され、漏洩が起きない
6. 監査（Audit）とイベント（Outbox + Domain Events）が実装され、周辺サービスが追随可能

### 3.2 非機能ゴール（Quality）

* 監査証跡（いつ、誰が、何を、どう変えたか）を完全に追える
* 高頻度アクセス（一覧/検索/更新）でも安定運用できる
* 将来のマイクロサービス分割に耐える（モジュラーモノリス + 非同期周辺）

---

## 4. スコープ

### 4.1 対象（In Scope）

#### A) データ・業務機能

* 標準オブジェクト（Sales Cloud相当）

  * Account（取引先）
  * Contact（取引先責任者）
  * Lead（リード）
  * Opportunity（商談）
  * Quote（見積）
  * Order（受注）
  * Task / Event（活動）
  * Product / Pricebook / PricebookEntry（商品・価格表）
  * （必要に応じて）Campaign（キャンペーン）
* 関連（代表例）

  * OpportunityLineItem、QuoteLineItem、OrderItem
  * OpportunityContactRole、OpportunityTeamMember、AccountTeamMember
* プロセス

  * Lead Convert（リードの取引先/責任者/商談への変換）
  * 商談ステージ遷移（Stage/Close）
  * 見積→受注（Quote/Order）
* 監査

  * フィールド履歴、変更ログ、操作ログ

#### B) 統制・設定

* Object Permission（C/R/U/D/ViewAll/ModifyAll）
* Field Permission（Readable/Editable）
* Record Access（OWD + Role + Group + Team + Territory + Sharing Rules + Manual Share + Implicit）
* 承認（申請/承認/却下/差戻し/ロック）
* メタデータ（Object/Field/Layout/Validation/Workflow/Approval定義）読み取り

  * 正本は別サービス（Metadata/Admin）だが、Coreで参照・キャッシュする

#### C) API/検索/レポート

* CRUD / Query / Bulk（基本）
* Search：候補IDを返し、明細はCoreで再評価
* Report：定義・実行（Reporting Service）。明細はCoreで再評価

#### D) アーキテクチャ

* Core Platform（Single Writer、モジュラーモノリス）
* Outbox パターンによるイベント発行
* 周辺（Sharing/Search/Reporting/Automation/Approval）はイベント駆動で追随

### 4.2 対象外（Out of Scope：v1でやらない）

* Apex/Flow相当の汎用プログラマブル拡張（任意コード）
* 高度なDWH/OLAP（大規模集計のリアルタイム最適化）
* 複雑なCPQ（価格計算ルールの高度化）
* マーケティングオートメーション（別領域）
* モバイルアプリ/外部公開ポータル（必要なら別要件）

---

## 5. ステークホルダと利用者像

* 営業担当（AE）：案件・活動・見積・受注の入力/閲覧
* 営業マネージャ：パイプライン管理、レポート/予測、共有管理（限定）
* 営業企画/オペレーション：項目設計、ルール/承認設定、データ品質管理
* 管理者（SysAdmin）：権限、共有、監査、設定管理
* 監査/コンプライアンス：監査ログ参照、権限/共有の妥当性確認
* 外部連携（BI/データ基盤/会計等）：イベント/ API で連携

---

## 6. 前提・制約

* マルチテナントを前提とし、すべてのデータに `tenant_id` を付与する
* 書き込みは **Coreのみ（Single Writer）** とする
* 検索/レポート等の派生系は遅延があり得る（最終整合）。ただし漏洩は許容しない
* 重要な整合（監査、イベント）は保存トランザクション内で担保する（Outbox）

---

## 7. 機能要件（Functional Requirements）

### FR-1：オブジェクト管理（CRUD）

* FR-1.1：各標準オブジェクトの作成/参照/更新/削除（論理削除）を提供する
* FR-1.2：関連（子）データを整合的に管理する（LineItem等）
* FR-1.3：更新は `recordVersion`（system_modstamp等）による楽観ロックを必須とする

### FR-2：一覧・検索・クエリ

* FR-2.1：フィルタ/ソート/ページングを備えた一覧取得ができる
* FR-2.2：検索は「候補ID取得」と「明細取得（Coreで再評価）」を分離する
* FR-2.3：クエリは許可されたフィールドのみ指定できる（メタデータに従う）

### FR-3：権限（Object/Field）

* FR-3.1：Object Permission（C/R/U/D/ViewAll/ModifyAll）を適用する
* FR-3.2：Field Permission（Readable/Editable）を適用する
* FR-3.3：Readableでないフィールドはレスポンスから除外（マスク）する
* FR-3.4：Editableでないフィールド更新は拒否する（サイレント無視しない）

### FR-4：共有（Record Access）

* FR-4.1：OWD（Private / Public Read Only / Public Read-Write / Controlled by Parent）を実装する
* FR-4.2：Role Hierarchyによるアクセス（GAUH設定）を実装する
* FR-4.3：Public Group / Queue による共有主体を実装する
* FR-4.4：Sharing Rules（Owner-based / Criteria-based）、Manual Share、Team、Territory を実装する
* FR-4.5：見えないレコードは Read でも 404 とする（存在を漏らさない）
* FR-4.6：Search/Report 経由でも最終的にCoreでRecordAccess再評価する

### FR-5：Validation Rules

* FR-5.1：保存前に Validation Rules を評価し、違反時は保存を拒否する
* FR-5.2：エラーはルール単位に集約し、どの項目/どのルールか分かる形式で返す

### FR-6：Workflow（同期/非同期）

* FR-6.1：beforeSave の同期Workflowとして Field Update を提供する
* FR-6.2：afterSave ではレコード再更新を禁止し、通知/Webhook/タスク等は非同期へ委譲する
* FR-6.3：同一フィールドの複数更新は lastWriteWins とし、衝突ログを残す

### FR-7：承認（Approval）

* FR-7.1：申請/承認/却下/差戻し/取り下げを提供する
* FR-7.2：承認中はロック状態を保持し、対象フィールドの更新を拒否する
* FR-7.3：承認イベント（ApprovalSubmitted/Decided）を発行し、Coreが制約を適用する

### FR-8：監査（Audit）

* FR-8.1：フィールド履歴（prior→final）を記録する
* FR-8.2：操作ログ（誰がいつどのAPI/操作で何をしたか）を記録する
* FR-8.3：監査ログの閲覧は権限で制御する

### FR-9：イベント（Outbox / Domain Events）

* FR-9.1：保存成功時、同一トランザクションで outbox にイベントを記録する
* FR-9.2：RecordCreated/Updated/Deleted、OwnerChanged、StageChanged、LeadConverted などを発行する
* FR-9.3：イベントは at-least-once 配信を前提とし、受信側は冪等に処理する

### FR-10：レポート（Reporting）

* FR-10.1：Tabular/Summary/Matrixの定義と実行を提供する（Reporting Service）
* FR-10.2：集計の明細取得は Core Query を通して可視行のみを対象とする（漏洩防止）

---

## 8. 非機能要件（NFR）

### NFR-1：セキュリティ

* NFR-1.1：テナント分離（全テーブル tenant_id、全クエリに強制付与）
* NFR-1.2：最小権限（Object/Field/Record で常に評価）
* NFR-1.3：機密情報はイベントpayloadに極力載せない（必要ならCore参照）
* NFR-1.4：監査ログ改ざん耐性（追記型、権限制御、保全）

### NFR-2：可用性・信頼性

* NFR-2.1：Outboxにより「保存成功したのにイベントが出ない」を防ぐ
* NFR-2.2：周辺は遅延してもCoreの正しさは崩れない（最終関門はCore）

### NFR-3：性能

* NFR-3.1：主要画面（一覧/詳細/更新）が安定した応答時間で動作
* NFR-3.2：共有評価はホットパスのため、SubjectSetキャッシュとshares索引を必須
* NFR-3.3：検索/レポートは非同期やキャッシュでスケールできる

### NFR-4：拡張性・保守性

* NFR-4.1：Coreはモジュラーモノリス（D4）として境界/禁止依存を守る
* NFR-4.2：メタデータ・周辺はイベント駆動で拡張できる
* NFR-4.3：スキーマは schemaVersion を持ち後方互換を考慮

### NFR-5：運用性

* NFR-5.1：DLQ/再同期（Rebuild/Reindex）を持ち、欠落/遅延を復旧できる
* NFR-5.2：観測性（CorrelationId、メトリクス、トレース）を標準化する

---

## 9. 受入条件（Acceptance Criteria：最低ライン）

* AC-1：権限の経路差がない（API/検索/レポートで漏洩しない）
* AC-2：見えないレコードは常に404（存在を漏らさない）
* AC-3：Editableでないフィールド更新は拒否（エラーが明確）
* AC-4：承認ロックがWriteに確実に効く
* AC-5：Outboxイベントが保存と同一TXで記録され、重複/遅延に耐える
* AC-6：Validation/Workflowの評価順と衝突解決が仕様通り

---

## 10. 仕様参照（本書の位置づけ）

* D1〜D4：アーキテクチャ/サービス境界/イベント/コアモジュール設計
* E2：権限・共有の決定表
* E3：Validation/Workflow DSL
* E4：Query/Reportエンジン仕様
* E5：エッジケース集

> 本要件定義書は「何を実現するか（What）」を中心に、実装可能な範囲で「どう担保するか（Howの制約）」も含めています。

---

# 用語集（Glossary）

## 事業・業務

* **AE**：Account Executive。営業担当
* **Pipeline**：商談の進行状況（ステージ）と予測の集合
* **Forecast**：売上予測。主に商談の確度/金額/期日から算出

## オブジェクト（データ）

* **Account（取引先）**：顧客企業
* **Contact（取引先責任者）**：顧客側担当者
* **Lead（リード）**：見込み顧客（未確定の顧客情報）
* **Opportunity（商談）**：案件。金額・ステージ・確度・期日等を持つ
* **Quote（見積）**：見積書相当。明細（QuoteLineItem）を持つ
* **Order（受注）**：受注/契約相当。明細（OrderItem）を持つ
* **Task/Event（活動）**：電話/メール/訪問/会議などの活動履歴
* **Product**：商品マスタ
* **Pricebook**：価格表
* **PricebookEntry**：価格表における商品価格行
* **LineItem**：明細（OpportunityLineItem / QuoteLineItem / OrderItem）

## 権限・共有

* **Object Permission**：オブジェクトに対するC/R/U/Dなどの権限
* **Field Permission**：項目に対する閲覧/編集可否
* **Record Access**：特定レコードに対する閲覧/編集可否
* **OWD**：Organization-Wide Default。全社既定の公開範囲
* **Role Hierarchy**：ロール階層（上長が下位のレコードへアクセスできる仕組み）
* **GAUH**：Grant Access Using Hierarchies。ロール階層アクセスを適用するかの設定
* **Public Group**：公開グループ。共有主体の集合
* **Queue**：キュー。所有者になり得る主体（例：未割当リード）
* **Sharing Rule**：共有ルール（所有者条件/条件式により共有を付与）
* **Manual Share**：手動共有（個別付与）
* **Team**：チーム共有（Account Team / Opportunity Team 等）
* **Territory**：担当領域（テリトリ）。アカウント/ユーザ割当による共有
* **Implicit Sharing**：暗黙共有（親が見えるなら子も見える、など）
* **Share Row（object_shares）**：共有付与の実体行

## 自動化・承認・監査

* **Validation Rule**：保存を拒否するルール（条件式が真ならエラー）
* **Workflow Rule**：条件一致でアクション実行（Field Update/通知等）
* **BeforeSave / AfterSave**：保存前/後のトリガタイミング
* **Approval**：承認プロセス（申請→承認/却下）
* **Lock（承認ロック）**：承認中の編集制限
* **Audit Log**：監査ログ（誰がいつ何をどう変えたか）
* **Field History**：フィールド値の履歴（prior→final）

## アーキテクチャ・イベント

* **Single Writer**：書き込み入口をCoreに集約する原則
* **Modular Monolith（モジュラーモノリス）**：1プロセスでもモジュール境界を厳格に保つ設計
* **Outbox**：保存TX内でイベントをDBに書き、後で確実に配信するパターン
* **Domain Event**：業務状態変化を表すイベント（RecordUpdated等）
* **At-least-once**：イベント配信が少なくとも1回届く方式（重複し得る）
* **Idempotency**：重複しても副作用が増えない性質
* **DLQ**：Dead Letter Queue。処理不能イベントの隔離

---

## 補足：次のステップ

この要件定義書を「実装に渡す」観点で強くするなら、以下のドキュメントが推奨されます：

1. **ユースケース一覧＋業務フロー（Lead→Opp→Quote→Order、承認、共有）**
2. **画面一覧・API一覧のトレーサビリティ表（要件→API→モジュール）**

特に 2) を推奨します。実装分担と漏れ検出が一気に進みます。

