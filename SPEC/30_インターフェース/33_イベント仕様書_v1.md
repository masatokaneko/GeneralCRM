# イベント仕様書 v1（Domain Events / Integration Events）

## 0. 目的

* 周辺サービス（Sharing/Search/Automation/Approval/Reporting）が、Coreの変更に確実に追随できる
* 非同期でも整合が崩れないように、**最低限の順序・冪等・再試行・バージョン**を定義する

---

# 1. 基本仕様（全イベント共通）

## 1.1 配信モデル

* 配信：**At-least-once（少なくとも1回）**
* 受信側：**冪等**（同一event_idは1回しか副作用を起こさない）
* 順序：原則保証しない（必要な箇所のみ“キー順序”で実現）

## 1.2 イベントの種類

* **Domain Event**：Coreの保存トランザクションから発行（正本の状態変化）
* **Integration Event**：他サービス（Metadata/Approval/Sharing等）が発行する設定/派生状態変化

## 1.3 エンベロープ（共通フォーマット）

すべてのイベントは以下の共通ヘッダを持つ：

```json
{
  "eventId": "uuid",
  "schemaVersion": 1,
  "eventType": "RecordUpdated",
  "occurredAt": "2026-01-10T12:34:56.789Z",
  "tenantId": "uuid",
  "producer": {
    "service": "core-platform",
    "instanceId": "pod-xyz"
  },
  "correlationId": "uuid",
  "sequence": {
    "partitionKey": "Opportunity:tenantId:recordId",
    "recordVersion": "2026-01-10T12:34:56.789Z"
  },
  "payload": { }
}
```

### フィールドの意味

* `eventId`：全世界一意。冪等のキー
* `schemaVersion`：payloadスキーマのバージョン
* `correlationId`：リクエスト追跡（API→Outbox→配信）
* `sequence.partitionKey`：順序が必要な場合に用いるキー（同一キー内は順序配信する実装も可能）
* `sequence.recordVersion`：**system_modstamp**（楽観ロックと整合）

---

# 2. Outbox仕様（Coreの発行保証）

## 2.1 書き込み

* Coreはレコード保存TXと同一TXで `outbox_events` にINSERTする

## 2.2 配信

* Outbox Publisherが未配信行を読み、Event Busへpublish
* publish成功後に `published_at` を更新（失敗時は未配信のまま）

## 2.3 再送

* publishが重複しても良い（At-least-once）
* 受信側が `eventId` で重複排除する

---

# 3. 受信側の冪等ルール（必須）

## 3.1 processed_events（受信ログ）

各サービスは `processed_events(tenant_id, event_id)` を保持し、処理済みならスキップ。

## 3.2 冪等副作用の例

* Search：doc upsertは同一recordVersionなら上書きでOK
* Sharing：shares再生成は version+cause をキーにし、同じ生成を二重に入れない
* Automation：通知は `(eventId, actionKey)` をキーに二重送信を防ぐ
* Reporting：集計は recordVersionで“最新のみ採用”

---

# 4. イベント一覧（v1）

以下は **必須イベント**。全て `schemaVersion=1` を定義する。

---

## 4.1 RecordCreated（Domain / Core）

### 発行条件

* 標準オブジェクトのCreate成功

### payload

```json
{
  "objectName": "Opportunity",
  "recordId": "uuid",
  "ownerId": "uuid",
  "fields": {
    "Name": "Deal A",
    "StageName": "Qualification",
    "CloseDate": "2026-02-28"
  },
  "changedFields": ["Name","StageName","CloseDate"],
  "recordVersion": "2026-01-10T12:34:56.789Z"
}
```

### 購読先（代表）

* Sharing（初期共有生成）
* Search（インデックス作成）
* Reporting（増分集計）
* Automation（通知/タスク生成の条件）
* Approval（申請可否計算は任意）

---

## 4.2 RecordUpdated（Domain / Core）

### 発行条件

* Update成功（sync automation反映後の確定状態）

### payload

```json
{
  "objectName": "Opportunity",
  "recordId": "uuid",
  "ownerId": "uuid",
  "changedFields": ["StageName","Probability","ForecastCategoryName"],
  "fieldChanges": {
    "StageName": { "old": "Qualification", "new": "Negotiation" },
    "Probability": { "old": 10, "new": 50 }
  },
  "recordVersion": "2026-01-10T12:35:10.123Z"
}
```

### 注意

* `fieldChanges` は“出せる範囲だけ”で良い（全フィールド差分は不要）
* 受信側は必要ならCoreへ参照しに行く

### 購読先

* Sharing / Search / Reporting / Automation / Approval

---

## 4.3 RecordDeleted（Domain / Core）

### payload

```json
{
  "objectName": "Opportunity",
  "recordId": "uuid",
  "deleted": true,
  "recordVersion": "2026-01-10T12:40:00.000Z"
}
```

購読先：

* Sharing（share行無効化）
* Search（削除）
* Reporting（除外）
* Automation（必要なら通知）

---

## 4.4 OwnerChanged（Domain / Core）

※ RecordUpdatedの派生イベント。**Owner変更は頻出＋共有再計算のトリガ**なので専用化。

### payload

```json
{
  "objectName": "Account",
  "recordId": "uuid",
  "oldOwnerId": "uuid",
  "newOwnerId": "uuid",
  "recordVersion": "..."
}
```

購読先：

* Sharing（最重要：Owner由来共有更新）
* Automation（担当変更通知）
* Reporting（任意）

---

## 4.5 StageChanged（Domain / Core）

### payload

```json
{
  "opportunityId": "uuid",
  "accountId": "uuid",
  "oldStageName": "Negotiation",
  "newStageName": "Closed Won",
  "oldIsClosed": false,
  "newIsClosed": true,
  "oldIsWon": false,
  "newIsWon": true,
  "closeDate": "2026-01-31",
  "recordVersion": "..."
}
```

購読先：

* Reporting（パイプライン/受注予測）
* Automation（通知、タスク生成）
* Search（重要度の更新は任意）

---

## 4.6 LeadConverted（Domain / Core）

### payload

```json
{
  "leadId": "uuid",
  "convertedAt": "2026-01-10T13:00:00Z",
  "convertedBy": "uuid",
  "accountId": "uuid",
  "contactId": "uuid",
  "opportunityId": "uuid",
  "recordVersion": "..."
}
```

購読先：

* Search（Lead非表示化/関連更新）
* Reporting（コンバージョン集計）
* Automation（通知）

---

## 4.7 ApprovalSubmitted（Integration / Approval Service）

### payload

```json
{
  "approvalInstanceId": "uuid",
  "target": { "objectName": "Quote", "recordId": "uuid" },
  "submittedBy": "uuid",
  "submittedAt": "2026-01-10T14:00:00Z",
  "lockedFields": ["DiscountPercent","GrandTotal"],
  "currentStageIndex": 0
}
```

購読先：

* Core（ロック適用：編集禁止）
* Automation（Approver通知）
* Reporting（承認中フラグは任意）
* Search（承認中ラベル更新は任意）

---

## 4.8 ApprovalDecided（Integration / Approval Service）

### payload

```json
{
  "approvalInstanceId": "uuid",
  "target": { "objectName": "Quote", "recordId": "uuid" },
  "decision": "APPROVED",
  "decidedBy": "uuid",
  "decidedAt": "2026-01-10T15:00:00Z",
  "comment": "OK",
  "finalStageIndex": 1
}
```

購読先：

* Core（承認結果の反映が必要ならCore側で更新）
* Automation（通知）
* Reporting（承認完了件数）

---

## 4.9 MetadataChanged（Integration / Metadata Service）

### payload

```json
{
  "changeType": "FieldAdded",
  "objectName": "Opportunity",
  "resourceId": "fieldId",
  "effectiveAt": "2026-01-10T16:00:00Z"
}
```

購読先：

* Core（Describeキャッシュ失効）
* Search（インデックス定義更新）
* Reporting（レポート定義の妥当性再検証）
* Sharing/Automation（必要なら設定再読込）

---

## 4.10 PermissionChanged（Integration / Metadata Service）

### payload

```json
{
  "changeType": "PermissionSetUpdated",
  "subject": { "type": "User", "id": "uuid" },
  "effectiveAt": "..."
}
```

購読先：

* Core（権限キャッシュ失効）
* Sharing（役割/グループ影響があれば再計算）
* Approval（Approver解決再計算）

---

## 4.11 SharingUpdated（Integration / Sharing Service）

※必須ではないが、Search/Reportingで"候補絞り込み"をやるなら有用。

### payload

```json
{
  "objectName": "Opportunity",
  "recordId": "uuid",
  "shareModelVersion": 12,
  "updatedAt": "..."
}
```

購読先：

* Search（可視性キャッシュがある場合）
* Reporting（スナップショットの整合が必要なら）

---

## 4.12 RoleHierarchyChanged（Integration / Metadata Service）

ロール階層の変更時に発行。共有再計算のトリガとなる。

### 発行条件

* ロールの作成/更新/削除
* ロール間の親子関係変更

### payload

```json
{
  "changeType": "RoleCreated",
  "roleId": "uuid",
  "roleName": "Sales Manager",
  "parentRoleId": "uuid",
  "effectiveAt": "2026-01-10T16:00:00Z"
}
```

### changeType

* `RoleCreated` / `RoleUpdated` / `RoleDeleted` / `ParentChanged`

### 購読先

* Sharing（ロール階層に基づく共有再計算）
* Core（権限キャッシュ失効）
* Approval（Approver解決再計算）

---

## 4.13 GroupMemberChanged（Integration / Metadata Service）

Public Group / Queue のメンバー変更時に発行。

### 発行条件

* グループへのユーザ/ロール追加/削除

### payload

```json
{
  "changeType": "MemberAdded",
  "groupId": "uuid",
  "groupName": "Sales Team",
  "groupType": "public",
  "memberType": "User",
  "memberId": "uuid",
  "effectiveAt": "2026-01-10T16:00:00Z"
}
```

### changeType

* `MemberAdded` / `MemberRemoved`

### 購読先

* Sharing（グループベースの共有再計算）
* Core（権限キャッシュ失効）

---

## 4.14 TeamMemberChanged（Integration / Core）

商談チーム（OpportunityTeam）/ 取引先チーム（AccountTeam）のメンバー変更時に発行。

### 発行条件

* チームメンバーの追加/更新/削除

### payload

```json
{
  "changeType": "MemberAdded",
  "objectName": "Opportunity",
  "recordId": "uuid",
  "userId": "uuid",
  "teamRole": "Sales Rep",
  "accessLevel": "Read",
  "effectiveAt": "2026-01-10T16:00:00Z"
}
```

### changeType

* `MemberAdded` / `MemberUpdated` / `MemberRemoved`

### 購読先

* Sharing（チームベースの共有更新）

---

## 4.15 TerritoryAssignmentChanged（Integration / Sharing Service）

テリトリ割当の変更時に発行。

### 発行条件

* ユーザのテリトリ割当変更
* 取引先のテリトリ割当変更
* テリトリ階層の変更

### payload

```json
{
  "changeType": "UserAssigned",
  "territoryId": "uuid",
  "territoryName": "Japan - West",
  "assignmentType": "User",
  "assignedId": "uuid",
  "effectiveAt": "2026-01-10T16:00:00Z"
}
```

### changeType

* `UserAssigned` / `UserUnassigned` / `AccountAssigned` / `AccountUnassigned` / `TerritoryHierarchyChanged`

### 購読先

* Sharing（テリトリベースの共有再計算）
* Core（権限キャッシュ失効）

---

## 4.16 SharingConfigChanged（Integration / Metadata Service）

共有設定の変更時に発行。大規模な共有再計算のトリガとなりうる。

### 発行条件

* OWD（組織全体のデフォルト）変更
* 共有ルールの作成/更新/削除
* チームロール設定の変更

### payload

```json
{
  "changeType": "OWDChanged",
  "objectName": "Opportunity",
  "oldOWD": "Private",
  "newOWD": "ReadOnly",
  "effectiveAt": "2026-01-10T16:00:00Z"
}
```

### changeType

* `OWDChanged` / `ShareRuleCreated` / `ShareRuleUpdated` / `ShareRuleDeleted` / `TeamRoleSettingChanged`

### 購読先

* Sharing（共有モデルの再構築）
* Core（権限キャッシュ失効）

---

## 4.17 AutomationConfigChanged（Integration / Metadata Service）

自動化設定の変更時に発行。

### 発行条件

* バリデーションルールの作成/更新/削除/有効化/無効化
* ワークフロールールの作成/更新/削除/有効化/無効化
* スケジュールジョブの作成/更新/削除

### payload

```json
{
  "changeType": "ValidationRuleUpdated",
  "objectName": "Opportunity",
  "automationType": "ValidationRule",
  "automationId": "uuid",
  "automationName": "VR-OPP-01",
  "isActive": true,
  "effectiveAt": "2026-01-10T16:00:00Z"
}
```

### changeType

* `ValidationRuleCreated` / `ValidationRuleUpdated` / `ValidationRuleDeleted`
* `WorkflowRuleCreated` / `WorkflowRuleUpdated` / `WorkflowRuleDeleted`
* `ScheduledJobCreated` / `ScheduledJobUpdated` / `ScheduledJobDeleted`

### 購読先

* Automation Service（設定キャッシュ更新）
* Core（バリデーションキャッシュ失効）

---

## 4.18 ApprovalConfigChanged（Integration / Metadata Service）

承認プロセス設定の変更時に発行。

### 発行条件

* 承認プロセス定義の作成/更新/削除/有効化/無効化
* 承認ステップの変更

### payload

```json
{
  "changeType": "ProcessUpdated",
  "objectName": "Quote",
  "processId": "uuid",
  "processName": "Quote Discount Approval",
  "isActive": true,
  "effectiveAt": "2026-01-10T16:00:00Z"
}
```

### changeType

* `ProcessCreated` / `ProcessUpdated` / `ProcessDeleted` / `ProcessActivated` / `ProcessDeactivated`

### 購読先

* Approval Service（承認プロセス定義の再読込）
* Core（申請可否判定ロジックの更新）

---

## 4.19 SharingRebuildCompleted（Integration / Sharing Service）

共有モデルの再構築完了時に発行。バージョン切替のトリガとなる。

### 発行条件

* 共有再計算ジョブの完了

### payload

```json
{
  "rebuildJobId": "uuid",
  "objectName": "Account",
  "scope": "full",
  "oldVersion": 11,
  "newVersion": 12,
  "recordsProcessed": 50000,
  "completedAt": "2026-01-10T17:00:00Z"
}
```

### scope

* `full`：オブジェクト全体の再構築
* `incremental`：差分更新

### 購読先

* Core（共有バージョン切替）
* Search（可視性キャッシュのリフレッシュ）
* Reporting（スナップショットの再取得が必要な場合）

---

## 4.20 CampaignMemberChanged（Domain / Core）

キャンペーンメンバーの変更時に発行。

### 発行条件

* キャンペーンメンバーの追加/更新/削除
* メンバーステータスの変更

### payload

```json
{
  "changeType": "MemberAdded",
  "campaignId": "uuid",
  "campaignName": "Spring 2026 Webinar",
  "memberType": "Lead",
  "memberId": "uuid",
  "memberStatus": "Registered",
  "hasResponded": false,
  "recordVersion": "2026-01-10T12:34:56.789Z"
}
```

### changeType

* `MemberAdded` / `MemberUpdated` / `MemberRemoved` / `StatusChanged` / `Responded`

### 購読先

* Reporting（キャンペーン効果測定）
* Automation（フォローアップ通知）
* Search（メンバー検索の更新）

---

# 5. 順序保証（必要な箇所だけ）

## 5.1 必須：同一レコード内の順序

* `partitionKey = "{ObjectName}:{tenantId}:{recordId}"`
* 可能なら同一partitionKey内は順序配信（Kafkaのkey相当）
* 不可能でも `recordVersion` で受信側が **古いイベントを捨てる**（必須）

## 5.2 受信側の採用ルール（必須）

* 同一(recordId)について、受信側が保持する `lastAppliedRecordVersion` より古いイベントは無視

---

# 6. リトライ・DLQ（デッドレター）

## 6.1 リトライ

* 一時エラー（外部依存、DBロック等）は指数バックオフで最大N回（例：10回）
* 恒久エラー（スキーマ不整合）はDLQへ

## 6.2 DLQ運用（必須）

* DLQに入ったイベントは

  * 再投入（手動/自動）
  * スキップ（監査残す）
    を選べる

---

# 7. セキュリティ（payloadの機密）

* イベントpayloadには **機密フィールドを極力載せない**
* Search/Reporting/Automationが必要なら **Coreに取りに行く**
* どうしても載せる場合は暗号化orサービス間閉域を必須

---

# 8. 受入条件（イベント）

1. Coreの保存成功時にOutboxへ確実に記録され、配信される
2. 受信側は eventId で重複排除できる
3. recordVersionで古いイベントを無視できる
4. Sharing/Search/Automation/Approval/Reporting が必要イベントを購読して整合が取れる
5. DLQ運用が可能で、失敗イベントが滞留しても全体が止まらない
