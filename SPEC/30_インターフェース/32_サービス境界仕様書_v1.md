# サービス境界仕様書 v1（責務・API・DB・依存関係）

## 0. ゴール

* 「誰がどのサービスを作り、どこまでを責任範囲にするか」を固定する
* コア整合（保存パイプライン）と周辺非同期（共有/検索/通知）を破綻させない

---

# 1. 全体構成（論理）

```
[Client/UI/Integrations]
        |
     (API Gateway)
        |
   +-------------------+
   |   Core Platform   |  <--- Single Writer（業務データの書き込み入口）
   +-------------------+
        |  (Outbox Events)
        v
   [Event Bus / Queue]  -----> Sharing Service
        |                     Automation Service
        |                     Approval Service
        |                     Search Service
        |                     Reporting Service
        v
   Metadata & Admin Service (設定変更イベント発行)
```

---

# 2. 共通ポリシー（全サービス共通で必須）

## 2.1 テナント境界

* すべてのデータ・APIは `tenant_id` を必須で扱う（token or header）

## 2.2 追跡

* `X-Correlation-Id` を全サービスへ伝播
* `event_id` による冪等（受信側）

## 2.3 読み取りの最終関門

* **クライアントに返す“レコード明細”はCoreで最終権限評価**（Search/Reportsは候補IDまで）

## 2.4 エラーフォーマット

* API仕様書 v1 の統一エラー形式を全サービスで踏襲

---

# 3. サービス一覧（責務と境界）

## S1. Core Platform（単一書き込み面 / モジュラーモノリス）

### 3.1 主要責務（Must）

* 標準オブジェクトCRUD：Account/Contact/Lead/Opportunity/Task/Event/Quote/Order/Product/Pricebook
* 保存パイプライン（AuthZ→Normalization→Validation→Automation(sync)→Persist→Audit）
* Query（List/Filter/Sort/Related）
* GetById（最終RecordAccess評価）
* Domain Event発行（Outbox）

### 3.2 非責務（やらない）

* 共有行の大規模再計算（Sharing Service）
* 検索エンジンインデックス管理（Search Service）
* 大規模レポート集計（Reporting Service）
* 非同期通知/スケジュール（Automation Service）
* 承認ワークアイテム管理（Approval Service）

### 3.3 内部モジュール境界（Core内）

* Accounts / Contacts / Leads / Opportunities / Activities / Quotes / Orders / Products / Pricebooks
* Cross-cutting：AuthZ、Validation Engine、Workflow Engine(sync)、Audit、Outbox

### 3.4 Core API（外部公開）

* `GET/POST/PATCH/DELETE /v1/sobjects/...`
* `GET /v1/query/...`
* `GET /v1/search`（※ここは “Search Serviceの結果” を使うか、PG検索に落とすかは実装選択）
* `POST /v1/leads/{id}/convert`
* `POST /v1/opportunities/{id}/changeStage`
* `POST /v1/opportunities/{id}/close`
* `POST /v1/quotes/{id}/actions/...`
* `POST /v1/orders/{id}/actions/...`

### 3.5 Core DB（正本）

* PostgreSQL（業務テーブル、監査、Outbox含む）
* `object_shares` は **Core DBに置かない**（Sharing DBへ）

### 3.6 依存

* Metadata Service：設定の参照（キャッシュ推奨）
* Approval Service：承認状態の参照（ロック適用のため）
* Sharing Service：RecordAccess評価（問い合わせ or shares DB参照）
* Search/Reporting：結果利用は任意（ただし最終チェックはCore）

---

## S2. Metadata & Admin Service（設定の正本）

### 3.7 主要責務

* Object/Field/Layout（Object Manager）
* Permissions（Profile/PermissionSet/Role/Group）
* Automation定義（Validation/Workflow/Approval/Scheduledの定義部分）
* 共有設定（OWD/ShareRule/TeamRole/Territory定義）
* 設定変更イベント発行：`MetadataChanged`, `PermissionChanged`, `SharingConfigChanged`, `AutomationConfigChanged`

### 3.8 API（管理者向け）

* `GET/POST/PATCH /v1/metadata/...`
* `GET/POST/PATCH /v1/permissions/...`
* `GET/POST/PATCH /v1/sharing/config/...`
* `GET/POST/PATCH /v1/automation/definitions/...`

### 3.9 DB

* PostgreSQL（メタデータ専用）
* 変更監査（誰がいつ変更したか）を必ず記録

### 3.10 依存

* Core：不要（Coreは参照者）
* Event Bus：変更イベントを発行

---

## S3. Sharing Service（共有の生成・再計算の正本）

### 3.11 主要責務

* `object_shares`（共有行）の生成・削除・再計算
* 増分更新（Owner変更/ルール一致/グループ変更等）
* フルリビルド（OWD/ロール大改編等）
* ShareModelVersion（バージョン切替）

### 3.12 API（内部・管理者）

* `POST /v1/sharing/recalculate`（record/full）
* `GET /v1/sharing/accessCheck?object=...&recordId=...&userId=...`（内部用）
* `GET /v1/sharing/version`（現在バージョン）

### 3.13 DB（Shares DB）

* PostgreSQL（パーティション推奨）
* テーブル：`object_shares`, `share_model_versions`, `share_rebuild_jobs`

### 3.14 入力イベント（購読）

* `RecordCreated/Updated/Deleted`（Owner変更、親子関係変化、条件一致変化）
* `PermissionChanged`（場合により）
* `SharingConfigChanged`（OWD/ShareRule/RoleHierarchy/Territory）
* `TeamMemberChanged`, `TerritoryAssignmentChanged`, `GroupMemberChanged`, `RoleHierarchyChanged`

### 3.15 出力イベント

* `SharingUpdated`（record単位）
* `SharingRebuildCompleted`（version切替）

### 3.16 依存

* Metadata Service：共有ルール・OWD・TeamRole・Territory定義
* Core：レコード変更イベントの供給元

---

## S4. Automation Service（非同期自動化・通知・スケジュール）

### 3.17 主要責務

* Async Workflow（通知、Webhook、タスク生成の“非同期版”）
* Scheduled Jobs（期限切れ、定期更新）
* 失敗時のリトライ、デッドレター
* 実行ログ集約（AutomationRunLog）

### 3.18 API（内部・管理者）

* `GET /v1/automation/jobs`
* `POST /v1/automation/jobs/{id}/retry`
* `GET /v1/automation/runLogs?...`

### 3.19 DB

* job queue（Redis/DB/Message broker）
* logs DB（PostgreSQL：月次パーティション推奨）

### 3.20 入力イベント

* `RecordCreated/Updated`（条件により通知やWebhook）
* `ApprovalDecided`（通知）
* `SharingRebuildCompleted`（必要なら後続処理）
* `AutomationConfigChanged`

### 3.21 依存

* Metadata Service：Workflow定義、スケジュール定義
* Core：最終的なデータ取得は必要に応じてCore APIで（権限考慮）

---

## S5. Approval Service（承認の正本）

### 3.22 主要責務

* ApprovalInstance / WorkItem / History
* Approver解決（Role/Group/ManagerOfOwner）
* 承認中ロック情報の保持（LockedFields/LockState）
* 承認決定イベント発行

### 3.23 API（外部/内部）

* `POST /v1/approvals/submit`
* `POST /v1/approvals/workItems/{id}/decide`
* `POST /v1/approvals/{id}/recall`
* `GET  /v1/approvals/instances/{id}`
* `GET  /v1/approvals/workItems?assignee=me`

### 3.24 DB

* approvals DB（PostgreSQL）

### 3.25 入力イベント

* `RecordUpdated`（承認対象フィールド変化で申請可否変化）
* `PermissionChanged`（Approver解決に影響）
* `ApprovalConfigChanged`

### 3.26 出力イベント

* `ApprovalSubmitted`
* `ApprovalDecided`
* `ApprovalRecalled`

### 3.27 依存

* Core：対象レコードの状態参照、（必要なら）承認フラグ更新要求はCoreへ
* Metadata：承認定義
* Permissions：Approver解決にRole/Group情報が必要

---

## S6. Search Service（検索の派生データ）

### 3.28 主要責務

* インデックス構築（イベント購読）
* 検索クエリの高速実行
* 返すのは原則 **RecordId集合 + スコア + オブジェクト種別**
* 権限は“完全適用”が難しいため、最終判定はCore

### 3.29 API（外部）

* `GET /v1/search?q=...&objects=...` → IDs
* もしくは Gateway経由で Coreの `/v1/search` がSearchを裏で叩く

### 3.30 データ

* OpenSearch/Elasticsearch or PostgreSQL全文検索

### 3.31 入力イベント

* `RecordCreated/Updated/Deleted`
* `SharingUpdated`（任意：検索結果の候補絞り込みに使う場合）
* `MetadataChanged`（検索対象フィールド変更）

---

## S7. Reporting Service（集計・レポート）

### 3.32 主要責務

* レポート定義（フォルダ権限）
* 実行（同期/非同期）
* 結果キャッシュ（スナップショット）
* “明細行”が必要な場合は **Coreで再評価した明細取得** を利用する

### 3.33 API（外部）

* `POST /v1/reports`
* `POST /v1/reports/{id}/run`
* `GET  /v1/reports/{id}/results/{runId}`

### 3.34 データ

* reports DB（定義＋結果）
* 将来DWHへ逃がせる設計

### 3.35 入力イベント

* `RecordCreated/Updated/Deleted`（必要なら増分集計）
* `MetadataChanged`（定義の妥当性チェック）

---

# 4. “サービス間の依存”をルール化（破綻防止）

## 4.1 依存の基本ルール

* Core は **他サービスのDBを直接書かない**
* Core が他サービスに同期依存して良いのは “参照（Read）” のみ
* 非同期サービスは “Coreへ書き込み” を要求する場合、必ず **Core API** を通す（Single Writer）

## 4.2 同期呼び出しの許可（最小限）

* Core → Metadata：設定参照（キャッシュ前提）
* Core → Approval：承認状態参照（ロック判定）
* Core → Sharing：アクセス評価（高速化のため共有DB直参照でも可）

それ以外は原則イベント駆動。

---

# 5. データ境界（どのDBが正本か）

| 領域      | 正本                 | 備考             |
| ------- | ------------------ | -------------- |
| 業務レコード  | Core DB            | すべてのCRUD       |
| 共有行     | Shares DB          | 再生成可能だが正本扱い    |
| メタデータ   | Metadata DB        | 設定変更イベント発行     |
| 承認      | Approval DB        | Coreは参照して制約を適用 |
| 検索      | Search Index       | キャッシュ（再構築可能）   |
| レポート結果  | Reports DB         | キャッシュ（再計算可能）   |
| 自動化実行ログ | Automation logs DB | 監査用途           |

---

# 6. 権限・共有の適用点（どこで何を判定するか）

## 6.1 Object/Field Permission

* Coreが **必ず** 適用（レスポンスマスク・filter/sort制限含む）

## 6.2 Record Sharing（RecordAccess）

* Coreの最終判定は必須
* 高速化は以下のどちらか：

  * (A) CoreがShares DBを読む（内部専用）
  * (B) CoreがSharing Serviceに `accessCheck` を問い合わせ（キャッシュ必須）

**ベスト案**：A（DB直参照）
理由：Get/ListのホットパスをHTTPにしない方が安定。Sharingは“生成”が重く、“参照”は軽くしたい。

---

# 7. 受入条件（この境界で成功と見なす条件）

1. Core単体で CRUD + Validation + Audit が成立し、イベントが確実に出る（Outbox）
2. Sharing/Search/Automation/Approval/Reporting がイベント購読で追随できる
3. Search/Report経由でも最終的に「見えるものしか返らない」（Core再評価）
4. サービス間の書き込み競合が起きない（Single Writerの遵守）
5. 共有再計算（バージョン切替）で一覧/検索/レポートの整合が崩れない
